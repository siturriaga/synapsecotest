import{r,a as re,b as ne,j as e}from"./index-DOmTO72t.js";import{s as H}from"./safeFetch-xZ1Wia4B.js";import"./firebase-HdBvgX-e.js";function ae(i){if(i==null)return"N/A";if(i<1024)return`${i} B`;const l=i/1024;if(l<1024)return`${l.toFixed(l<10?1:0)} KB`;const h=l/1024;return`${h.toFixed(h<10?1:0)} MB`}function ie(i,l){const h=atob(i),x=new Array(h.length);for(let p=0;p<h.length;p+=1)x[p]=h.charCodeAt(p);const A=new Uint8Array(x);return new Blob([A],{type:l})}function ce({user:i}){const[l,h]=r.useState(null),[x,A]=r.useState(""),[p,G]=r.useState(""),[y,J]=r.useState(""),[I,c]=r.useState(""),[P,a]=r.useState(null),[w,T]=r.useState(!1),[m,$]=r.useState("update"),[j,f]=r.useState([]),[C,L]=r.useState(""),[F,q]=r.useState(!1),U=r.useRef(null),{loading:K,records:Q,summaries:D,students:u,insights:d,groupInsights:z,pedagogy:b,uploads:N,syncStatus:g,syncError:B,lastSyncedAt:R,triggerSync:v}=re(),V=r.useMemo(()=>{if(g==="saving")return"Saving workspace snapshot…";if(g==="error")return B??"Auto-save error";if(R){const t=Math.floor((Date.now()-R.getTime())/1e3);if(t<60)return`Snapshot saved ${t}s ago`;const s=Math.floor(t/60);return s<60?`Snapshot saved ${s}m ago`:`Snapshot saved ${Math.floor(s/60)}h ago`}return"Waiting for first snapshot…"},[g,B,R]);r.useEffect(()=>{f(t=>t.filter(s=>u.some(n=>n.id===s)))},[u]);const Y=r.useCallback(t=>{try{const s=t.storage.kind==="inline"?t.storage.data:t.inlineData;if(!s){c(`Download unavailable for ${t.filename}`);return}const n=ie(s,"text/csv"),k=URL.createObjectURL(n),o=document.createElement("a");o.href=k,o.download=t.filename||`roster-${t.id}.csv`,document.body.appendChild(o),o.click(),o.remove(),URL.revokeObjectURL(k),c(`Downloaded ${t.filename}`)}catch(s){console.error(s),a("Unable to download the roster file right now.")}},[]),E=r.useCallback(async()=>{if(!i||!l)return a("Select a file and ensure you are signed in."),null;try{T(!0),a(null),c("Publishing roster to your secure workspace…");const t=await ne.currentUser?.getIdToken(),s=new FormData;s.append("file",l);const n=await fetch(`/.netlify/functions/uploadRoster?period=${encodeURIComponent(x)}&quarter=${encodeURIComponent(p)}&testName=${encodeURIComponent(y)}`,{method:"POST",headers:t?{Authorization:`Bearer ${t}`}:void 0,body:s});if(!n.ok)throw new Error(await n.text());const{uploadId:k}=await n.json(),o=await H("/.netlify/functions/processRoster",{method:"POST",body:JSON.stringify({uploadId:k,mode:"commit",manualOverrides:{},intent:m})}),M=o.assessmentSummary.average!==null?` Class average ${o.assessmentSummary.average.toFixed(1)}.`:"";c("Roster committed — refreshing workspace snapshot…");let W=!0;try{W=await v()}catch(se){console.error("Unable to force roster snapshot sync",se),W=!1}return W?(c(`Auto-sync complete: ${o.written} learners updated. Skipped ${o.skipped}.${M}`),h(null),U.current&&(U.current.value="")):(c(`Roster committed, but the workspace snapshot did not refresh automatically. Use “Sync now” to retry.${M}`),a("Roster saved, but the workspace snapshot did not refresh. Use “Sync now” to retry.")),o}catch(t){return console.error(t),a(t?.message??"Upload failed."),null}finally{T(!1)}},[i,l,x,p,y,v,m]),X=r.useCallback(()=>{if(!(!l||w)){if(m==="new"&&!y.trim()){a("Add a unique test name before publishing new data so we can track multiple assessments.");return}E()}},[l,w,m,y,E]),S=j.length,O=u.length>0&&S===u.length,Z=r.useCallback(t=>{f(s=>s.includes(t)?s.filter(n=>n!==t):[...s,t])},[]),_=r.useCallback(()=>{f(u.map(t=>t.id))},[u]),ee=r.useCallback(()=>{f([])},[]),te=r.useCallback(async()=>{if(!i){a("Sign in to update class periods.");return}const t=j.length;if(!t){a("Select at least one learner before applying a period number.");return}const s=Number(C);if(!Number.isInteger(s)||s<1||s>8){a("Choose a period number between 1 and 8 to apply to the selected learners.");return}try{q(!0),a(null),await H("/.netlify/functions/bulkUpdatePeriods",{method:"POST",body:JSON.stringify({studentIds:j,period:s})}),c(`Assigned period ${s} to ${t} learners. Rebuilding snapshots…`),L(""),f([]);try{await v()?c(`Class periods updated for ${t} learners.`):(c("Class periods updated. Use “Sync now” to refresh the workspace snapshot."),a("Periods saved, but the workspace snapshot did not refresh automatically. Use “Sync now” to retry."))}catch(n){console.error("Unable to refresh snapshot after bulk period update",n),a("Class periods saved. Use “Sync now” if the dashboard does not refresh immediately.")}}catch(n){console.error("Bulk period assignment failed",n),a(n?.message??"Unable to update periods right now.")}finally{q(!1)}},[i,j,C,v]);return i?e.jsxs("div",{className:"fade-in",style:{display:"grid",gap:24},children:[e.jsxs("section",{className:"glass-card",children:[e.jsx("h2",{style:{margin:"4px 0 6px",fontSize:28,fontWeight:800},children:"Upload mastery results and sync to your dashboard"}),e.jsx("p",{style:{color:"var(--text-muted)",marginBottom:20},children:"Drop in your export, add optional context, and we will publish it directly to your dashboard and teaching tools—no preview step required."}),e.jsxs("form",{onSubmit:t=>{t.preventDefault(),X()},children:[e.jsxs("div",{className:"field",children:[e.jsx("label",{htmlFor:"roster-file",children:"Choose roster file"}),e.jsx("input",{ref:U,id:"roster-file",name:"roster-file",type:"file",accept:".csv,.xlsx,.xls,.pdf,.docx",onChange:t=>{const s=t.target.files?.[0]??null;h(s),c(""),a(null)},required:!0})]}),e.jsxs("div",{className:"field",children:[e.jsxs("label",{htmlFor:"roster-test",children:["Name of the test or benchmark ",e.jsx("span",{style:{color:"var(--text-muted)",fontWeight:500},children:"(recommended)"})]}),e.jsx("input",{id:"roster-test",name:"roster-test",value:y,onChange:t=>J(t.target.value),placeholder:"e.g., Q2 Expressions Mastery Check","aria-describedby":"roster-test-help"}),e.jsx("p",{id:"roster-test-help",style:{color:"var(--text-muted)",fontSize:12,marginTop:6},children:"Give each new upload a unique name so the AI can compare assessments over time and keep prior data intact."})]}),e.jsxs("div",{className:"field",children:[e.jsx("span",{style:{fontWeight:600},children:"Is this a new dataset?"}),e.jsxs("div",{style:{display:"grid",gap:8,marginTop:8,background:"rgba(15,23,42,0.35)",borderRadius:12,padding:"12px 14px",border:"1px solid rgba(148,163,184,0.2)"},children:[e.jsxs("label",{htmlFor:"roster-intent-update",style:{display:"flex",gap:8,alignItems:"center"},children:[e.jsx("input",{type:"radio",id:"roster-intent-update",name:"roster-intent",value:"update",checked:m==="update",onChange:()=>$("update")}),e.jsx("span",{children:"Update an existing assessment"})]}),e.jsxs("label",{htmlFor:"roster-intent-new",style:{display:"flex",gap:8,alignItems:"center"},children:[e.jsx("input",{type:"radio",id:"roster-intent-new",name:"roster-intent",value:"new",checked:m==="new",onChange:()=>$("new")}),e.jsx("span",{children:"Create a new assessment (requires a unique test name)"})]})]})]}),e.jsxs("div",{style:{display:"grid",gap:14,gridTemplateColumns:"repeat(auto-fit, minmax(160px, 1fr))"},children:[e.jsxs("div",{className:"field",children:[e.jsxs("label",{htmlFor:"roster-period",children:["Default class period",e.jsx("span",{style:{color:"var(--text-muted)",fontWeight:500},children:" (optional)"})]}),e.jsx("input",{id:"roster-period",name:"roster-period",type:"number",min:1,max:8,value:x,onChange:t=>A(t.target.value),placeholder:"Leave blank if your file includes a Period column"}),e.jsx("p",{style:{color:"var(--text-muted)",fontSize:12,marginTop:6},children:"We read any “Period” column in your upload automatically. Use this field only when you want to tag the entire file with the same period."})]}),e.jsxs("div",{className:"field",children:[e.jsx("label",{htmlFor:"roster-quarter",children:"Quarter"}),e.jsxs("select",{id:"roster-quarter",name:"roster-quarter",value:p,onChange:t=>G(t.target.value),children:[e.jsx("option",{value:"",children:"N/A"}),e.jsx("option",{value:"Q1",children:"Q1"}),e.jsx("option",{value:"Q2",children:"Q2"}),e.jsx("option",{value:"Q3",children:"Q3"}),e.jsx("option",{value:"Q4",children:"Q4"})]})]})]}),e.jsx("div",{style:{display:"flex",gap:12,marginTop:18},children:e.jsx("button",{type:"submit",className:"primary",disabled:!l||w,children:w?"Publishing…":"Publish to dashboard"})})]}),I&&e.jsx("p",{style:{marginTop:14,color:"var(--text-muted)"},children:I}),P&&e.jsx("p",{style:{marginTop:14,color:"#fecaca"},children:P}),e.jsxs("div",{style:{marginTop:20,padding:"12px 16px",borderRadius:12,background:"rgba(15,23,42,0.45)",border:"1px solid rgba(148,163,184,0.25)",display:"flex",gap:12,alignItems:"center",flexWrap:"wrap"},children:[e.jsx("strong",{style:{fontSize:14,letterSpacing:.4},children:"Workspace auto-save"}),e.jsx("span",{style:{color:g==="error"?"#fecaca":"var(--text-muted)",fontSize:14},children:V}),e.jsx("button",{type:"button",className:"secondary",style:{marginLeft:"auto",padding:"6px 14px"},onClick:()=>{v()},disabled:g==="saving",children:g==="saving"?"Saving…":"Sync now"})]})]}),e.jsxs("section",{className:"glass-card",style:{display:"grid",gap:18},children:[e.jsxs("header",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",gap:18},children:[e.jsx("div",{children:e.jsx("h3",{style:{margin:"4px 0 0",fontSize:22,fontWeight:700},children:"Organize learners by period"})}),e.jsx("span",{style:{color:"var(--text-muted)",fontSize:13},children:"Selections apply instantly and guide future uploads."})]}),e.jsx("p",{style:{color:"var(--text-muted)",margin:0},children:"Tag multiple students with the correct class period. The AI remembers these assignments and auto-fills periods for matching names the next time you upload mastery results."}),e.jsxs("div",{style:{display:"grid",gap:16,gridTemplateColumns:"repeat(auto-fit, minmax(220px, 1fr))",alignItems:"end"},children:[e.jsxs("div",{className:"field",children:[e.jsx("label",{htmlFor:"bulk-period",children:"Apply period number"}),e.jsx("input",{id:"bulk-period",name:"bulk-period",type:"number",min:1,max:8,value:C,onChange:t=>L(t.target.value),placeholder:"1-8"})]}),e.jsxs("div",{style:{display:"flex",gap:12,flexWrap:"wrap"},children:[e.jsx("button",{type:"button",className:"primary",onClick:()=>{te()},disabled:F||!S,style:{minWidth:180},children:F?"Applying…":"Apply to all selected"}),e.jsx("button",{type:"button",className:"secondary",onClick:O?ee:_,style:{minWidth:140},children:O?"Clear selection":"Select all"})]})]}),S>0&&e.jsxs("p",{style:{color:"var(--text-muted)",fontSize:13,margin:0},children:[S," ",S===1?"learner":"learners"," ready for an update."]}),u.length===0?e.jsx("div",{style:{color:"var(--text-muted)"},children:"Upload a roster to start assigning class periods. Your selections will appear here for quick editing."}):e.jsxs("table",{className:"table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{style:{width:52},children:"Select"}),e.jsx("th",{children:"Learner"}),e.jsx("th",{children:"Period"}),e.jsx("th",{children:"Last score"}),e.jsx("th",{children:"Latest assessment"}),e.jsx("th",{children:"Updated"})]})}),e.jsx("tbody",{children:u.map(t=>{const s=j.includes(t.id);return e.jsxs("tr",{children:[e.jsx("td",{children:e.jsx("input",{type:"checkbox",id:`bulk-period-${t.id}`,name:"bulk-period-selection",checked:s,onChange:()=>Z(t.id)})}),e.jsx("td",{children:e.jsx("label",{htmlFor:`bulk-period-${t.id}`,style:{cursor:"pointer"},children:t.displayName})}),e.jsx("td",{children:t.period??"N/A"}),e.jsx("td",{children:t.lastScore!==null&&t.lastScore!==void 0?t.lastScore:"N/A"}),e.jsx("td",{children:t.lastAssessment??"N/A"}),e.jsx("td",{children:t.updatedAt?t.updatedAt.toLocaleString():"N/A"})]},t.id)})})]})]}),e.jsxs("section",{className:"glass-card",style:{display:"grid",gap:18},children:[e.jsxs("header",{style:{display:"flex",justifyContent:"space-between",alignItems:"center"},children:[e.jsx("div",{children:e.jsx("h3",{style:{margin:"4px 0 0",fontSize:22,fontWeight:700},children:"Saved assessment summaries"})}),e.jsx("button",{type:"button",className:"secondary",onClick:()=>window.print(),style:{padding:"8px 16px"},children:"Print"})]}),d&&e.jsxs("div",{className:"glass-subcard",style:{display:"flex",flexWrap:"wrap",gap:18,padding:16,borderRadius:16,border:"1px solid rgba(99,102,241,0.25)",background:"rgba(15,23,42,0.45)"},children:[e.jsxs("div",{style:{minWidth:180},children:[e.jsx("strong",{children:"Total learners"}),e.jsx("div",{style:{fontSize:24,fontWeight:700},children:d.totalStudents||"N/A"})]}),e.jsxs("div",{style:{minWidth:180},children:[e.jsx("strong",{children:"Class average"}),e.jsx("div",{style:{fontSize:24,fontWeight:700},children:d.averageScore!==null?d.averageScore.toFixed(1):"N/A"})]}),d.highest&&e.jsxs("div",{style:{minWidth:220},children:[e.jsx("strong",{children:"Top performer"}),e.jsxs("div",{style:{fontSize:15,marginTop:6},children:[d.highest.name," · ",d.highest.score??"N/A",e.jsx("div",{style:{color:"var(--text-muted)",fontSize:13},children:d.highest.testName??"N/A"})]})]}),d.lowest&&e.jsxs("div",{style:{minWidth:220},children:[e.jsx("strong",{children:"Needs support"}),e.jsxs("div",{style:{fontSize:15,marginTop:6},children:[d.lowest.name," · ",d.lowest.score??"N/A",e.jsx("div",{style:{color:"var(--text-muted)",fontSize:13},children:d.lowest.testName??"N/A"})]})]})]}),(z.length>0||b)&&e.jsxs("div",{className:"glass-subcard",style:{display:"grid",gap:18,padding:18,borderRadius:16,border:"1px solid rgba(148,163,184,0.25)",background:"rgba(15,23,42,0.45)"},children:[b&&e.jsxs("div",{children:[e.jsx("strong",{style:{display:"block",marginBottom:8},children:"Pedagogical commitments"}),e.jsx("p",{style:{margin:"0 0 10px",color:"var(--text-muted)"},children:b.summary}),e.jsx("ul",{style:{margin:0,paddingLeft:18,color:"var(--text-muted)",fontSize:14,display:"grid",gap:6},children:b.bestPractices.map((t,s)=>e.jsx("li",{children:t},s))}),e.jsxs("details",{style:{marginTop:12},children:[e.jsx("summary",{style:{cursor:"pointer",color:"#cbd5f5"},children:"Reflection prompts"}),e.jsx("ul",{style:{margin:"10px 0 0 18px",color:"var(--text-muted)",fontSize:14,display:"grid",gap:6},children:b.reflectionPrompts.map((t,s)=>e.jsx("li",{children:t},s))})]})]}),z.length>0&&e.jsxs("div",{style:{display:"grid",gap:14},children:[e.jsx("strong",{children:"Suggested learning groups"}),e.jsx("div",{style:{display:"grid",gap:12},children:z.map(t=>e.jsxs("div",{style:{border:"1px solid rgba(99,102,241,0.25)",borderRadius:14,padding:14,background:"rgba(15,23,42,0.55)",display:"grid",gap:8},children:[e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"baseline",gap:12},children:[e.jsx("span",{style:{fontWeight:600},children:t.label}),e.jsxs("span",{style:{color:"var(--text-muted)",fontSize:13},children:[t.range," • ",t.studentCount," ",t.studentCount===1?"learner":"learners"]})]}),t.students.length>0&&e.jsxs("p",{style:{margin:0,color:"var(--text-muted)",fontSize:14},children:["Learners: ",t.students.map(s=>s.name).join(", ")]}),e.jsx("ul",{style:{margin:0,paddingLeft:18,display:"grid",gap:4,color:"var(--text-muted)",fontSize:14},children:t.recommendedPractices.map((s,n)=>e.jsx("li",{children:s},n))})]},t.id))})]})]}),K?e.jsx("div",{style:{color:"var(--text-muted)"},children:"Loading saved summaries…"}):D.length===0?e.jsx("div",{style:{color:"var(--text-muted)"},children:"Upload mastery files to generate class-level averages and ranges. Summaries feed the dashboard and AI planning tools."}):e.jsxs("table",{className:"table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Assessment"}),e.jsx("th",{children:"Period"}),e.jsx("th",{children:"Quarter"}),e.jsx("th",{children:"Average"}),e.jsx("th",{children:"High"}),e.jsx("th",{children:"Low"}),e.jsx("th",{children:"Learners"}),e.jsx("th",{children:"Updated"})]})}),e.jsx("tbody",{children:D.map(t=>e.jsxs("tr",{children:[e.jsx("td",{children:t.testName}),e.jsx("td",{children:t.period??"N/A"}),e.jsx("td",{children:t.quarter??"N/A"}),e.jsx("td",{children:t.averageScore!==null?t.averageScore.toFixed(1):"N/A"}),e.jsx("td",{children:t.maxScore??"N/A"}),e.jsx("td",{children:t.minScore??"N/A"}),e.jsx("td",{children:t.studentCount??"N/A"}),e.jsx("td",{children:t.updatedAt?t.updatedAt.toLocaleString():"N/A"})]},t.id))})]})]}),e.jsxs("section",{className:"glass-card",style:{display:"grid",gap:18},children:[e.jsxs("header",{style:{display:"flex",justifyContent:"space-between",alignItems:"center"},children:[e.jsx("div",{children:e.jsx("h3",{style:{margin:"4px 0 0",fontSize:22,fontWeight:700},children:"Roster upload library"})}),e.jsx("span",{style:{color:"var(--text-muted)",fontSize:13},children:N.length?`${N.length} recent files`:"Waiting on your first upload"})]}),N.length===0?e.jsx("div",{style:{color:"var(--text-muted)"},children:"Every roster you publish is stored securely. Download a prior CSV, reuse it for corrections, or confirm what was shared with Gemini planning."}):e.jsxs("table",{className:"table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"File"}),e.jsx("th",{children:"Assessment"}),e.jsx("th",{children:"Period"}),e.jsx("th",{children:"Quarter"}),e.jsx("th",{children:"Uploaded"}),e.jsx("th",{children:"Size"}),e.jsx("th",{children:"Actions"})]})}),e.jsx("tbody",{children:N.map(t=>e.jsxs("tr",{children:[e.jsx("td",{children:e.jsxs("div",{style:{display:"flex",flexDirection:"column"},children:[e.jsx("span",{style:{fontWeight:600},children:t.filename}),t.storageWarning&&e.jsx("span",{style:{color:"#fbbf24",fontSize:12},children:t.storageWarning})]})}),e.jsx("td",{children:t.testName??"N/A"}),e.jsx("td",{children:t.period??"N/A"}),e.jsx("td",{children:t.quarter??"N/A"}),e.jsx("td",{children:t.createdAt?t.createdAt.toLocaleString():"N/A"}),e.jsx("td",{children:ae(t.size)}),e.jsx("td",{children:e.jsx("button",{type:"button",className:"secondary",onClick:()=>Y(t),style:{padding:"6px 14px",fontSize:13},children:"Download"})})]},t.id))})]})]}),e.jsxs("section",{className:"glass-card",style:{display:"grid",gap:18},children:[e.jsxs("header",{style:{display:"flex",justifyContent:"space-between",alignItems:"center"},children:[e.jsx("div",{children:e.jsx("h3",{style:{margin:"4px 0 0",fontSize:22,fontWeight:700},children:"Latest mastery uploads"})}),e.jsx("button",{type:"button",className:"secondary",onClick:()=>window.print(),style:{padding:"8px 16px"},children:"Print"})]}),Q.length===0?e.jsx("div",{style:{color:"var(--text-muted)"},children:"Once you commit a roster, the secure roster library shows each learner’s score, period, and test name here for quick reference and AI planning."}):e.jsxs("table",{className:"table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Student"}),e.jsx("th",{children:"Score"}),e.jsx("th",{children:"Assessment"}),e.jsx("th",{children:"Period"}),e.jsx("th",{children:"Quarter"}),e.jsx("th",{children:"Source row"}),e.jsx("th",{children:"Uploaded"})]})}),e.jsx("tbody",{children:Q.map(t=>e.jsxs("tr",{children:[e.jsx("td",{children:t.displayName}),e.jsx("td",{children:t.score!==null?t.score:"N/A"}),e.jsx("td",{children:t.testName??"N/A"}),e.jsx("td",{children:t.period??"N/A"}),e.jsx("td",{children:t.quarter??"N/A"}),e.jsx("td",{children:t.sheetRow??"N/A"}),e.jsx("td",{children:t.createdAt?t.createdAt.toLocaleString():"N/A"})]},t.id))})]})]})]}):e.jsxs("div",{className:"glass-card fade-in",children:[e.jsx("h2",{style:{margin:0,fontSize:26,fontWeight:800},children:"Authenticate to upload rosters"}),e.jsx("p",{style:{color:"var(--text-muted)"},children:"This workflow stores students in Firestore under your secure workspace scope. Please sign in to continue."})]})}export{ce as default};
