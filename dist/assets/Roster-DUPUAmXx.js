import{r as t,j as e,a as P}from"./index-keyQ7pV2.js";import{s as F}from"./safeFetch-JhFQGcvq.js";import"./firebase-DnjqOjBc.js";function R({user:u}){const[n,b]=t.useState(null),[p,N]=t.useState("1"),[h,C]=t.useState("Q1"),[a,x]=t.useState(null),[m,f]=t.useState(null),[j,l]=t.useState(""),[g,o]=t.useState(null),[d,v]=t.useState(!1);async function y(s){if(!u||!n){o("Select a file and ensure you are signed in.");return}try{v(!0),o(null),l(s==="preview"?"Uploading for preview…":"Applying roster to Firestore…");let r=m;if(!r||s==="preview"){const i=await P.currentUser?.getIdToken(),S=new FormData;S.append("file",n);const c=await fetch(`/.netlify/functions/uploadRoster?period=${encodeURIComponent(p)}&quarter=${encodeURIComponent(h)}`,{method:"POST",headers:i?{Authorization:`Bearer ${i}`}:void 0,body:S});if(!c.ok)throw new Error(await c.text());r=(await c.json()).uploadId,f(r)}const w=await F("/.netlify/functions/processRoster",{method:"POST",body:JSON.stringify({uploadId:r,mode:s})});if(s==="preview")x(w),l("Preview ready — resolve any issues before committing.");else{const i=w;l(`Synced ${i.written} students. Skipped ${i.skipped}.`),x(null),f(null)}}catch(r){console.error(r),o(r?.message??"Upload failed.")}finally{v(!1)}}return u?e.jsxs("div",{className:"fade-in",style:{display:"grid",gap:24},children:[e.jsxs("section",{className:"glass-card",children:[e.jsx("div",{className:"badge",children:"Roster ingestion"}),e.jsx("h2",{style:{margin:"12px 0 6px",fontSize:28,fontWeight:800},children:"Upload CSV, XLSX, PDF, or DOCX rosters"}),e.jsx("p",{style:{color:"var(--text-muted)",marginBottom:20},children:"Synapse validates email, period, and quarter fields before persisting to Firestore. Preview first to resolve flagged rows."}),e.jsxs("form",{onSubmit:s=>{s.preventDefault(),y("preview")},children:[e.jsxs("div",{className:"field",children:[e.jsx("label",{htmlFor:"roster-file",children:"Choose roster file"}),e.jsx("input",{id:"roster-file",name:"roster-file",type:"file",accept:".csv,.xlsx,.xls,.pdf,.docx",onChange:s=>b(s.target.files?.[0]??null),required:!0})]}),e.jsxs("div",{style:{display:"grid",gap:14,gridTemplateColumns:"repeat(auto-fit, minmax(160px, 1fr))"},children:[e.jsxs("div",{className:"field",children:[e.jsx("label",{htmlFor:"roster-period",children:"Class period"}),e.jsx("input",{id:"roster-period",name:"roster-period",type:"number",min:1,max:8,value:p,onChange:s=>N(s.target.value),required:!0})]}),e.jsxs("div",{className:"field",children:[e.jsx("label",{htmlFor:"roster-quarter",children:"Quarter"}),e.jsxs("select",{id:"roster-quarter",name:"roster-quarter",value:h,onChange:s=>C(s.target.value),required:!0,children:[e.jsx("option",{value:"Q1",children:"Q1"}),e.jsx("option",{value:"Q2",children:"Q2"}),e.jsx("option",{value:"Q3",children:"Q3"}),e.jsx("option",{value:"Q4",children:"Q4"})]})]})]}),e.jsxs("div",{style:{display:"flex",gap:12,marginTop:18},children:[e.jsx("button",{type:"submit",className:"primary",disabled:!n||d,children:d?"Processing…":"Preview roster"}),e.jsx("button",{type:"button",className:"secondary",onClick:()=>y("commit"),disabled:!m||d,children:"Commit to Firestore"})]})]}),j&&e.jsx("p",{style:{marginTop:14,color:"var(--text-muted)"},children:j}),g&&e.jsx("p",{style:{marginTop:14,color:"#fecaca"},children:g})]}),a&&e.jsxs("section",{className:"glass-card",children:[e.jsx("h3",{style:{margin:0,fontSize:22,fontWeight:700},children:"Preview results"}),e.jsxs("p",{style:{color:"var(--text-muted)"},children:[a.stats.ok," rows ready • ",a.stats.needs_review," need attention."]}),e.jsxs("table",{className:"table",style:{marginTop:16},children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Row"}),e.jsx("th",{children:"Name"}),e.jsx("th",{children:"Email"}),e.jsx("th",{children:"Period"}),e.jsx("th",{children:"Quarter"}),e.jsx("th",{children:"Status"})]})}),e.jsx("tbody",{children:a.rows.map(s=>e.jsxs("tr",{children:[e.jsx("td",{children:s.row}),e.jsx("td",{children:s.data.name||"—"}),e.jsx("td",{children:s.data.email||"—"}),e.jsx("td",{children:s.data.period??"—"}),e.jsx("td",{children:s.data.quarter??"—"}),e.jsx("td",{children:s.status==="ok"?e.jsx("span",{className:"status-success",children:"Validated"}):e.jsxs("span",{className:"status-warning",children:["Check: ",s.issues?.join(", ")]})})]},s.row))})]})]})]}):e.jsxs("div",{className:"glass-card fade-in",children:[e.jsx("h2",{style:{margin:0,fontSize:26,fontWeight:800},children:"Authenticate to upload rosters"}),e.jsx("p",{style:{color:"var(--text-muted)"},children:"This workflow stores students in Firestore under your secure workspace scope. Please sign in to continue."})]})}export{R as default};
