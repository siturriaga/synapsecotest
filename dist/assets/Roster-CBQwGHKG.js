import{r as t,j as e,a as Q}from"./index-DXLrP2vc.js";import{s as q}from"./safeFetch-a-dzkaAs.js";import"./firebase-DnjqOjBc.js";function $({user:m}){const[o,x]=t.useState(null),[j,k]=t.useState("1"),[g,P]=t.useState("Q1"),[l,f]=t.useState(""),[i,y]=t.useState(null),[v,S]=t.useState(null),[b,c]=t.useState(""),[w,u]=t.useState(null),[p,N]=t.useState(!1),r=t.useMemo(()=>i?.assessmentSummary,[i]);async function C(s){if(!m||!o){u("Select a file and ensure you are signed in.");return}try{N(!0),u(null),c(s==="preview"?"Uploading for preview…":"Applying roster to Firestore…");let a=v;if(!a||s==="preview"){const n=await Q.currentUser?.getIdToken(),d=new FormData;d.append("file",o);const h=await fetch(`/.netlify/functions/uploadRoster?period=${encodeURIComponent(j)}&quarter=${encodeURIComponent(g)}&testName=${encodeURIComponent(l)}`,{method:"POST",headers:n?{Authorization:`Bearer ${n}`}:void 0,body:d});if(!h.ok)throw new Error(await h.text());a=(await h.json()).uploadId,S(a)}const F=await q("/.netlify/functions/processRoster",{method:"POST",body:JSON.stringify({uploadId:a,mode:s})});if(s==="preview")y(F),c("Preview ready — resolve any issues before committing.");else{const n=F,d=n.assessmentSummary.average!==null?` Class average ${n.assessmentSummary.average.toFixed(1)}.`:"";c(`Synced ${n.written} learners. Skipped ${n.skipped}.${d}`),y(null),S(null),x(null),f("")}}catch(a){console.error(a),u(a?.message??"Upload failed.")}finally{N(!1)}}return m?e.jsxs("div",{className:"fade-in",style:{display:"grid",gap:24},children:[e.jsxs("section",{className:"glass-card",children:[e.jsx("div",{className:"badge",children:"Roster ingestion"}),e.jsx("h2",{style:{margin:"12px 0 6px",fontSize:28,fontWeight:800},children:"Upload CSV, XLSX, PDF, or DOCX mastery exports"}),e.jsx("p",{style:{color:"var(--text-muted)",marginBottom:20},children:"Synapse validates student names, periods, quarters, test names, and scores before persisting to Firestore. Preview first to resolve flagged rows. No student data leaves your encrypted workspace."}),e.jsxs("form",{onSubmit:s=>{s.preventDefault(),C("preview")},children:[e.jsxs("div",{className:"field",children:[e.jsx("label",{htmlFor:"roster-file",children:"Choose roster file"}),e.jsx("input",{id:"roster-file",name:"roster-file",type:"file",accept:".csv,.xlsx,.xls,.pdf,.docx",onChange:s=>x(s.target.files?.[0]??null),required:!0})]}),e.jsxs("div",{className:"field",children:[e.jsx("label",{htmlFor:"roster-test",children:"Name of the test or benchmark"}),e.jsx("input",{id:"roster-test",name:"roster-test",value:l,onChange:s=>f(s.target.value),placeholder:"e.g., Q2 Expressions Mastery Check",required:!0})]}),e.jsxs("div",{style:{display:"grid",gap:14,gridTemplateColumns:"repeat(auto-fit, minmax(160px, 1fr))"},children:[e.jsxs("div",{className:"field",children:[e.jsx("label",{htmlFor:"roster-period",children:"Class period"}),e.jsx("input",{id:"roster-period",name:"roster-period",type:"number",min:1,max:8,value:j,onChange:s=>k(s.target.value),required:!0})]}),e.jsxs("div",{className:"field",children:[e.jsx("label",{htmlFor:"roster-quarter",children:"Quarter"}),e.jsxs("select",{id:"roster-quarter",name:"roster-quarter",value:g,onChange:s=>P(s.target.value),required:!0,children:[e.jsx("option",{value:"Q1",children:"Q1"}),e.jsx("option",{value:"Q2",children:"Q2"}),e.jsx("option",{value:"Q3",children:"Q3"}),e.jsx("option",{value:"Q4",children:"Q4"})]})]})]}),e.jsxs("div",{style:{display:"flex",gap:12,marginTop:18},children:[e.jsx("button",{type:"submit",className:"primary",disabled:!o||p||!l.trim(),children:p?"Processing…":"Preview mastery data"}),e.jsx("button",{type:"button",className:"secondary",onClick:()=>C("commit"),disabled:!v||p,children:"Commit to Firestore"})]})]}),b&&e.jsx("p",{style:{marginTop:14,color:"var(--text-muted)"},children:b}),w&&e.jsx("p",{style:{marginTop:14,color:"#fecaca"},children:w})]}),i&&e.jsxs("section",{className:"glass-card",style:{display:"grid",gap:18},children:[e.jsxs("div",{style:{display:"flex",flexWrap:"wrap",gap:18,justifyContent:"space-between",alignItems:"flex-end"},children:[e.jsxs("div",{children:[e.jsx("h3",{style:{margin:0,fontSize:22,fontWeight:700},children:"Preview results"}),e.jsxs("p",{style:{color:"var(--text-muted)"},children:[i.stats.ok," learners ready • ",i.stats.needs_review," need attention."]})]}),r&&e.jsxs("div",{className:"glass-subcard",style:{padding:16,borderRadius:16,border:"1px solid rgba(99,102,241,0.25)",background:"rgba(15,23,42,0.55)"},children:[e.jsx("strong",{children:"Assessment snapshot"}),e.jsxs("div",{style:{marginTop:8,display:"grid",gap:4,fontSize:14},children:[e.jsxs("span",{children:["Average: ",r.average!==null?r.average.toFixed(1):"—"]}),e.jsxs("span",{children:["Median: ",r.median!==null?r.median.toFixed(1):"—"]}),e.jsxs("span",{children:["High: ",r.max!==null?r.max.toFixed(1):"—"," · Low: ",r.min!==null?r.min.toFixed(1):"—"]})]})]})]}),e.jsxs("table",{className:"table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Row"}),e.jsx("th",{children:"Student name"}),e.jsx("th",{children:"Alternate names"}),e.jsx("th",{children:"Period"}),e.jsx("th",{children:"Quarter"}),e.jsx("th",{children:"Score"}),e.jsx("th",{children:"Assessment"}),e.jsx("th",{children:"Status"})]})}),e.jsx("tbody",{children:i.rows.map(s=>e.jsxs("tr",{children:[e.jsx("td",{children:s.row}),e.jsx("td",{children:s.data.displayName||"—"}),e.jsx("td",{children:s.data.nameVariants.length>1?s.data.nameVariants.slice(1).join(", "):"—"}),e.jsx("td",{children:s.data.period??"—"}),e.jsx("td",{children:s.data.quarter??"—"}),e.jsx("td",{children:s.data.score!==null?s.data.score:"—"}),e.jsx("td",{children:s.data.testName||l||"—"}),e.jsx("td",{children:s.status==="ok"?e.jsx("span",{className:"status-success",children:"Validated"}):e.jsxs("span",{className:"status-warning",children:["Check: ",s.issues?.join(", ")]})})]},s.row))})]})]})]}):e.jsxs("div",{className:"glass-card fade-in",children:[e.jsx("h2",{style:{margin:0,fontSize:26,fontWeight:800},children:"Authenticate to upload rosters"}),e.jsx("p",{style:{color:"var(--text-muted)"},children:"This workflow stores students in Firestore under your secure workspace scope. Please sign in to continue."})]})}export{$ as default};
