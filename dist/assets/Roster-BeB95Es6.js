import{r as n,u as $,j as e,a as M}from"./index-BdaUekzB.js";import{s as D}from"./safeFetch-CLicF8cn.js";import"./firebase-DMftn6xT.js";function X({user:S}){const[m,b]=n.useState(null),[d,I]=n.useState("1"),[h,Q]=n.useState("Q1"),[o,w]=n.useState(""),[i,N]=n.useState(null),[C,k]=n.useState(null),[A,g]=n.useState(""),[F,j]=n.useState(null),[y,W]=n.useState(!1),{loading:U,records:q,summaries:T,insights:a,syncStatus:c,syncError:P,lastSyncedAt:f,triggerSync:R}=$(),l=n.useMemo(()=>i?.assessmentSummary,[i]),v=n.useMemo(()=>{if(!i)return{testName:o.trim()||null,period:d?Number(d):null,quarter:h||null};const s=i.rows.find(r=>r.data.testName),t=i.rows.find(r=>r.data.period!==null),x=i.rows.find(r=>r.data.quarter);return{testName:(s?.data.testName||o||"").trim()||null,period:t?.data.period??(d?Number(d):null),quarter:x?.data.quarter??(h||null)}},[i,o,d,h]),L=n.useMemo(()=>{if(c==="saving")return"Saving workspace snapshot…";if(c==="error")return P??"Auto-save error";if(f){const s=Math.floor((Date.now()-f.getTime())/1e3);if(s<60)return`Snapshot saved ${s}s ago`;const t=Math.floor(s/60);return t<60?`Snapshot saved ${t}m ago`:`Snapshot saved ${Math.floor(t/60)}h ago`}return"Waiting for first snapshot…"},[c,P,f]);async function z(s){if(!S||!m){j("Select a file and ensure you are signed in.");return}try{W(!0),j(null),g(s==="preview"?"Uploading for preview…":"Applying roster to Firestore…");let t=C;if(!t||s==="preview"){const r=await M.currentUser?.getIdToken(),p=new FormData;p.append("file",m);const u=await fetch(`/.netlify/functions/uploadRoster?period=${encodeURIComponent(d)}&quarter=${encodeURIComponent(h)}&testName=${encodeURIComponent(o)}`,{method:"POST",headers:r?{Authorization:`Bearer ${r}`}:void 0,body:p});if(!u.ok)throw new Error(await u.text());t=(await u.json()).uploadId,k(t)}const x=await D("/.netlify/functions/processRoster",{method:"POST",body:JSON.stringify({uploadId:t,mode:s})});if(s==="preview")N(x),g("Preview ready — resolve any issues before committing.");else{const r=x,p=r.assessmentSummary.average!==null?` Class average ${r.assessmentSummary.average.toFixed(1)}.`:"";g(`Synced ${r.written} learners. Skipped ${r.skipped}.${p}`),N(null),k(null),b(null),w("");try{await R()}catch(u){console.error("Unable to force roster snapshot sync",u)}}}catch(t){console.error(t),j(t?.message??"Upload failed.")}finally{W(!1)}}return S?e.jsxs("div",{className:"fade-in",style:{display:"grid",gap:24},children:[e.jsxs("section",{className:"glass-card",children:[e.jsx("div",{className:"badge",children:"Roster ingestion"}),e.jsx("h2",{style:{margin:"12px 0 6px",fontSize:28,fontWeight:800},children:"Upload CSV, XLSX, PDF, or DOCX mastery exports"}),e.jsx("p",{style:{color:"var(--text-muted)",marginBottom:20},children:"Synapse validates student names, periods, quarters, test names, and scores before persisting to Firestore. Preview first to resolve flagged rows. No student data leaves your encrypted workspace."}),e.jsxs("form",{onSubmit:s=>{s.preventDefault(),z("preview")},children:[e.jsxs("div",{className:"field",children:[e.jsx("label",{htmlFor:"roster-file",children:"Choose roster file"}),e.jsx("input",{id:"roster-file",name:"roster-file",type:"file",accept:".csv,.xlsx,.xls,.pdf,.docx",onChange:s=>b(s.target.files?.[0]??null),required:!0})]}),e.jsxs("div",{className:"field",children:[e.jsxs("label",{htmlFor:"roster-test",children:["Name of the test or benchmark ",e.jsx("span",{style:{color:"var(--text-muted)",fontWeight:500},children:"(optional)"})]}),e.jsx("input",{id:"roster-test",name:"roster-test",value:o,onChange:s=>w(s.target.value),placeholder:"e.g., Q2 Expressions Mastery Check"})]}),e.jsxs("div",{style:{display:"grid",gap:14,gridTemplateColumns:"repeat(auto-fit, minmax(160px, 1fr))"},children:[e.jsxs("div",{className:"field",children:[e.jsx("label",{htmlFor:"roster-period",children:"Class period"}),e.jsx("input",{id:"roster-period",name:"roster-period",type:"number",min:1,max:8,value:d,onChange:s=>I(s.target.value),required:!0})]}),e.jsxs("div",{className:"field",children:[e.jsx("label",{htmlFor:"roster-quarter",children:"Quarter"}),e.jsxs("select",{id:"roster-quarter",name:"roster-quarter",value:h,onChange:s=>Q(s.target.value),required:!0,children:[e.jsx("option",{value:"Q1",children:"Q1"}),e.jsx("option",{value:"Q2",children:"Q2"}),e.jsx("option",{value:"Q3",children:"Q3"}),e.jsx("option",{value:"Q4",children:"Q4"})]})]})]}),e.jsxs("div",{style:{display:"flex",gap:12,marginTop:18},children:[e.jsx("button",{type:"submit",className:"primary",disabled:!m||y,children:y?"Processing…":"Preview mastery data"}),e.jsx("button",{type:"button",className:"secondary",onClick:()=>z("commit"),disabled:!C||y,children:"Commit to Firestore"})]})]}),A&&e.jsx("p",{style:{marginTop:14,color:"var(--text-muted)"},children:A}),F&&e.jsx("p",{style:{marginTop:14,color:"#fecaca"},children:F}),e.jsxs("div",{style:{marginTop:20,padding:"12px 16px",borderRadius:12,background:"rgba(15,23,42,0.45)",border:"1px solid rgba(148,163,184,0.25)",display:"flex",gap:12,alignItems:"center",flexWrap:"wrap"},children:[e.jsx("strong",{style:{fontSize:14,letterSpacing:.4},children:"Workspace auto-save"}),e.jsx("span",{style:{color:c==="error"?"#fecaca":"var(--text-muted)",fontSize:14},children:L}),e.jsx("button",{type:"button",className:"secondary",style:{marginLeft:"auto",padding:"6px 14px"},onClick:()=>{R()},disabled:c==="saving",children:c==="saving"?"Saving…":"Sync now"})]})]}),i&&e.jsxs("section",{className:"glass-card",style:{display:"grid",gap:18},children:[e.jsxs("div",{style:{display:"flex",flexWrap:"wrap",gap:18,justifyContent:"space-between",alignItems:"flex-end"},children:[e.jsxs("div",{children:[e.jsx("h3",{style:{margin:0,fontSize:22,fontWeight:700},children:"Preview results"}),e.jsxs("p",{style:{color:"var(--text-muted)"},children:[i.stats.ok," learners ready • ",i.stats.needs_review," need attention."]})]}),e.jsxs("div",{style:{display:"flex",gap:16,flexWrap:"wrap",alignItems:"stretch"},children:[e.jsxs("div",{className:"glass-subcard",style:{padding:16,borderRadius:16,border:"1px solid rgba(99,102,241,0.25)",background:"rgba(15,23,42,0.55)",minWidth:220},children:[e.jsx("strong",{children:"Test details"}),e.jsxs("div",{style:{marginTop:8,display:"grid",gap:4,fontSize:14},children:[e.jsxs("span",{children:["Assessment: ",v.testName??"—"]}),e.jsxs("span",{children:["Period: ",v.period??"—"," · Quarter: ",v.quarter??"—"]})]})]}),l&&e.jsxs("div",{className:"glass-subcard",style:{padding:16,borderRadius:16,border:"1px solid rgba(99,102,241,0.25)",background:"rgba(15,23,42,0.55)",minWidth:220},children:[e.jsx("strong",{children:"Assessment snapshot"}),e.jsxs("div",{style:{marginTop:8,display:"grid",gap:4,fontSize:14},children:[e.jsxs("span",{children:["Average: ",l.average!==null?l.average.toFixed(1):"—"]}),e.jsxs("span",{children:["Median: ",l.median!==null?l.median.toFixed(1):"—"]}),e.jsxs("span",{children:["High: ",l.max!==null?l.max.toFixed(1):"—"," · Low: ",l.min!==null?l.min.toFixed(1):"—"]})]})]})]})]}),e.jsxs("table",{className:"table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Row"}),e.jsx("th",{children:"Student name"}),e.jsx("th",{children:"Alternate names"}),e.jsx("th",{children:"Period"}),e.jsx("th",{children:"Quarter"}),e.jsx("th",{children:"Score"}),e.jsx("th",{children:"Assessment"}),e.jsx("th",{children:"Status"})]})}),e.jsx("tbody",{children:i.rows.map(s=>e.jsxs("tr",{children:[e.jsx("td",{children:s.row}),e.jsx("td",{children:s.data.displayName||"—"}),e.jsx("td",{children:s.data.nameVariants.length>1?s.data.nameVariants.slice(1).join(", "):"—"}),e.jsx("td",{children:s.data.period??"—"}),e.jsx("td",{children:s.data.quarter??"—"}),e.jsx("td",{children:s.data.score!==null?s.data.score:"—"}),e.jsx("td",{children:s.data.testName||o||"—"}),e.jsx("td",{children:s.status==="ok"?e.jsx("span",{className:"status-success",children:"Validated"}):e.jsxs("span",{className:"status-warning",children:["Check: ",s.issues?.join(", ")]})})]},s.row))})]})]}),e.jsxs("section",{className:"glass-card",style:{display:"grid",gap:18},children:[e.jsxs("header",{style:{display:"flex",justifyContent:"space-between",alignItems:"center"},children:[e.jsxs("div",{children:[e.jsx("div",{className:"badge",children:"Class statistics"}),e.jsx("h3",{style:{margin:"12px 0 0",fontSize:22,fontWeight:700},children:"Saved assessment summaries"})]}),e.jsx("button",{type:"button",className:"secondary",onClick:()=>window.print(),style:{padding:"8px 16px"},children:"Print"})]}),a&&e.jsxs("div",{className:"glass-subcard",style:{display:"flex",flexWrap:"wrap",gap:18,padding:16,borderRadius:16,border:"1px solid rgba(99,102,241,0.25)",background:"rgba(15,23,42,0.45)"},children:[e.jsxs("div",{style:{minWidth:180},children:[e.jsx("strong",{children:"Total learners"}),e.jsx("div",{style:{fontSize:24,fontWeight:700},children:a.totalStudents||"—"})]}),e.jsxs("div",{style:{minWidth:180},children:[e.jsx("strong",{children:"Class average"}),e.jsx("div",{style:{fontSize:24,fontWeight:700},children:a.averageScore!==null?a.averageScore.toFixed(1):"—"})]}),a.highest&&e.jsxs("div",{style:{minWidth:220},children:[e.jsx("strong",{children:"Top performer"}),e.jsxs("div",{style:{fontSize:15,marginTop:6},children:[a.highest.name," · ",a.highest.score??"—",e.jsx("div",{style:{color:"var(--text-muted)",fontSize:13},children:a.highest.testName??"Assessment"})]})]}),a.lowest&&e.jsxs("div",{style:{minWidth:220},children:[e.jsx("strong",{children:"Needs support"}),e.jsxs("div",{style:{fontSize:15,marginTop:6},children:[a.lowest.name," · ",a.lowest.score??"—",e.jsx("div",{style:{color:"var(--text-muted)",fontSize:13},children:a.lowest.testName??"Assessment"})]})]})]}),U?e.jsx("div",{style:{color:"var(--text-muted)"},children:"Loading saved summaries…"}):T.length===0?e.jsx("div",{style:{color:"var(--text-muted)"},children:"Upload mastery files to generate class-level averages and ranges. Summaries feed the dashboard and AI planning tools."}):e.jsxs("table",{className:"table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Assessment"}),e.jsx("th",{children:"Period"}),e.jsx("th",{children:"Quarter"}),e.jsx("th",{children:"Average"}),e.jsx("th",{children:"High"}),e.jsx("th",{children:"Low"}),e.jsx("th",{children:"Learners"}),e.jsx("th",{children:"Updated"})]})}),e.jsx("tbody",{children:T.map(s=>e.jsxs("tr",{children:[e.jsx("td",{children:s.testName}),e.jsx("td",{children:s.period??"—"}),e.jsx("td",{children:s.quarter??"—"}),e.jsx("td",{children:s.averageScore!==null?s.averageScore.toFixed(1):"—"}),e.jsx("td",{children:s.maxScore??"—"}),e.jsx("td",{children:s.minScore??"—"}),e.jsx("td",{children:s.studentCount??"—"}),e.jsx("td",{children:s.updatedAt?s.updatedAt.toLocaleString():"—"})]},s.id))})]})]}),e.jsxs("section",{className:"glass-card",style:{display:"grid",gap:18},children:[e.jsxs("header",{style:{display:"flex",justifyContent:"space-between",alignItems:"center"},children:[e.jsxs("div",{children:[e.jsx("div",{className:"badge",children:"Individual records"}),e.jsx("h3",{style:{margin:"12px 0 0",fontSize:22,fontWeight:700},children:"Latest mastery uploads"})]}),e.jsx("button",{type:"button",className:"secondary",onClick:()=>window.print(),style:{padding:"8px 16px"},children:"Print"})]}),q.length===0?e.jsx("div",{style:{color:"var(--text-muted)"},children:"Once you commit a roster, the secure roster library shows each learner’s score, period, and test name here for quick reference and AI planning."}):e.jsxs("table",{className:"table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Student"}),e.jsx("th",{children:"Score"}),e.jsx("th",{children:"Assessment"}),e.jsx("th",{children:"Period"}),e.jsx("th",{children:"Quarter"}),e.jsx("th",{children:"Source row"}),e.jsx("th",{children:"Uploaded"})]})}),e.jsx("tbody",{children:q.map(s=>e.jsxs("tr",{children:[e.jsx("td",{children:s.displayName}),e.jsx("td",{children:s.score!==null?s.score:"—"}),e.jsx("td",{children:s.testName??"—"}),e.jsx("td",{children:s.period??"—"}),e.jsx("td",{children:s.quarter??"—"}),e.jsx("td",{children:s.sheetRow??"—"}),e.jsx("td",{children:s.createdAt?s.createdAt.toLocaleString():"—"})]},s.id))})]})]})]}):e.jsxs("div",{className:"glass-card fade-in",children:[e.jsx("h2",{style:{margin:0,fontSize:26,fontWeight:800},children:"Authenticate to upload rosters"}),e.jsx("p",{style:{color:"var(--text-muted)"},children:"This workflow stores students in Firestore under your secure workspace scope. Please sign in to continue."})]})}export{X as default};
