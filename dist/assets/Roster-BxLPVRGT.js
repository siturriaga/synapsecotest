import{r as n,a as B,b as M,j as e}from"./index-DpigY7UX.js";import{s as H}from"./safeFetch-DNg14Ixp.js";import"./firebase-ON2ZZD8i.js";function K(a){if(a==null)return"N/A";if(a<1024)return`${a} B`;const r=a/1024;if(r<1024)return`${r.toFixed(r<10?1:0)} KB`;const l=r/1024;return`${l.toFixed(l<10?1:0)} MB`}function G(a,r){const l=atob(a),x=new Array(l.length);for(let d=0;d<l.length;d+=1)x[d]=l.charCodeAt(d);const b=new Uint8Array(x);return new Blob([b],{type:r})}function Y({user:a}){const[r,l]=n.useState(null),[x,b]=n.useState(""),[d,P]=n.useState(""),[g,F]=n.useState(""),[R,o]=n.useState(""),[z,u]=n.useState(null),[f,U]=n.useState(!1),S=n.useRef(),N=n.useRef(null),{loading:Q,records:W,summaries:$,insights:i,groupInsights:w,pedagogy:j,uploads:v,syncStatus:p,syncError:T,lastSyncedAt:A,triggerSync:C}=B(),D=n.useMemo(()=>{if(p==="saving")return"Saving workspace snapshot…";if(p==="error")return T??"Auto-save error";if(A){const t=Math.floor((Date.now()-A.getTime())/1e3);if(t<60)return`Snapshot saved ${t}s ago`;const s=Math.floor(t/60);return s<60?`Snapshot saved ${s}m ago`:`Snapshot saved ${Math.floor(s/60)}h ago`}return"Waiting for first snapshot…"},[p,T,A]);n.useEffect(()=>{S.current=void 0},[r]);const q=n.useCallback(t=>{try{const s=t.storage.kind==="inline"?t.storage.data:t.inlineData;if(!s){o(`Download unavailable for ${t.filename}`);return}const c=G(s,"text/csv"),m=URL.createObjectURL(c),h=document.createElement("a");h.href=m,h.download=t.filename||`roster-${t.id}.csv`,document.body.appendChild(h),h.click(),h.remove(),URL.revokeObjectURL(m),o(`Downloaded ${t.filename}`)}catch(s){console.error(s),u("Unable to download the roster file right now.")}},[]),I=n.useCallback(async t=>{if(!a||!r)return u("Select a file and ensure you are signed in."),null;try{U(!0),u(null),o("Publishing roster to your secure workspace…");const s=await M.currentUser?.getIdToken(),c=new FormData;c.append("file",r);const m=await fetch(`/.netlify/functions/uploadRoster?period=${encodeURIComponent(x)}&quarter=${encodeURIComponent(d)}&testName=${encodeURIComponent(g)}`,{method:"POST",headers:s?{Authorization:`Bearer ${s}`}:void 0,body:c});if(!m.ok)throw new Error(await m.text());const{uploadId:h}=await m.json(),y=await H("/.netlify/functions/processRoster",{method:"POST",body:JSON.stringify({uploadId:h,mode:"commit",manualOverrides:{},intent:t})}),L=y.assessmentSummary.average!==null?` Class average ${y.assessmentSummary.average.toFixed(1)}.`:"";o("Roster committed — refreshing workspace snapshot…");let k=!0;try{k=await C()}catch(O){console.error("Unable to force roster snapshot sync",O),k=!1}return k?(o(`Auto-sync complete: ${y.written} learners updated. Skipped ${y.skipped}.${L}`),l(null),N.current&&(N.current.value="")):(o(`Roster committed, but the workspace snapshot did not refresh automatically. Use “Sync now” to retry.${L}`),u("Roster saved, but the workspace snapshot did not refresh. Use “Sync now” to retry.")),y}catch(s){return console.error(s),u(s?.message??"Upload failed."),null}finally{U(!1)}},[a,r,x,d,g,C]),E=n.useCallback(()=>{if(!r||f)return;let t=S.current;!g.trim()&&!t&&(t=window.confirm(`No assessment name detected. Is this upload updating an existing dataset?
Select OK for Update or Cancel for New.`)?"update":"new",S.current=t),I(t)},[r,f,g,I]);return a?e.jsxs("div",{className:"fade-in",style:{display:"grid",gap:24},children:[e.jsxs("section",{className:"glass-card",children:[e.jsx("div",{className:"badge",children:"Roster ingestion"}),e.jsx("h2",{style:{margin:"12px 0 6px",fontSize:28,fontWeight:800},children:"Upload mastery results and sync to your dashboard"}),e.jsx("p",{style:{color:"var(--text-muted)",marginBottom:20},children:"Drop in your export, add optional context, and we will publish it directly to your dashboard and teaching tools—no preview step required."}),e.jsxs("form",{onSubmit:t=>{t.preventDefault(),E()},children:[e.jsxs("div",{className:"field",children:[e.jsx("label",{htmlFor:"roster-file",children:"Choose roster file"}),e.jsx("input",{ref:N,id:"roster-file",name:"roster-file",type:"file",accept:".csv,.xlsx,.xls,.pdf,.docx",onChange:t=>{const s=t.target.files?.[0]??null;l(s),o(""),u(null)},required:!0})]}),e.jsxs("div",{className:"field",children:[e.jsxs("label",{htmlFor:"roster-test",children:["Name of the test or benchmark ",e.jsx("span",{style:{color:"var(--text-muted)",fontWeight:500},children:"(optional)"})]}),e.jsx("input",{id:"roster-test",name:"roster-test",value:g,onChange:t=>F(t.target.value),placeholder:"e.g., Q2 Expressions Mastery Check"})]}),e.jsxs("div",{style:{display:"grid",gap:14,gridTemplateColumns:"repeat(auto-fit, minmax(160px, 1fr))"},children:[e.jsxs("div",{className:"field",children:[e.jsx("label",{htmlFor:"roster-period",children:"Class period"}),e.jsx("input",{id:"roster-period",name:"roster-period",type:"number",min:1,max:8,value:x,onChange:t=>b(t.target.value),placeholder:"Optional"})]}),e.jsxs("div",{className:"field",children:[e.jsx("label",{htmlFor:"roster-quarter",children:"Quarter"}),e.jsxs("select",{id:"roster-quarter",name:"roster-quarter",value:d,onChange:t=>P(t.target.value),children:[e.jsx("option",{value:"",children:"N/A"}),e.jsx("option",{value:"Q1",children:"Q1"}),e.jsx("option",{value:"Q2",children:"Q2"}),e.jsx("option",{value:"Q3",children:"Q3"}),e.jsx("option",{value:"Q4",children:"Q4"})]})]})]}),e.jsx("div",{style:{display:"flex",gap:12,marginTop:18},children:e.jsx("button",{type:"submit",className:"primary",disabled:!r||f,children:f?"Publishing…":"Publish to dashboard"})})]}),R&&e.jsx("p",{style:{marginTop:14,color:"var(--text-muted)"},children:R}),z&&e.jsx("p",{style:{marginTop:14,color:"#fecaca"},children:z}),e.jsxs("div",{style:{marginTop:20,padding:"12px 16px",borderRadius:12,background:"rgba(15,23,42,0.45)",border:"1px solid rgba(148,163,184,0.25)",display:"flex",gap:12,alignItems:"center",flexWrap:"wrap"},children:[e.jsx("strong",{style:{fontSize:14,letterSpacing:.4},children:"Workspace auto-save"}),e.jsx("span",{style:{color:p==="error"?"#fecaca":"var(--text-muted)",fontSize:14},children:D}),e.jsx("button",{type:"button",className:"secondary",style:{marginLeft:"auto",padding:"6px 14px"},onClick:()=>{C()},disabled:p==="saving",children:p==="saving"?"Saving…":"Sync now"})]})]}),e.jsxs("section",{className:"glass-card",style:{display:"grid",gap:18},children:[e.jsxs("header",{style:{display:"flex",justifyContent:"space-between",alignItems:"center"},children:[e.jsxs("div",{children:[e.jsx("div",{className:"badge",children:"Class statistics"}),e.jsx("h3",{style:{margin:"12px 0 0",fontSize:22,fontWeight:700},children:"Saved assessment summaries"})]}),e.jsx("button",{type:"button",className:"secondary",onClick:()=>window.print(),style:{padding:"8px 16px"},children:"Print"})]}),i&&e.jsxs("div",{className:"glass-subcard",style:{display:"flex",flexWrap:"wrap",gap:18,padding:16,borderRadius:16,border:"1px solid rgba(99,102,241,0.25)",background:"rgba(15,23,42,0.45)"},children:[e.jsxs("div",{style:{minWidth:180},children:[e.jsx("strong",{children:"Total learners"}),e.jsx("div",{style:{fontSize:24,fontWeight:700},children:i.totalStudents||"N/A"})]}),e.jsxs("div",{style:{minWidth:180},children:[e.jsx("strong",{children:"Class average"}),e.jsx("div",{style:{fontSize:24,fontWeight:700},children:i.averageScore!==null?i.averageScore.toFixed(1):"N/A"})]}),i.highest&&e.jsxs("div",{style:{minWidth:220},children:[e.jsx("strong",{children:"Top performer"}),e.jsxs("div",{style:{fontSize:15,marginTop:6},children:[i.highest.name," · ",i.highest.score??"N/A",e.jsx("div",{style:{color:"var(--text-muted)",fontSize:13},children:i.highest.testName??"N/A"})]})]}),i.lowest&&e.jsxs("div",{style:{minWidth:220},children:[e.jsx("strong",{children:"Needs support"}),e.jsxs("div",{style:{fontSize:15,marginTop:6},children:[i.lowest.name," · ",i.lowest.score??"N/A",e.jsx("div",{style:{color:"var(--text-muted)",fontSize:13},children:i.lowest.testName??"N/A"})]})]})]}),(w.length>0||j)&&e.jsxs("div",{className:"glass-subcard",style:{display:"grid",gap:18,padding:18,borderRadius:16,border:"1px solid rgba(148,163,184,0.25)",background:"rgba(15,23,42,0.45)"},children:[j&&e.jsxs("div",{children:[e.jsx("strong",{style:{display:"block",marginBottom:8},children:"Pedagogical commitments"}),e.jsx("p",{style:{margin:"0 0 10px",color:"var(--text-muted)"},children:j.summary}),e.jsx("ul",{style:{margin:0,paddingLeft:18,color:"var(--text-muted)",fontSize:14,display:"grid",gap:6},children:j.bestPractices.map((t,s)=>e.jsx("li",{children:t},s))}),e.jsxs("details",{style:{marginTop:12},children:[e.jsx("summary",{style:{cursor:"pointer",color:"#cbd5f5"},children:"Reflection prompts"}),e.jsx("ul",{style:{margin:"10px 0 0 18px",color:"var(--text-muted)",fontSize:14,display:"grid",gap:6},children:j.reflectionPrompts.map((t,s)=>e.jsx("li",{children:t},s))})]})]}),w.length>0&&e.jsxs("div",{style:{display:"grid",gap:14},children:[e.jsx("strong",{children:"Suggested learning groups"}),e.jsx("div",{style:{display:"grid",gap:12},children:w.map(t=>e.jsxs("div",{style:{border:"1px solid rgba(99,102,241,0.25)",borderRadius:14,padding:14,background:"rgba(15,23,42,0.55)",display:"grid",gap:8},children:[e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"baseline",gap:12},children:[e.jsx("span",{style:{fontWeight:600},children:t.label}),e.jsxs("span",{style:{color:"var(--text-muted)",fontSize:13},children:[t.range," • ",t.studentCount," ",t.studentCount===1?"learner":"learners"]})]}),t.students.length>0&&e.jsxs("p",{style:{margin:0,color:"var(--text-muted)",fontSize:14},children:["Learners: ",t.students.map(s=>s.name).join(", ")]}),e.jsx("ul",{style:{margin:0,paddingLeft:18,display:"grid",gap:4,color:"var(--text-muted)",fontSize:14},children:t.recommendedPractices.map((s,c)=>e.jsx("li",{children:s},c))})]},t.id))})]})]}),Q?e.jsx("div",{style:{color:"var(--text-muted)"},children:"Loading saved summaries…"}):$.length===0?e.jsx("div",{style:{color:"var(--text-muted)"},children:"Upload mastery files to generate class-level averages and ranges. Summaries feed the dashboard and AI planning tools."}):e.jsxs("table",{className:"table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Assessment"}),e.jsx("th",{children:"Period"}),e.jsx("th",{children:"Quarter"}),e.jsx("th",{children:"Average"}),e.jsx("th",{children:"High"}),e.jsx("th",{children:"Low"}),e.jsx("th",{children:"Learners"}),e.jsx("th",{children:"Updated"})]})}),e.jsx("tbody",{children:$.map(t=>e.jsxs("tr",{children:[e.jsx("td",{children:t.testName}),e.jsx("td",{children:t.period??"N/A"}),e.jsx("td",{children:t.quarter??"N/A"}),e.jsx("td",{children:t.averageScore!==null?t.averageScore.toFixed(1):"N/A"}),e.jsx("td",{children:t.maxScore??"N/A"}),e.jsx("td",{children:t.minScore??"N/A"}),e.jsx("td",{children:t.studentCount??"N/A"}),e.jsx("td",{children:t.updatedAt?t.updatedAt.toLocaleString():"N/A"})]},t.id))})]})]}),e.jsxs("section",{className:"glass-card",style:{display:"grid",gap:18},children:[e.jsxs("header",{style:{display:"flex",justifyContent:"space-between",alignItems:"center"},children:[e.jsxs("div",{children:[e.jsx("div",{className:"badge",children:"Upload history"}),e.jsx("h3",{style:{margin:"12px 0 0",fontSize:22,fontWeight:700},children:"Roster upload library"})]}),e.jsx("span",{style:{color:"var(--text-muted)",fontSize:13},children:v.length?`${v.length} recent files`:"Waiting on your first upload"})]}),v.length===0?e.jsx("div",{style:{color:"var(--text-muted)"},children:"Every roster you publish is stored securely. Download a prior CSV, reuse it for corrections, or confirm what was shared with Gemini planning."}):e.jsxs("table",{className:"table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"File"}),e.jsx("th",{children:"Assessment"}),e.jsx("th",{children:"Period"}),e.jsx("th",{children:"Quarter"}),e.jsx("th",{children:"Uploaded"}),e.jsx("th",{children:"Size"}),e.jsx("th",{children:"Actions"})]})}),e.jsx("tbody",{children:v.map(t=>e.jsxs("tr",{children:[e.jsx("td",{children:e.jsxs("div",{style:{display:"flex",flexDirection:"column"},children:[e.jsx("span",{style:{fontWeight:600},children:t.filename}),t.storageWarning&&e.jsx("span",{style:{color:"#fbbf24",fontSize:12},children:t.storageWarning})]})}),e.jsx("td",{children:t.testName??"N/A"}),e.jsx("td",{children:t.period??"N/A"}),e.jsx("td",{children:t.quarter??"N/A"}),e.jsx("td",{children:t.createdAt?t.createdAt.toLocaleString():"N/A"}),e.jsx("td",{children:K(t.size)}),e.jsx("td",{children:e.jsx("button",{type:"button",className:"secondary",onClick:()=>q(t),style:{padding:"6px 14px",fontSize:13},children:"Download"})})]},t.id))})]})]}),e.jsxs("section",{className:"glass-card",style:{display:"grid",gap:18},children:[e.jsxs("header",{style:{display:"flex",justifyContent:"space-between",alignItems:"center"},children:[e.jsxs("div",{children:[e.jsx("div",{className:"badge",children:"Individual records"}),e.jsx("h3",{style:{margin:"12px 0 0",fontSize:22,fontWeight:700},children:"Latest mastery uploads"})]}),e.jsx("button",{type:"button",className:"secondary",onClick:()=>window.print(),style:{padding:"8px 16px"},children:"Print"})]}),W.length===0?e.jsx("div",{style:{color:"var(--text-muted)"},children:"Once you commit a roster, the secure roster library shows each learner’s score, period, and test name here for quick reference and AI planning."}):e.jsxs("table",{className:"table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Student"}),e.jsx("th",{children:"Score"}),e.jsx("th",{children:"Assessment"}),e.jsx("th",{children:"Period"}),e.jsx("th",{children:"Quarter"}),e.jsx("th",{children:"Source row"}),e.jsx("th",{children:"Uploaded"})]})}),e.jsx("tbody",{children:W.map(t=>e.jsxs("tr",{children:[e.jsx("td",{children:t.displayName}),e.jsx("td",{children:t.score!==null?t.score:"N/A"}),e.jsx("td",{children:t.testName??"N/A"}),e.jsx("td",{children:t.period??"N/A"}),e.jsx("td",{children:t.quarter??"N/A"}),e.jsx("td",{children:t.sheetRow??"N/A"}),e.jsx("td",{children:t.createdAt?t.createdAt.toLocaleString():"N/A"})]},t.id))})]})]})]}):e.jsxs("div",{className:"glass-card fade-in",children:[e.jsx("h2",{style:{margin:0,fontSize:26,fontWeight:800},children:"Authenticate to upload rosters"}),e.jsx("p",{style:{color:"var(--text-muted)"},children:"This workflow stores students in Firestore under your secure workspace scope. Please sign in to continue."})]})}export{Y as default};
