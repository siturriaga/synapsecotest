import{r as l,u as Y,j as e,a as Z}from"./index-Babasj67.js";import{s as ee}from"./safeFetch-BFwNDYL7.js";import{A as V}from"./AssistedHint-QoWDV7PM.js";import"./firebase-BnXfUrx6.js";function ne({user:A}){const[f,Q]=l.useState(null),[p,H]=l.useState(""),[g,B]=l.useState(""),[m,F]=l.useState(""),[d,C]=l.useState(null),[T,k]=l.useState(null),[W,b]=l.useState(""),[I,S]=l.useState(null),[O,$]=l.useState(!1),[P,N]=l.useState({}),[_,j]=l.useState(!1),{loading:J,records:U,summaries:L,insights:o,groupInsights:R,pedagogy:y,syncStatus:x,syncError:M,lastSyncedAt:q,triggerSync:E}=Y(),h=l.useMemo(()=>d?.assessmentSummary,[d]),z=l.useMemo(()=>{if(!d)return{testName:m.trim()||null,period:p?Number(p):null,quarter:g||null};const s=d.rows.find(n=>n.data.testName),t=d.rows.find(n=>n.data.period!==null),r=d.rows.find(n=>n.data.quarter);return{testName:(s?.data.testName||m||"").trim()||null,period:t?.data.period??(p?Number(p):null),quarter:r?.data.quarter??(g||null)}},[d,m,p,g]),G=l.useMemo(()=>{if(x==="saving")return"Saving workspace snapshot…";if(x==="error")return M??"Auto-save error";if(q){const s=Math.floor((Date.now()-q.getTime())/1e3);if(s<60)return`Snapshot saved ${s}s ago`;const t=Math.floor(s/60);return t<60?`Snapshot saved ${t}m ago`:`Snapshot saved ${Math.floor(t/60)}h ago`}return"Waiting for first snapshot…"},[x,M,q]),K=l.useCallback(()=>{const s={};return Object.entries(P).forEach(([t,r])=>{const n=Number(t);if(!Number.isFinite(n))return;const i={};if(Object.prototype.hasOwnProperty.call(r,"displayName")){const a=r.displayName?.trim()??"";i.displayName=a||null}if(Object.prototype.hasOwnProperty.call(r,"period")){const a=r.period?.trim()??"";if(!a)i.period=null;else{const c=Number(a);i.period=Number.isFinite(c)?c:null}}if(Object.prototype.hasOwnProperty.call(r,"quarter")){const a=r.quarter?.trim()??"";i.quarter=a?a.toUpperCase():null}if(Object.prototype.hasOwnProperty.call(r,"score")){const a=r.score?.trim()??"";if(!a)i.score=null;else{const c=Number(a);i.score=Number.isFinite(c)?c:null}}if(Object.prototype.hasOwnProperty.call(r,"testName")){const a=r.testName?.trim()??"";i.testName=a||null}Object.keys(i).length>0&&(s[n]=i)}),s},[P]),v=l.useCallback((s,t,r)=>{N(n=>{const i={...n[s]??{},[t]:r},a={...n,[s]:i},c=Object.values(a).some(w=>w&&Object.keys(w).length>0);return j(c),a})},[]),X=l.useCallback(s=>{N(t=>{if(!t[s])return t;const r={...t};delete r[s];const n=Object.values(r).some(i=>i&&Object.keys(i).length>0);return j(n),r})},[]);async function D(s){if(!A||!f){S("Select a file and ensure you are signed in.");return}try{$(!0),S(null),b(s==="preview"?"Uploading for preview…":"Applying roster to Firestore…");let t=T;if(!t){const n=await Z.currentUser?.getIdToken(),i=new FormData;i.append("file",f);const a=await fetch(`/.netlify/functions/uploadRoster?period=${encodeURIComponent(p)}&quarter=${encodeURIComponent(g)}&testName=${encodeURIComponent(m)}`,{method:"POST",headers:n?{Authorization:`Bearer ${n}`}:void 0,body:i});if(!a.ok)throw new Error(await a.text());t=(await a.json()).uploadId,k(t)}const r=await ee("/.netlify/functions/processRoster",{method:"POST",body:JSON.stringify({uploadId:t,mode:s,manualOverrides:K()})});if(s==="preview")C(r),b("Preview ready — resolve any issues before committing."),j(!1);else{const n=r,i=n.assessmentSummary.average!==null?` Class average ${n.assessmentSummary.average.toFixed(1)}.`:"";b(`Synced ${n.written} learners. Skipped ${n.skipped}.${i}`),C(null),k(null),Q(null),F(""),N({}),j(!1);try{await E()}catch(a){console.error("Unable to force roster snapshot sync",a)}}}catch(t){console.error(t),S(t?.message??"Upload failed.")}finally{$(!1)}}return A?e.jsxs("div",{className:"fade-in",style:{display:"grid",gap:24},children:[e.jsxs("section",{className:"glass-card",children:[e.jsx("div",{className:"badge",children:"Roster ingestion"}),e.jsx("h2",{style:{margin:"12px 0 6px",fontSize:28,fontWeight:800},children:"Upload mastery results and refine them in place"}),e.jsx("p",{style:{color:"var(--text-muted)",marginBottom:20},children:"Drop in your export, edit names, periods, scores, or test titles directly in the table, then preview before saving."}),e.jsxs("form",{onSubmit:s=>{s.preventDefault(),D("preview")},children:[e.jsxs("div",{className:"field",children:[e.jsx("label",{htmlFor:"roster-file",children:"Choose roster file"}),e.jsx("input",{id:"roster-file",name:"roster-file",type:"file",accept:".csv,.xlsx,.xls,.pdf,.docx",onChange:s=>{const t=s.target.files?.[0]??null;Q(t),k(null),C(null),N({}),j(!1),b(""),S(null)},required:!0})]}),e.jsxs("div",{className:"field",children:[e.jsxs("label",{htmlFor:"roster-test",children:["Name of the test or benchmark ",e.jsx("span",{style:{color:"var(--text-muted)",fontWeight:500},children:"(optional)"})]}),e.jsx("input",{id:"roster-test",name:"roster-test",value:m,onChange:s=>F(s.target.value),placeholder:"e.g., Q2 Expressions Mastery Check"})]}),e.jsxs("div",{style:{display:"grid",gap:14,gridTemplateColumns:"repeat(auto-fit, minmax(160px, 1fr))"},children:[e.jsxs("div",{className:"field",children:[e.jsx("label",{htmlFor:"roster-period",children:"Class period"}),e.jsx("input",{id:"roster-period",name:"roster-period",type:"number",min:1,max:8,value:p,onChange:s=>H(s.target.value),placeholder:"Optional"})]}),e.jsxs("div",{className:"field",children:[e.jsx("label",{htmlFor:"roster-quarter",children:"Quarter"}),e.jsxs("select",{id:"roster-quarter",name:"roster-quarter",value:g,onChange:s=>B(s.target.value),children:[e.jsx("option",{value:"",children:"—"}),e.jsx("option",{value:"Q1",children:"Q1"}),e.jsx("option",{value:"Q2",children:"Q2"}),e.jsx("option",{value:"Q3",children:"Q3"}),e.jsx("option",{value:"Q4",children:"Q4"})]})]})]}),e.jsxs("div",{style:{display:"flex",gap:12,marginTop:18},children:[e.jsx("button",{type:"submit",className:"primary",disabled:!f||O,children:O?"Processing…":"Preview mastery data"}),e.jsx("button",{type:"button",className:"secondary",onClick:()=>D("commit"),disabled:!T||O,children:"Commit to Firestore"})]}),e.jsx("div",{style:{marginTop:12},children:e.jsx(V,{id:"roster-upload-start",message:"Choose your exported roster and tap Preview so Synapse can flag any rows that need tweaks before saving.",show:!f&&!d})})]}),W&&e.jsx("p",{style:{marginTop:14,color:"var(--text-muted)"},children:W}),I&&e.jsx("p",{style:{marginTop:14,color:"#fecaca"},children:I}),e.jsxs("div",{style:{marginTop:20,padding:"12px 16px",borderRadius:12,background:"rgba(15,23,42,0.45)",border:"1px solid rgba(148,163,184,0.25)",display:"flex",gap:12,alignItems:"center",flexWrap:"wrap"},children:[e.jsx("strong",{style:{fontSize:14,letterSpacing:.4},children:"Workspace auto-save"}),e.jsx("span",{style:{color:x==="error"?"#fecaca":"var(--text-muted)",fontSize:14},children:G}),e.jsx("button",{type:"button",className:"secondary",style:{marginLeft:"auto",padding:"6px 14px"},onClick:()=>{E()},disabled:x==="saving",children:x==="saving"?"Saving…":"Sync now"})]})]}),d&&e.jsxs("section",{className:"glass-card",style:{display:"grid",gap:18},children:[e.jsxs("div",{style:{display:"flex",flexWrap:"wrap",gap:18,justifyContent:"space-between",alignItems:"flex-end"},children:[e.jsxs("div",{children:[e.jsx("h3",{style:{margin:0,fontSize:22,fontWeight:700},children:"Preview results"}),e.jsxs("p",{style:{color:"var(--text-muted)"},children:[d.stats.ok," learners ready • ",d.stats.needs_review," need attention."]}),e.jsx(V,{id:"roster-resolve-rows",message:"Edit any highlighted rows directly in the table so class insights stay accurate when you commit.",show:d.stats.needs_review>0})]}),e.jsxs("div",{style:{display:"flex",gap:16,flexWrap:"wrap",alignItems:"stretch"},children:[e.jsxs("div",{className:"glass-subcard",style:{padding:16,borderRadius:16,border:"1px solid rgba(99,102,241,0.25)",background:"rgba(15,23,42,0.55)",minWidth:220},children:[e.jsx("strong",{children:"Test details"}),e.jsxs("div",{style:{marginTop:8,display:"grid",gap:4,fontSize:14},children:[e.jsxs("span",{children:["Assessment: ",z.testName??"—"]}),e.jsxs("span",{children:["Period: ",z.period??"—"," · Quarter: ",z.quarter??"—"]})]})]}),h&&e.jsxs("div",{className:"glass-subcard",style:{padding:16,borderRadius:16,border:"1px solid rgba(99,102,241,0.25)",background:"rgba(15,23,42,0.55)",minWidth:220},children:[e.jsx("strong",{children:"Assessment snapshot"}),e.jsxs("div",{style:{marginTop:8,display:"grid",gap:4,fontSize:14},children:[e.jsxs("span",{children:["Average: ",h.average!==null?h.average.toFixed(1):"—"]}),e.jsxs("span",{children:["Median: ",h.median!==null?h.median.toFixed(1):"—"]}),e.jsxs("span",{children:["High: ",h.max!==null?h.max.toFixed(1):"—"," · Low: ",h.min!==null?h.min.toFixed(1):"—"]})]})]})]})]}),e.jsxs("table",{className:"table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Row"}),e.jsx("th",{children:"Student"}),e.jsx("th",{children:"Period"}),e.jsx("th",{children:"Quarter"}),e.jsx("th",{children:"Score"}),e.jsx("th",{children:"Assessment"}),e.jsx("th",{children:"Status"}),e.jsx("th",{children:"Manual"})]})}),e.jsx("tbody",{children:d.rows.map(s=>{const t=P[s.row]??{},r=!!t&&Object.keys(t).length>0,n=t.displayName??s.data.displayName??"",i=t.period??(s.data.period!==null?String(s.data.period):""),a=t.quarter??s.data.quarter??"",c=t.score??(s.data.score!==null?String(s.data.score):""),w=t.testName??s.data.testName??m??"";return e.jsxs("tr",{children:[e.jsx("td",{children:s.row}),e.jsx("td",{children:e.jsx("input",{className:"table-input",name:`student-${s.row}`,value:n,onChange:u=>v(s.row,"displayName",u.target.value),placeholder:"Student name"})}),e.jsx("td",{children:e.jsx("input",{className:"table-input",type:"number",min:1,max:8,name:`period-${s.row}`,value:i,onChange:u=>v(s.row,"period",u.target.value),placeholder:"—"})}),e.jsx("td",{children:e.jsxs("select",{className:"table-input",name:`quarter-${s.row}`,value:a,onChange:u=>v(s.row,"quarter",u.target.value),children:[e.jsx("option",{value:"",children:"—"}),e.jsx("option",{value:"Q1",children:"Q1"}),e.jsx("option",{value:"Q2",children:"Q2"}),e.jsx("option",{value:"Q3",children:"Q3"}),e.jsx("option",{value:"Q4",children:"Q4"})]})}),e.jsx("td",{children:e.jsx("input",{className:"table-input",type:"number",step:"0.1",name:`score-${s.row}`,value:c,onChange:u=>v(s.row,"score",u.target.value),placeholder:"—"})}),e.jsx("td",{children:e.jsx("input",{className:"table-input",name:`test-${s.row}`,value:w,onChange:u=>v(s.row,"testName",u.target.value),placeholder:"Assessment name"})}),e.jsx("td",{children:s.status==="needs_review"?e.jsxs("span",{className:"status-warning",children:["Resolve: ",s.issues?.join(", ")||"Review required"]}):s.warnings?.length?e.jsxs("span",{className:"status-warning",children:["Warnings: ",s.warnings.join(", ")]}):e.jsx("span",{className:"status-success",children:"Validated"})}),e.jsx("td",{children:r?e.jsx("button",{type:"button",className:"link-button",onClick:()=>X(s.row),children:"Reset"}):e.jsx("span",{style:{color:"var(--text-muted)",fontSize:13},children:"—"})})]},s.row)})})]}),_&&e.jsx("div",{style:{marginTop:12,padding:"12px 16px",borderRadius:12,border:"1px solid rgba(251,191,36,0.45)",background:"rgba(251,191,36,0.12)",color:"#facc15",fontSize:13},children:"Manual edits pending — run Preview again to validate before committing."})]}),e.jsxs("section",{className:"glass-card",style:{display:"grid",gap:18},children:[e.jsxs("header",{style:{display:"flex",justifyContent:"space-between",alignItems:"center"},children:[e.jsxs("div",{children:[e.jsx("div",{className:"badge",children:"Class statistics"}),e.jsx("h3",{style:{margin:"12px 0 0",fontSize:22,fontWeight:700},children:"Saved assessment summaries"})]}),e.jsx("button",{type:"button",className:"secondary",onClick:()=>window.print(),style:{padding:"8px 16px"},children:"Print"})]}),o&&e.jsxs("div",{className:"glass-subcard",style:{display:"flex",flexWrap:"wrap",gap:18,padding:16,borderRadius:16,border:"1px solid rgba(99,102,241,0.25)",background:"rgba(15,23,42,0.45)"},children:[e.jsxs("div",{style:{minWidth:180},children:[e.jsx("strong",{children:"Total learners"}),e.jsx("div",{style:{fontSize:24,fontWeight:700},children:o.totalStudents||"—"})]}),e.jsxs("div",{style:{minWidth:180},children:[e.jsx("strong",{children:"Class average"}),e.jsx("div",{style:{fontSize:24,fontWeight:700},children:o.averageScore!==null?o.averageScore.toFixed(1):"—"})]}),o.highest&&e.jsxs("div",{style:{minWidth:220},children:[e.jsx("strong",{children:"Top performer"}),e.jsxs("div",{style:{fontSize:15,marginTop:6},children:[o.highest.name," · ",o.highest.score??"—",e.jsx("div",{style:{color:"var(--text-muted)",fontSize:13},children:o.highest.testName??"Assessment"})]})]}),o.lowest&&e.jsxs("div",{style:{minWidth:220},children:[e.jsx("strong",{children:"Needs support"}),e.jsxs("div",{style:{fontSize:15,marginTop:6},children:[o.lowest.name," · ",o.lowest.score??"—",e.jsx("div",{style:{color:"var(--text-muted)",fontSize:13},children:o.lowest.testName??"Assessment"})]})]})]}),(R.length>0||y)&&e.jsxs("div",{className:"glass-subcard",style:{display:"grid",gap:18,padding:18,borderRadius:16,border:"1px solid rgba(148,163,184,0.25)",background:"rgba(15,23,42,0.45)"},children:[y&&e.jsxs("div",{children:[e.jsx("strong",{style:{display:"block",marginBottom:8},children:"Pedagogical commitments"}),e.jsx("p",{style:{margin:"0 0 10px",color:"var(--text-muted)"},children:y.summary}),e.jsx("ul",{style:{margin:0,paddingLeft:18,color:"var(--text-muted)",fontSize:14,display:"grid",gap:6},children:y.bestPractices.map((s,t)=>e.jsx("li",{children:s},t))}),e.jsxs("details",{style:{marginTop:12},children:[e.jsx("summary",{style:{cursor:"pointer",color:"#cbd5f5"},children:"Reflection prompts"}),e.jsx("ul",{style:{margin:"10px 0 0 18px",color:"var(--text-muted)",fontSize:14,display:"grid",gap:6},children:y.reflectionPrompts.map((s,t)=>e.jsx("li",{children:s},t))})]})]}),R.length>0&&e.jsxs("div",{style:{display:"grid",gap:14},children:[e.jsx("strong",{children:"Suggested learning groups"}),e.jsx("div",{style:{display:"grid",gap:12},children:R.map(s=>e.jsxs("div",{style:{border:"1px solid rgba(99,102,241,0.25)",borderRadius:14,padding:14,background:"rgba(15,23,42,0.55)",display:"grid",gap:8},children:[e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"baseline",gap:12},children:[e.jsx("span",{style:{fontWeight:600},children:s.label}),e.jsxs("span",{style:{color:"var(--text-muted)",fontSize:13},children:[s.range," • ",s.studentCount," ",s.studentCount===1?"learner":"learners"]})]}),s.students.length>0&&e.jsxs("p",{style:{margin:0,color:"var(--text-muted)",fontSize:14},children:["Learners: ",s.students.map(t=>t.name).join(", ")]}),e.jsx("ul",{style:{margin:0,paddingLeft:18,display:"grid",gap:4,color:"var(--text-muted)",fontSize:14},children:s.recommendedPractices.map((t,r)=>e.jsx("li",{children:t},r))})]},s.id))})]})]}),J?e.jsx("div",{style:{color:"var(--text-muted)"},children:"Loading saved summaries…"}):L.length===0?e.jsx("div",{style:{color:"var(--text-muted)"},children:"Upload mastery files to generate class-level averages and ranges. Summaries feed the dashboard and AI planning tools."}):e.jsxs("table",{className:"table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Assessment"}),e.jsx("th",{children:"Period"}),e.jsx("th",{children:"Quarter"}),e.jsx("th",{children:"Average"}),e.jsx("th",{children:"High"}),e.jsx("th",{children:"Low"}),e.jsx("th",{children:"Learners"}),e.jsx("th",{children:"Updated"})]})}),e.jsx("tbody",{children:L.map(s=>e.jsxs("tr",{children:[e.jsx("td",{children:s.testName}),e.jsx("td",{children:s.period??"—"}),e.jsx("td",{children:s.quarter??"—"}),e.jsx("td",{children:s.averageScore!==null?s.averageScore.toFixed(1):"—"}),e.jsx("td",{children:s.maxScore??"—"}),e.jsx("td",{children:s.minScore??"—"}),e.jsx("td",{children:s.studentCount??"—"}),e.jsx("td",{children:s.updatedAt?s.updatedAt.toLocaleString():"—"})]},s.id))})]})]}),e.jsxs("section",{className:"glass-card",style:{display:"grid",gap:18},children:[e.jsxs("header",{style:{display:"flex",justifyContent:"space-between",alignItems:"center"},children:[e.jsxs("div",{children:[e.jsx("div",{className:"badge",children:"Individual records"}),e.jsx("h3",{style:{margin:"12px 0 0",fontSize:22,fontWeight:700},children:"Latest mastery uploads"})]}),e.jsx("button",{type:"button",className:"secondary",onClick:()=>window.print(),style:{padding:"8px 16px"},children:"Print"})]}),U.length===0?e.jsx("div",{style:{color:"var(--text-muted)"},children:"Once you commit a roster, the secure roster library shows each learner’s score, period, and test name here for quick reference and AI planning."}):e.jsxs("table",{className:"table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Student"}),e.jsx("th",{children:"Score"}),e.jsx("th",{children:"Assessment"}),e.jsx("th",{children:"Period"}),e.jsx("th",{children:"Quarter"}),e.jsx("th",{children:"Source row"}),e.jsx("th",{children:"Uploaded"})]})}),e.jsx("tbody",{children:U.map(s=>e.jsxs("tr",{children:[e.jsx("td",{children:s.displayName}),e.jsx("td",{children:s.score!==null?s.score:"—"}),e.jsx("td",{children:s.testName??"—"}),e.jsx("td",{children:s.period??"—"}),e.jsx("td",{children:s.quarter??"—"}),e.jsx("td",{children:s.sheetRow??"—"}),e.jsx("td",{children:s.createdAt?s.createdAt.toLocaleString():"—"})]},s.id))})]})]})]}):e.jsxs("div",{className:"glass-card fade-in",children:[e.jsx("h2",{style:{margin:0,fontSize:26,fontWeight:800},children:"Authenticate to upload rosters"}),e.jsx("p",{style:{color:"var(--text-muted)"},children:"This workflow stores students in Firestore under your secure workspace scope. Please sign in to continue."})]})}export{ne as default};
