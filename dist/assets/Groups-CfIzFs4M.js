import{r as p,d as F,a as P,j as r}from"./index-UOQmTZJ0.js";import{s as C}from"./safeFetch-_vMMFq3m.js";import{q as U,k as D,m as O,j as W}from"./firebase-HdBvgX-e.js";function H(e,l){const b=(Array.isArray(e?.students)?e.students:[]).map((o,x)=>{if(!o||typeof o!="object")return null;const a=o,i=typeof a.name=="string"&&a.name.trim()?a.name.trim():`Learner ${x+1}`;return{id:typeof a.id=="string"&&a.id.trim()?a.id.trim():`${l}-student-${x+1}`,name:i,readiness:typeof a.readiness=="string"?a.readiness:null,period:typeof a.period=="number"?a.period:typeof a.period=="string"&&Number.parseInt(a.period,10)||null,quarter:typeof a.quarter=="string"?a.quarter:null,score:typeof a.score=="number"?a.score:typeof a.score=="string"?Number.parseFloat(a.score):null}}).filter(o=>!!o);return{id:l,name:typeof e?.name=="string"&&e.name.trim()?e.name.trim():"Instructional group",rationale:typeof e?.rationale=="string"&&e.rationale.trim()?e.rationale.trim():"Group rationale unavailable.",students:b,mode:e?.mode==="homogeneous"?"homogeneous":e?.mode==="heterogeneous"?"heterogeneous":null,refinement:typeof e?.refinement=="string"?e.refinement:null,source:e?.source==="heuristic"?"heuristic":"gemini",createdAt:e?.createdAt?.toDate?.()??null}}function T(e){const[l,v]=p.useState([]),[b,o]=p.useState(!1);p.useEffect(()=>{if(!e){v([]),o(!1);return}o(!0);const i=U(O(F,`users/${e.uid}/groups`),D("createdAt","desc")),t=W(i,g=>{const m=[];g.forEach(y=>{m.push(H(y.data(),y.id))}),v(m),o(!1)});return()=>t()},[e]);const x=p.useMemo(()=>{if(!l.length)return null;const i={extending:0,developing:0,foundation:0,unknown:0},t=new Set;let g=0;l.forEach(d=>{d.students.forEach(f=>{if(f.id&&t.add(f.id),typeof f.readiness=="string"){const j=f.readiness.toLowerCase();j.includes("extend")?i.extending+=1:j.includes("develop")?i.developing+=1:j.includes("foundation")?i.foundation+=1:i.unknown+=1,g+=1}else i.unknown+=1})});const m=t.size||g,y=l.reduce((d,f)=>f.createdAt&&(!d||f.createdAt>d)?f.createdAt:d,null),S=t.size>0?Math.min(100,Math.round(g/t.size*100)):null;return{totalGroups:l.length,totalStudents:m,readinessBreakdown:i,coveragePercent:S,lastGeneratedAt:y}},[l]),a=p.useMemo(()=>{if(!l.length)return null;const i=l[0];return{mode:i.mode,refinement:i.refinement,source:i.source,createdAt:i.createdAt}},[l]);return{groups:l,loading:b,insights:x,latestRun:a}}function q(e){return e===null||Number.isNaN(e)?null:e>=85?`Extending mastery (${Math.round(e)}%)`:e>=70?`Developing understanding (${Math.round(e)}%)`:`Foundation support needed (${Math.round(e)}%)`}function L(e,l,v,b,o){const x=typeof e.id=="string"&&e.id.trim()?e.id.trim():`group-${l+1}`,i=(Array.isArray(e.students)?e.students:[]).map((t,g)=>{if(!t||typeof t!="object")return null;const m=typeof t.id=="string"&&t.id.trim()?t.id.trim():`${x}-student-${g+1}`,y=typeof t.name=="string"&&t.name.trim()?t.name.trim():`Learner ${g+1}`,S=typeof t.readiness=="string"?t.readiness:null;let d=null;if(typeof t.period=="number")d=t.period;else if(typeof t.period=="string"){const c=Number.parseInt(t.period,10);d=Number.isFinite(c)?c:null}const f=typeof t.quarter=="string"?t.quarter:null;let j=null;if(typeof t.score=="number")j=Number.isFinite(t.score)?t.score:null;else if(typeof t.score=="string"){const c=Number.parseFloat(t.score);j=Number.isFinite(c)?c:null}return{id:m,name:y,readiness:S,period:d,quarter:f,score:j}}).filter(t=>!!t);return{id:x,name:typeof e.name=="string"&&e.name.trim()?e.name.trim():`Group ${l+1}`,rationale:typeof e.rationale=="string"&&e.rationale.trim()?e.rationale.trim():"Instructional focus generated for this cohort.",students:i,mode:v,refinement:o,source:b,createdAt:new Date}}function V({user:e}){const{students:l,records:v,loading:b}=P(),o=p.useMemo(()=>{if(l.length)return l.map(n=>{const u=typeof n.lastScore=="number"?n.lastScore:null;return{id:n.id,name:n.displayName,period:n.period??null,quarter:n.quarter??null,score:u,readiness:q(u)}});if(!v.length)return[];const s=new Map;return v.forEach(n=>{const u=n.studentId??n.displayName.toLowerCase(),h=typeof n.score=="number"?n.score:null,A=q(h),w=s.get(u);(!w||h!==null&&(w.score??-1/0)<h)&&s.set(u,{id:u,name:n.displayName,period:n.period??null,quarter:n.quarter??null,score:h,readiness:A})}),Array.from(s.values())},[v,l]),{groups:x,loading:a,insights:i,latestRun:t}=T(e),[g,m]=p.useState([]),[y,S]=p.useState(!1),[d,f]=p.useState("heterogeneous"),[j,c]=p.useState(null),[z,k]=p.useState([]),[$,G]=p.useState("");p.useEffect(()=>{e||(m([]),G(""),c(null))},[e]),p.useEffect(()=>{!y&&g.length>0&&x.length>0&&m([])},[y,g.length,x.length]);const M=p.useMemo(()=>{if(o.length===0)return b?"Loading roster…":"No roster loaded";const s=new Set(o.map(h=>h.period).filter(Boolean)),n=new Set(o.map(h=>h.quarter).filter(Boolean));let u=`${o.length} students • Periods ${Array.from(s).join(", ")||"n/a"} • Quarters ${Array.from(n).join(", ")||"n/a"}`;return t?.createdAt&&(u+=` • Last generated ${t.createdAt.toLocaleString()}`),t?.mode&&(u+=` • Mode ${t.mode}`),t?.source==="heuristic"&&(u+=" • Heuristic fallback"),u},[o,b,t]),E=y||a,N=g.length>0?g:x;async function R(){if(!e){c("Sign in to access Gemini grouping.");return}if(o.length===0){c("Upload a roster first to unlock grouping suggestions.");return}S(!0),c(null),G(""),m([]);try{const s=await C("/.netlify/functions/groupStudents",{method:"POST",body:JSON.stringify({mode:d})}),n=Array.isArray(s.groups)?s.groups:[],u=s.metadata?.source==="heuristic"?"heuristic":"gemini",h=n.map((A,w)=>L(A,w,d,u,null));m(h),Array.isArray(s.promptChips)&&s.promptChips.length&&k(s.promptChips),c(null),G(u==="heuristic"?s.metadata?.reason?`Gemini unavailable: ${s.metadata.reason}. Generated heuristic cohorts.`:"Gemini unavailable. Generated heuristic cohorts.":"Gemini generated fresh cohorts.")}catch(s){console.error(s),m([]),G(""),c(s?.message??"Gemini grouping failed. Check logs for details.")}finally{S(!1)}}async function B(s){if(o.length===0){c("Upload a roster first to unlock grouping suggestions.");return}S(!0),c(null),G("");try{const n=await C("/.netlify/functions/groupStudents",{method:"POST",body:JSON.stringify({mode:d,refinement:s})}),u=Array.isArray(n.groups)?n.groups:[],h=n.metadata?.source==="heuristic"?"heuristic":"gemini",A=u.map((w,I)=>L(w,I,d,h,s));m(A),Array.isArray(n.promptChips)&&n.promptChips.length&&k(n.promptChips),G(h==="heuristic"?n.metadata?.reason?`Gemini unavailable: ${n.metadata.reason}. Used heuristic refinement.`:"Gemini unavailable. Used heuristic refinement.":`Refined cohorts with “${s}”.`)}catch(n){console.error(n),m([]),G(""),c(n?.message??"Unable to refine groups.")}finally{S(!1)}}return e?r.jsxs("div",{className:"fade-in",style:{display:"grid",gap:24},children:[r.jsxs("section",{className:"glass-card",style:{display:"grid",gap:18},children:[r.jsxs("header",{style:{display:"flex",justifyContent:"space-between",alignItems:"flex-start",gap:12},children:[r.jsxs("div",{children:[r.jsx("h2",{style:{margin:"4px 0 0",fontSize:28,fontWeight:800},children:"Student groups orchestrated by Gemini"}),r.jsx("p",{style:{color:"var(--text-muted)",marginTop:8},children:M})]}),r.jsxs("div",{style:{display:"flex",gap:10},children:[r.jsx("button",{className:"secondary",onClick:()=>f("heterogeneous"),style:{opacity:d==="heterogeneous"?1:.6},children:"Heterogeneous"}),r.jsx("button",{className:"secondary",onClick:()=>f("homogeneous"),style:{opacity:d==="homogeneous"?1:.6},children:"Homogeneous"})]})]}),r.jsx("div",{className:"chip-row",children:z.map(s=>r.jsx("div",{className:"chip",onClick:()=>B(s),children:s},s))}),r.jsx("button",{className:"primary",onClick:R,disabled:y||o.length===0||b,children:y?"Generating groups…":"Generate instructional groups"}),$&&r.jsx("div",{style:{color:"#bbf7d0"},children:$}),j&&r.jsx("div",{style:{color:"#fecaca"},children:j})]}),r.jsxs("section",{className:"glass-card",style:{display:"grid",gap:18},children:[r.jsx("h3",{style:{margin:0,fontSize:22,fontWeight:700},children:"Recommended groups"}),i&&N.length>0&&r.jsxs("div",{className:"glass-subcard",style:{borderRadius:14,padding:12,background:"rgba(15, 23, 42, 0.45)",border:"1px solid rgba(148,163,184,0.2)",display:"flex",flexWrap:"wrap",gap:16,fontSize:13,color:"var(--text-muted)"},children:[r.jsxs("span",{children:[r.jsx("strong",{style:{color:"var(--text-primary)"},children:i.totalGroups})," cohorts"]}),r.jsxs("span",{children:[r.jsx("strong",{style:{color:"var(--text-primary)"},children:i.totalStudents})," learners covered"]}),i.coveragePercent!==null&&r.jsxs("span",{children:[i.coveragePercent,"% readiness coverage"]}),r.jsxs("span",{children:["Extending ",i.readinessBreakdown.extending," • Developing ",i.readinessBreakdown.developing," • Foundation"," ",i.readinessBreakdown.foundation," • Mixed ",i.readinessBreakdown.unknown]})]}),E?r.jsx("div",{className:"empty-state",children:"Loading Gemini cohorts…"}):N.length===0?r.jsx("div",{className:"empty-state",children:o.length===0?b?"Loading roster…":"Upload a roster first to unlock grouping suggestions.":"Run Gemini grouping to populate cohorts."}):r.jsx("div",{style:{display:"grid",gap:18},children:N.map(s=>r.jsxs("div",{style:{border:"1px solid rgba(148,163,184,0.2)",borderRadius:18,padding:18,background:"rgba(15, 23, 42, 0.55)"},children:[r.jsxs("header",{style:{display:"flex",justifyContent:"space-between",alignItems:"flex-start"},children:[r.jsxs("div",{children:[r.jsx("h4",{style:{margin:"0 0 6px",fontSize:20},children:s.name}),r.jsx("p",{style:{color:"var(--text-muted)",margin:0},children:s.rationale}),s.source==="heuristic"&&r.jsx("span",{style:{color:"#fde68a",fontSize:12},children:"Heuristic fallback"})]}),r.jsxs("span",{className:"tag",children:[s.students.length," learners"]})]}),r.jsx("ul",{style:{marginTop:16,listStyle:"none",padding:0,display:"grid",gap:8},children:s.students.map(n=>r.jsxs("li",{style:{display:"flex",justifyContent:"space-between",alignItems:"center"},children:[r.jsx("span",{children:n.name}),r.jsx("span",{style:{color:"var(--text-muted)",fontSize:13},children:n.readiness||"readiness n/a"})]},n.id??n.name))})]},s.id))})]})]}):r.jsxs("div",{className:"glass-card fade-in",children:[r.jsx("h2",{style:{margin:0,fontSize:26,fontWeight:800},children:"Sign in required"}),r.jsx("p",{style:{color:"var(--text-muted)"},children:"Authenticate to let Gemini analyze your roster data and recommend instructional groupings."})]})}export{V as default};
