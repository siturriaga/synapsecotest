import{u as q,r as o,j as e}from"./index-DpmMRoj_.js";import{s as S}from"./safeFetch-ZUv9GM5K.js";import"./firebase-BZTKtPSO.js";function b(t){return t===null||Number.isNaN(t)?null:t>=85?`Extending mastery (${Math.round(t)}%)`:t>=70?`Developing understanding (${Math.round(t)}%)`:`Foundation support needed (${Math.round(t)}%)`}function R({user:t}){const{students:g,records:p,loading:l}=q(),i=o.useMemo(()=>{if(g.length)return g.map(s=>{const r=typeof s.lastScore=="number"?s.lastScore:null;return{id:s.id,name:s.displayName,period:s.period??null,quarter:s.quarter??null,score:r,readiness:b(r)}});if(!p.length)return[];const n=new Map;return p.forEach(s=>{const r=s.studentId??s.displayName.toLowerCase(),c=typeof s.score=="number"?s.score:null,k=b(c),j=n.get(r);(!j||c!==null&&(j.score??-1/0)<c)&&n.set(r,{id:r,name:s.displayName,period:s.period??null,quarter:s.quarter??null,score:c,readiness:k})}),Array.from(n.values())},[p,g]),[m,d]=o.useState(!1),[h,f]=o.useState([]),[u,y]=o.useState("heterogeneous"),[x,a]=o.useState(null),[N,v]=o.useState([]),C=o.useMemo(()=>{if(i.length===0)return l?"Loading roster…":"No roster loaded";const n=new Set(i.map(r=>r.period).filter(Boolean)),s=new Set(i.map(r=>r.quarter).filter(Boolean));return`${i.length} students • Periods ${Array.from(n).join(", ")||"n/a"} • Quarters ${Array.from(s).join(", ")||"n/a"}`},[i,l]);async function w(){if(!t){a("Sign in to access Gemini grouping.");return}if(i.length===0){a("Upload a roster first to unlock grouping suggestions.");return}d(!0),a(null);try{const n=await S("/.netlify/functions/groupStudents",{method:"POST",body:JSON.stringify({mode:u})});f(n.groups),n.promptChips&&n.promptChips.length&&v(n.promptChips)}catch(n){console.error(n),a(n?.message??"Gemini grouping failed. Check logs for details.")}finally{d(!1)}}async function G(n){if(i.length===0){a("Upload a roster first to unlock grouping suggestions.");return}d(!0),a(null);try{const s=await S("/.netlify/functions/groupStudents",{method:"POST",body:JSON.stringify({mode:u,refinement:n})});f(s.groups)}catch(s){console.error(s),a(s?.message??"Unable to refine groups.")}finally{d(!1)}}return t?e.jsxs("div",{className:"fade-in",style:{display:"grid",gap:24},children:[e.jsxs("section",{className:"glass-card",style:{display:"grid",gap:18},children:[e.jsxs("header",{style:{display:"flex",justifyContent:"space-between",alignItems:"flex-start",gap:12},children:[e.jsxs("div",{children:[e.jsx("div",{className:"badge",children:"AI grouping"}),e.jsx("h2",{style:{margin:"12px 0 0",fontSize:28,fontWeight:800},children:"Student groups orchestrated by Gemini"}),e.jsx("p",{style:{color:"var(--text-muted)",marginTop:8},children:C})]}),e.jsxs("div",{style:{display:"flex",gap:10},children:[e.jsx("button",{className:"secondary",onClick:()=>y("heterogeneous"),style:{opacity:u==="heterogeneous"?1:.6},children:"Heterogeneous"}),e.jsx("button",{className:"secondary",onClick:()=>y("homogeneous"),style:{opacity:u==="homogeneous"?1:.6},children:"Homogeneous"})]})]}),e.jsx("div",{className:"chip-row",children:N.map(n=>e.jsx("div",{className:"chip",onClick:()=>G(n),children:n},n))}),e.jsx("button",{className:"primary",onClick:w,disabled:m||i.length===0||l,children:m?"Generating groups…":"Generate instructional groups"}),x&&e.jsx("div",{style:{color:"#fecaca"},children:x})]}),e.jsxs("section",{className:"glass-card",style:{display:"grid",gap:18},children:[e.jsx("h3",{style:{margin:0,fontSize:22,fontWeight:700},children:"Recommended groups"}),h.length===0?e.jsx("div",{className:"empty-state",children:i.length===0?l?"Loading roster…":"Upload a roster first to unlock grouping suggestions.":"Run Gemini grouping to populate cohorts."}):e.jsx("div",{style:{display:"grid",gap:18},children:h.map(n=>e.jsxs("div",{style:{border:"1px solid rgba(148,163,184,0.2)",borderRadius:18,padding:18,background:"rgba(15, 23, 42, 0.55)"},children:[e.jsxs("header",{style:{display:"flex",justifyContent:"space-between",alignItems:"flex-start"},children:[e.jsxs("div",{children:[e.jsx("h4",{style:{margin:"0 0 6px",fontSize:20},children:n.name}),e.jsx("p",{style:{color:"var(--text-muted)",margin:0},children:n.rationale})]}),e.jsxs("span",{className:"tag",children:[n.students.length," learners"]})]}),e.jsx("ul",{style:{marginTop:16,listStyle:"none",padding:0,display:"grid",gap:8},children:n.students.map(s=>e.jsxs("li",{style:{display:"flex",justifyContent:"space-between",alignItems:"center"},children:[e.jsx("span",{children:s.name}),e.jsx("span",{style:{color:"var(--text-muted)",fontSize:13},children:s.readiness||"readiness n/a"})]},s.id??s.name))})]},n.id))})]})]}):e.jsxs("div",{className:"glass-card fade-in",children:[e.jsx("h2",{style:{margin:0,fontSize:26,fontWeight:800},children:"Sign in required"}),e.jsx("p",{style:{color:"var(--text-muted)"},children:"Authenticate to let Gemini analyze your roster data and recommend instructional groupings."})]})}export{R as default};
