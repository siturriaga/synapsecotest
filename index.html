            <button id="generate-button"
                class="w-full mt-8 bg-indigo-600 text-white font-bold py-3 rounded-lg hover:bg-indigo-700 transition duration-150 shadow-lg text-lg" disabled>
                Initializing Secure Session...
            </button>
        </div>

        <div id="section-data" class="card bg-white p-6 rounded-b-xl border-t-4 border-indigo-500 hidden">
            <h2 class="text-2xl font-semibold text-gray-800 mb-6">Pedagogical Data Analyzer</h2>

            <div class="space-y-4">
                <p class="text-sm text-gray-600">Analyze performance by selecting a standard and pasting raw test data below (e.g., student ID, score, common errors, etc., from CSV/Excel). Data will be analyzed against the selected standard to provide insights.</p>

                <div>
                    <label for="raw-data-input" class="block text-sm font-semibold text-indigo-700 mb-1">Raw Performance Data (Paste CSV/Excel Data Here)</label>
                    <textarea id="raw-data-input" rows="8" placeholder="Paste data here. Format: Student ID, Student Name, Score, Errors/Variations..." class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 text-gray-700"></textarea>
                </div>
            </div>

            <button id="analyze-button"
                class="w-full mt-6 bg-green-600 text-white font-bold py-3 rounded-lg hover:bg-green-700 transition duration-150 shadow-lg text-lg" disabled>
                Analyze Data & Generate Report
            </button>

            <div id="analysis-output" class="mt-8 space-y-6 hidden">
                <h3 class="text-xl font-semibold text-gray-800 border-b pb-2">Analysis Results</h3>

                <div id="mastery-dashboard" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    </div>

                <div id="ai-insights" class="space-y-6">
                    </div>
            </div>
        </div>

        <div id="output-card" class="card bg-white p-6 rounded-xl border-t-4 border-indigo-500 hidden">

            <div id="loading-indicator" class="flex justify-center items-center py-10 hidden">
                <div class="spinner mr-3"></div>
                <p class="text-lg text-indigo-600">Generating content... please wait. (This requires two API calls.)</p>
            </div>

            <div id="story-content" class="mb-8">
                <h2 class="text-2xl font-semibold text-gray-800 mb-3 border-b pb-2">The Friendly Nag (Story & Context)</h2>
                </div>

            <div id="assignment-output">
                <h2 class="text-2xl font-semibold text-gray-800 mb-3 border-b pb-2">Assignment Output</h2>
                <div id="assignment-content" class="assignment-output space-y-6">
                    </div>
            </div>

            <div id="error-message" class="text-red-600 font-medium mt-6 hidden"></div>
        </div>
    </div>

    <div id="initialization-status" class="fixed top-0 left-0 m-4 p-2 bg-indigo-500 text-white text-xs rounded shadow-lg">Initializing...</div>

    <script>
        // --- CRITICAL FIX: All initialization is wrapped in DOMContentLoaded listener ---
        window.addEventListener('DOMContentLoaded', () => {

            // --- API Configuration ---
            const API_KEY = ""; // Placeholder for injection from the environment
            const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${API_KEY}`;
            let loadedStandardsData = {}; // Stores standards loaded from Firestore
            let appId = 'default-app-id'; 
            
            // --- STANDARDS IMPORT: Hardcoded data for initial load and stability ---
            // NOTE: This data is used immediately to populate the dropdowns.
            const initialStandardsImport = {
                "Civics": [
                    {"code": "SS.7.CG.1.1", "desc": "Ancient Influences on Republic", "full_text": "Standard: Analyze the influences of ancient Greece, ancient Rome and the Judeo-Christian tradition on America's constitutional republic. Clarifications: Students will explain the influence of ancient Greece (e.g., civic participation, legislative bodies, voting rights, written constitution); ancient Rome (e.g., republicanism, rule of law, separation of powers); and Judeo-Christian ethics (justice, individual worth)."},
                    {"code": "SS.7.CG.1.10", "desc": "Federalists vs. Anti-Federalists", "full_text": "Compare the viewpoints of the Federalists and the Anti-Federalists regarding ratification of the U.S. Constitution and including a bill of rights. Clarifications: Identify arguments for a strong central government (Federalists) vs. demand for a Bill of Rights (Anti-Federalists)."},
                    {"code": "SS.7.CG.1.11", "desc": "Define Rule of Law", "full_text": "Define the rule of law and recognize its influence on the development of legal, political and governmental systems in the United States. Clarifications: Contrast characteristics of a society with the rule of law vs. one without. Assess importance of due process."},
                    {"code": "SS.7.CG.1.9", "desc": "Separation of Powers/Checks", "full_text": "Describe how the U.S. Constitution limits the powers of government through separation of powers, checks and balances, individual rights, rule of law and due process of law. Clarifications: Distinguish between separation of powers (three distinct jobs) and checks and balances (each branch limits the others)."}
                ],
                "USHistory": [
                    {"code": "SS.68.AA.1.1", "desc": "Afro-Eurasian trade pre-Atlantic slave trade", "full_text": "Identify Afro-Eurasian trade routes and methods prior to the development of the Atlantic slave trade. Instruction includes how slavery was utilized in Asian, European and African cultures and the similarities and differences between serfdom and slavery."},
                    {"code": "SS.68.AA.1.3", "desc": "Indentured Servitude Evolution", "full_text": "Examine the evolution of the labor force in the use of indentured servitude contracts. Instruction includes the comparative treatment of indentured servants of European and African extraction and the transition from an indentured to a slave-based economy."}
                ],
                "ELA": [
                    {"code": "ELA.7.R.1.3", "desc": "Explain influence of narrator/POV", "full_text": "Explain the influence of narrator(s), including unreliable narrator(s), and/or shifts in point of view in a literary text. Clarifications: Unreliable narrator lacks credibility; shifts in point of view change perspective for effect."},
                    {"code": "ELA.6.C.1.3", "desc": "Write and support a claim", "full_text": "Write and support a claim using logical reasoning, relevant evidence from multiple sources, elaboration, and a logical organizational structure with varied transitions."}
                ],
                "Math": [
                    {"code": "MA.7.AR.3.4", "desc": "Solving Equations/Inequalities", "full_text": "Write and solve linear two-step equations and inequalities in one variable."},
                    {"code": "MA.6.GR.1.1", "desc": "Area of Polygons", "full_text": "Find the area of polygons by decomposing them into triangles and rectangles."}
                ],
                "WorldHistory": [
                    {"code": "SS.6.W.2.1", "desc": "Ancient River Civilizations", "full_text": "Describe the main characteristics and beliefs of major river valley civilizations (Mesopotamia, Egypt, Indus, China)."},
                    {"code": "SS.6.W.3.5", "desc": "European Middle Ages", "full_text": "Analyze the causes and effects of the feudal system and the role of the Catholic Church during the European Middle Ages."}
                ]
            };


            // --- DOM Elements ---
            const appContainer = document.getElementById('app-container');
            const subjectSelect = document.getElementById('subject-select');
            const gradeSelect = document.getElementById('grade-select');
            const standardSelect = document.getElementById('standard-select');
            const formatSelect = document.getElementById('format-select');
            const levelSelect = document.getElementById('level-select');
            const countSelect = document.getElementById('question-count');
            const generateButton = document.getElementById('generate-button');
            const analyzeButton = document.getElementById('analyze-button');
            const outputCard = document.getElementById('output-card');
            const loadingIndicator = document.getElementById('loading-indicator');
            const storyContent = document.getElementById('story-content');
            const assignmentContent = document.getElementById('assignment-content');
            const errorMessageElement = document.getElementById('error-message');
            const standardsFile = document.getElementById('standards-file');
            const fileStatus = document.getElementById('file-status');
            const initStatus = document.getElementById('initialization-status');
            
            // Tab Elements
            const tabContent = document.getElementById('tab-content');
            const tabData = document.getElementById('tab-data');
            const sectionContent = document.getElementById('section-content');
            const sectionData = document.getElementById('section-data');
            const rawDataInput = document.getElementById('raw-data-input');
            const analysisOutput = document.getElementById('analysis-output');
            const masteryDashboard = document.getElementById('mastery-dashboard');
            const aiInsights = document.getElementById('ai-insights');


            // --- Tab Switching Logic ---
            function switchTab(target) {
                if (target === 'content') {
                    sectionContent.classList.remove('hidden');
                    sectionData.classList.add('hidden');
                    tabContent.classList.replace('bg-gray-100', 'bg-indigo-600');
                    tabContent.classList.replace('text-gray-700', 'text-white');
                    tabData.classList.replace('bg-indigo-600', 'bg-gray-100');
                    tabData.classList.replace('text-white', 'text-gray-700');
                } else {
                    sectionContent.classList.add('hidden');
                    sectionData.classList.remove('hidden');
                    tabData.classList.replace('bg-gray-100', 'bg-indigo-600');
                    tabData.classList.replace('text-gray-700', 'text-white');
                    tabContent.classList.replace('bg-indigo-600', 'bg-gray-100');
                    tabContent.classList.replace('text-white', 'text-gray-700');
                }
                outputCard.classList.add('hidden'); 
                errorMessageElement.classList.add('hidden');
            }

            tabContent.addEventListener('click', () => switchTab('content'));
            tabData.addEventListener('click', () => switchTab('data'));
            

            // --- Firebase Setup (Mandatory and Secure) ---
            let db, auth, userId;
            let firebaseReady = false;

            async function initializeFirebase() {
                try {
                    const config = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
                    const token = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                    const envAppId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                    appId = envAppId; 

                    if (!window.firebaseExports || !config) {
                        throw new Error("Missing secure configuration (Firebase globals). Deployment required.");
                    }

                    const { initializeApp, getAuth, signInWithCustomToken, signInAnonymously, getFirestore } = window.firebaseExports;

                    const app = initializeApp(config);
                    db = getFirestore(app);
                    auth = getAuth(app);

                    initStatus.textContent = "Authenticating...";

                    if (token) {
                        await signInWithCustomToken(auth, token);
     
