<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Standards Differentiated Content Generator</title>
    <!-- Load Tailwind CSS for modern styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Firebase Imports for Standards File Storage -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, query, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        // Export necessary functions globally for use in the main script block
        window.firebaseExports = { initializeApp, getAuth, signInAnonymously, signInWithCustomToken, getFirestore, doc, setDoc, getDoc, collection, query, onSnapshot };
    </script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .card { box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05); }
        .assignment-output { line-height: 1.6; }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-top-color: #3b82f6;
            border-radius: 50%;
            width: 2rem;
            height: 2rem;
            animation: spin 1s ease-in-out infinite;
        }
        /* Custom styling for dropdown appearance */
        select, input[type="file"] {
            appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 20' fill='none' stroke='%234b5563'%3e%3cpath d='M7 7l3 3 3-3' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round'/%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 0.75rem center;
            background-size: 1.5em 1.5em;
        }
    </style>
</head>
<body class="p-4 sm:p-8 min-h-screen">

    <div id="app-container" class="max-w-4xl mx-auto space-y-8 hidden">
        <header class="text-center">
            <h1 class="text-4xl font-extrabold text-gray-900 mb-2">FL Standards Differentiation Tool</h1>
            <p class="text-gray-600">Generate level-differentiated assignments and data insights.</p>
        </header>

        <!-- Tabbed Interface -->
        <div class="flex border-b border-gray-200">
            <button id="tab-content" class="px-4 py-2 text-sm font-medium border-r border-gray-200 text-white bg-indigo-600 rounded-tl-lg hover:bg-indigo-700 transition">Content Generator</button>
            <button id="tab-data" class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 rounded-tr-lg hover:bg-gray-200 transition">Data Analyzer</button>
        </div>

        <!-- Tab Content 1: Content Generator -->
        <div id="section-content" class="card bg-white p-6 rounded-b-xl border-t-4 border-indigo-500">
            <h2 class="text-2xl font-semibold text-gray-800 mb-6">Assignment Creation Parameters</h2>

            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">

                <!-- File Upload Status -->
                <div class="lg:col-span-3">
                    <label for="standards-file" class="block text-sm font-semibold text-indigo-700 mb-1">1. Standards File (JSON Upload)</label>
                    <input type="file" id="standards-file" accept=".json" class="w-full text-gray-700 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100">
                    <p id="file-status" class="mt-2 text-sm text-red-500 font-medium"></p>
                </div>

                <!-- 2. Subject Dropdown -->
                <div>
                    <label for="subject-select" class="block text-sm font-semibold text-indigo-700 mb-1">2. Select Subject</label>
                    <select id="subject-select" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 text-gray-700 bg-white">
                        <option value="Civics">Civics</option>
                        <option value="USHistory">U.S. History</option>
                        <option value="WorldHistory">World History</option>
                        <option value="ELA">ELA</option>
                        <option value="Math">Math</option>
                    </select>
                </div>

                <!-- 3. Grade Level Dropdown -->
                <div>
                    <label for="grade-select" class="block text-sm font-semibold text-indigo-700 mb-1">3. Select Grade Level</label>
                    <select id="grade-select" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 text-gray-700 bg-white">
                        <option value="6th Grade">6th Grade</option>
                        <option value="7th Grade">7th Grade</option>
                        <option value="8th Grade">8th Grade</option>
                    </select>
                </div>

                <!-- 4. Standard Code Dropdown -->
                <div>
                    <label for="standard-select" class="block text-sm font-semibold text-indigo-700 mb-1">4. Select Standard Code</label>
                    <select id="standard-select" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 text-gray-700 bg-white">
                        <option value="" disabled selected>Upload file to load standards</option>
                    </select>
                </div>

                <!-- 5. Assignment Format Dropdown -->
                <div>
                    <label for="format-select" class="block text-sm font-semibold text-indigo-700 mb-1">5. Select Format</label>
                    <select id="format-select" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 text-gray-700 bg-white">
                        <option value="MCQ">Multiple Choice Quiz (MCQ)</option>
                        <option value="ConceptMap">Concept to Definition Map</option>
                        <option value="TDQs">Short Story with TDQs (FAST Style)</option>
                        <option value="Mixed">Mixed MCQ & Longer Questions</option>
                    </select>
                </div>

                <!-- 6. Differentiation Level Dropdown -->
                <div>
                    <label for="level-select" class="block text-sm font-semibold text-indigo-700 mb-1">6. Select Differentiation Level</label>
                    <select id="level-select" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 text-gray-700 bg-white">
                        <option value="On-Level">On-Level</option>
                        <option value="Developing">Developing (DOK 1/2)</option>
                        <option value="Advanced">Advanced (DOK 3/4)</option>
                        <option value="ELL">ELL (Minimal Text/Visual Aids)</option>
                    </select>
                </div>

                <!-- 7. Item Count Dropdown -->
                <div>
                    <label for="question-count" class="block text-sm font-semibold text-indigo-700 mb-1">7. Item Count</label>
                    <select id="question-count" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 text-gray-700 bg-white">
                        <option value="5">5 Questions/Concepts</option>
                        <option value="10">10 Questions/Concepts</option>
                        <option value="15">15 Questions/Concepts</option>
                    </select>
                </div>
            </div>

            <!-- Generate Button -->
            <button id="generate-button"
                class="w-full mt-8 bg-indigo-600 text-white font-bold py-3 rounded-lg hover:bg-indigo-700 transition duration-150 shadow-lg text-lg" disabled>
                Initializing Secure Session...
            </button>
        </div>

        <!-- Tab Content 2: Data Analyzer (Hidden by default) -->
        <div id="section-data" class="card bg-white p-6 rounded-b-xl border-t-4 border-indigo-500 hidden">
            <h2 class="text-2xl font-semibold text-gray-800 mb-6">Pedagogical Data Analyzer</h2>

            <div class="space-y-4">
                <p class="text-sm text-gray-600">Analyze performance by selecting a standard and pasting raw test data below (e.g., student ID, score, common errors, etc., from CSV/Excel). Data will be analyzed against the selected standard to provide insights.</p>

                <!-- Data Paste Area -->
                <div>
                    <label for="raw-data-input" class="block text-sm font-semibold text-indigo-700 mb-1">Raw Performance Data (Paste CSV/Excel Data Here)</label>
                    <textarea id="raw-data-input" rows="8" placeholder="Paste data here. Format: Student ID, Student Name, Score, Errors/Variations..." class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 text-gray-700"></textarea>
                </div>
            </div>

            <button id="analyze-button"
                class="w-full mt-6 bg-green-600 text-white font-bold py-3 rounded-lg hover:bg-green-700 transition duration-150 shadow-lg text-lg" disabled>
                Analyze Data & Generate Report
            </button>

            <!-- Data Analyzer Output -->
            <div id="analysis-output" class="mt-8 space-y-6 hidden">
                <h3 class="text-xl font-semibold text-gray-800 border-b pb-2">Analysis Results</h3>

                <!-- Mastery Band Dashboard -->
                <div id="mastery-dashboard" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <!-- Cards will be injected here -->
                </div>

                <!-- AI Generated Insights -->
                <div id="ai-insights" class="space-y-6">
                    <!-- General, Class, and Individual Insights will be injected here -->
                </div>
            </div>
        </div>

        <!-- Output Area (Shared for Content Generation) -->
        <div id="output-card" class="card bg-white p-6 rounded-xl border-t-4 border-indigo-500 hidden">

            <!-- Loading State -->
            <div id="loading-indicator" class="flex justify-center items-center py-10 hidden">
                <div class="spinner mr-3"></div>
                <p class="text-lg text-indigo-600">Generating content... please wait. (This requires two API calls.)</p>
            </div>

            <!-- Story Output -->
            <div id="story-content" class="mb-8">
                <h2 class="text-2xl font-semibold text-gray-800 mb-3 border-b pb-2">The Friendly Nag (Story & Context)</h2>
                <!-- Story will be injected here -->
            </div>

            <!-- Assignment Output -->
            <div id="assignment-output">
                <h2 class="text-2xl font-semibold text-gray-800 mb-3 border-b pb-2">Assignment Output</h2>
                <div id="assignment-content" class="assignment-output space-y-6">
                    <!-- Assignment will be injected here -->
                </div>
            </div>

            <!-- Error Message -->
            <div id="error-message" class="text-red-600 font-medium mt-6 hidden"></div>
        </div>
    </div>

    <!-- Initialization Status for Debugging -->
    <div id="initialization-status" class="fixed top-0 left-0 m-4 p-2 bg-indigo-500 text-white text-xs rounded shadow-lg">Initializing...</div>

    <script>
        // --- CRITICAL FIX: All initialization is wrapped in DOMContentLoaded listener ---
        window.addEventListener('DOMContentLoaded', () => {

            // --- API Configuration ---
            const API_KEY = ""; // Placeholder for injection from the environment
            const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${API_KEY}`;
            let loadedStandardsData = {}; // Stores standards loaded from Firestore
            let appId = 'default-app-id'; 
            
            // --- STANDARDS IMPORT: Hardcoded data for initial load and stability ---
            // NOTE: This data is used immediately to populate the dropdowns.
            const initialStandardsImport = {
                "Civics": [
                    {"code": "SS.7.CG.1.1", "desc": "Ancient Influences on Republic", "full_text": "Standard: Analyze the influences of ancient Greece, ancient Rome and the Judeo-Christian tradition on America's constitutional republic. Clarifications: Students will explain the influence of ancient Greece (e.g., civic participation, legislative bodies, voting rights, written constitution); ancient Rome (e.g., republicanism, rule of law, separation of powers); and Judeo-Christian ethics (justice, individual worth)."},
                    {"code": "SS.7.CG.1.10", "desc": "Federalists vs. Anti-Federalists", "full_text": "Compare the viewpoints of the Federalists and the Anti-Federalists regarding ratification of the U.S. Constitution and including a bill of rights. Clarifications: Identify arguments for a strong central government (Federalists) vs. demand for a Bill of Rights (Anti-Federalists)."},
                    {"code": "SS.7.CG.1.11", "desc": "Define Rule of Law", "full_text": "Define the rule of law and recognize its influence on the development of legal, political and governmental systems in the United States. Clarifications: Contrast characteristics of a society with the rule of law vs. one without. Assess importance of due process."},
                    {"code": "SS.7.CG.1.9", "desc": "Separation of Powers/Checks", "full_text": "Describe how the U.S. Constitution limits the powers of government through separation of powers, checks and balances, individual rights, rule of law and due process of law. Clarifications: Distinguish between separation of powers (three distinct jobs) and checks and balances (each branch limits the others)."}
                ],
                "USHistory": [
                    {"code": "SS.68.AA.1.1", "desc": "Afro-Eurasian trade pre-Atlantic slave trade", "full_text": "Identify Afro-Eurasian trade routes and methods prior to the development of the Atlantic slave trade. Instruction includes how slavery was utilized in Asian, European and African cultures and the similarities and differences between serfdom and slavery."},
                    {"code": "SS.68.AA.1.3", "desc": "Indentured Servitude Evolution", "full_text": "Examine the evolution of the labor force in the use of indentured servitude contracts. Instruction includes the comparative treatment of indentured servants of European and African extraction and the transition from an indentured to a slave-based economy."}
                ],
                "ELA": [
                    {"code": "ELA.7.R.1.3", "desc": "Explain influence of narrator/POV", "full_text": "Explain the influence of narrator(s), including unreliable narrator(s), and/or shifts in point of view in a literary text. Clarifications: Unreliable narrator lacks credibility; shifts in point of view change perspective for effect."},
                    {"code": "ELA.6.C.1.3", "desc": "Write and support a claim", "full_text": "Write and support a claim using logical reasoning, relevant evidence from multiple sources, elaboration, and a logical organizational structure with varied transitions."}
                ],
                "Math": [
                    {"code": "MA.7.AR.3.4", "desc": "Solving Equations/Inequalities", "full_text": "Write and solve linear two-step equations and inequalities in one variable."},
                    {"code": "MA.6.GR.1.1", "desc": "Area of Polygons", "full_text": "Find the area of polygons by decomposing them into triangles and rectangles."}
                ],
                "WorldHistory": [
                    {"code": "SS.6.W.2.1", "desc": "Ancient River Civilizations", "full_text": "Describe the main characteristics and beliefs of major river valley civilizations (Mesopotamia, Egypt, Indus, China)."},
                    {"code": "SS.6.W.3.5", "desc": "European Middle Ages", "full_text": "Analyze the causes and effects of the feudal system and the role of the Catholic Church during the European Middle Ages."}
                ]
            };


            // --- DOM Elements ---
            const appContainer = document.getElementById('app-container');
            const subjectSelect = document.getElementById('subject-select');
            const gradeSelect = document.getElementById('grade-select');
            const standardSelect = document.getElementById('standard-select');
            const formatSelect = document.getElementById('format-select');
            const levelSelect = document.getElementById('level-select');
            const countSelect = document.getElementById('question-count');
            const generateButton = document.getElementById('generate-button');
            const analyzeButton = document.getElementById('analyze-button');
            const outputCard = document.getElementById('output-card');
            const loadingIndicator = document.getElementById('loading-indicator');
            const storyContent = document.getElementById('story-content');
            const assignmentContent = document.getElementById('assignment-content');
            const errorMessageElement = document.getElementById('error-message');
            const standardsFile = document.getElementById('standards-file');
            const fileStatus = document.getElementById('file-status');
            const initStatus = document.getElementById('initialization-status');
            
            // Tab Elements
            const tabContent = document.getElementById('tab-content');
            const tabData = document.getElementById('tab-data');
            const sectionContent = document.getElementById('section-content');
            const sectionData = document.getElementById('section-data');
            const rawDataInput = document.getElementById('raw-data-input');
            const analysisOutput = document.getElementById('analysis-output');
            const masteryDashboard = document.getElementById('mastery-dashboard');
            const aiInsights = document.getElementById('ai-insights');


            // --- Tab Switching Logic ---
            function switchTab(target) {
                if (target === 'content') {
                    sectionContent.classList.remove('hidden');
                    sectionData.classList.add('hidden');
                    tabContent.classList.replace('bg-gray-100', 'bg-indigo-600');
                    tabContent.classList.replace('text-gray-700', 'text-white');
                    tabData.classList.replace('bg-indigo-600', 'bg-gray-100');
                    tabData.classList.replace('text-white', 'text-gray-700');
                } else {
                    sectionContent.classList.add('hidden');
                    sectionData.classList.remove('hidden');
                    tabData.classList.replace('bg-gray-100', 'bg-indigo-600');
                    tabData.classList.replace('text-gray-700', 'text-white');
                    tabContent.classList.replace('bg-indigo-600', 'bg-gray-100');
                    tabContent.classList.replace('text-white', 'text-gray-700');
                }
                outputCard.classList.add('hidden'); 
                errorMessageElement.classList.add('hidden');
            }

            tabContent.addEventListener('click', () => switchTab('content'));
            tabData.addEventListener('click', () => switchTab('data'));
            

            // --- Firebase Setup (Mandatory and Secure) ---
            let db, auth, userId;
            let firebaseReady = false;

            async function initializeFirebase() {
                try {
                    const config = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
                    const token = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                    const envAppId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                    appId = envAppId; 

                    if (!window.firebaseExports || !config) {
                        throw new Error("Missing secure configuration (Firebase globals). Deployment required.");
                    }

                    const { initializeApp, getAuth, signInWithCustomToken, signInAnonymously, getFirestore } = window.firebaseExports;

                    const app = initializeApp(config);
                    db = getFirestore(app);
                    auth = getAuth(app);

                    initStatus.textContent = "Authenticating...";

                    if (token) {
                        await signInWithCustomToken(auth, token);
                    } else {
                        await signInAnonymously(auth);
                    }
                    userId = auth.currentUser?.uid || 'anonymous-user';

                    loadedStandardsData = initialStandardsImport; 
                    setupStandardsListener(db, appId, userId);

                    firebaseReady = true;
                    initStatus.textContent = "Session Active";
                    appContainer.classList.remove('hidden');
                    generateButton.disabled = false;
                    analyzeButton.disabled = false;
                    generateButton.textContent = 'Generate Differentiated Content';
                    analyzeButton.textContent = 'Analyze Data & Generate Report';
                    populateStandardDropdown(); 

                } catch (e) {
                    console.error("SECURE INITIALIZATION FAILED:", e);
                    initStatus.textContent = "ERROR: Secure Session Failed.";
                    fileStatus.textContent = "SECURE ERROR: Content generation disabled. Please ensure all environment variables are correctly set.";
                    fileStatus.classList.replace('text-red-500', 'text-red-600');
                    generateButton.textContent = 'Initialization Failed';
                    analyzeButton.textContent = 'Initialization Failed';
                }
            }

            // --- File Management & Listeners ---

            function setupStandardsListener(db, appId, userId) {
                const { doc, onSnapshot } = window.firebaseExports;
                const standardsRef = doc(db, `artifacts/${appId}/users/${userId}/standards/current`);

                onSnapshot(standardsRef, (docSnap) => {
                    if (docSnap.exists() && docSnap.data().data) {
                        loadedStandardsData = JSON.parse(docSnap.data().data);
                        populateStandardDropdown();
                        fileStatus.textContent = `Standards loaded successfully from Firestore.`;
                        fileStatus.classList.replace('text-red-500', 'text-green-600');
                    } else {
                        populateStandardDropdown();
                        fileStatus.textContent = 'Using embedded standards data. Upload a file to save custom data.';
                        fileStatus.classList.replace('text-red-500', 'text-gray-500'); 
                    }
                }, (error) => {
                    console.error("Error listening to standards:", error);
                    fileStatus.textContent = 'Error loading standards from database.';
                });
            }

            async function saveStandardsToFirestore(jsonData) {
                if (!firebaseReady) return;

                try {
                    const { doc, setDoc } = window.firebaseExports;
                    // FIX: Use the resolved global 'appId'
                    const standardsRef = doc(db, `artifacts/${appId}/users/${userId}/standards/current`);
                    await setDoc(standardsRef, {
                        data: JSON.stringify(jsonData),
                        timestamp: new Date().toISOString()
                    });
                    console.log("Standards saved to Firestore.");
                } catch (e) {
                    console.error("Error saving standards:", e);
                    fileStatus.textContent = "Error saving file. Check console.";
                }
            }

            standardsFile.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (!file || !firebaseReady) {
                    fileStatus.textContent = 'Initialization required. Please wait for "Session Active" or check console.';
                    return;
                }

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const jsonData = JSON.parse(e.target.result);
                        if (typeof jsonData !== 'object' || Array.isArray(jsonData)) {
                             throw new Error("Invalid JSON structure. Must be an object of subjects.");
                        }
                        saveStandardsToFirestore(jsonData);
                    } catch (error) {
                        fileStatus.textContent = `File Error: ${error.message}`;
                        fileStatus.classList.replace('text-green-600', 'text-red-500');
                    }
                };
                reader.readAsText(file);
            });


            // --- Logic Block 1: Content Generator Functions ---
            
            function populateStandardDropdown() { 
                const subject = subjectSelect.value;
                const grade = gradeSelect.value.split(' ')[0];
                
                standardSelect.innerHTML = '';
                standardSelect.disabled = true;

                const standardsList = loadedStandardsData[subject] || [];
                
                if (standardsList.length > 0) {
                    standardsList.forEach(std => {
                        const option = document.createElement('option');
                        option.value = std.code;
                        option.textContent = `${std.code}: ${std.desc ? std.desc.substring(0, 40) + '...' : std.name.substring(0, 40) + '...'}`;
                        standardSelect.appendChild(option);
                    });
                    standardSelect.disabled = false;
                } else {
                    standardSelect.innerHTML = `<option value="" disabled selected>No standards for ${subject} in file</option>`;
                }
            }

            function getFullStandardText(standardCode, subject) { 
                const standards = loadedStandardsData[subject];
                if (standards) {
                    const standard = standards.find(s => s.code === standardCode);
                    if (standard) {
                        let fullText = standard.name;
                        if (standard.internal?.clarifications) fullText += " | CLARIFICATIONS: " + standard.internal.clarifications.join('; ');
                        if (standard.internal?.objectives) fullText += " | OBJECTIVES: " + standard.internal.objectives.join('; ');
                        return fullText;
                    }
                }
                return `Standard text not found for ${standardCode}. Generating based on code only.`;
            }

            async function fetchWithRetries(url, options, maxRetries = 5) { 
                for (let i = 0; i < maxRetries; i++) {
                    try {
                        const response = await fetch(url, options);
                        if (!response.ok) {
                            const errorBody = await response.text();
                            throw new Error(`HTTP error! Status: ${response.status}. Body: ${errorBody.substring(0, 100)}...`);
                        }
                        return response;
                    } catch (error) {
                        if (i === maxRetries - 1) {
                            throw new Error(`API failed after ${maxRetries} attempts: ${error.message}`);
                        }
                        const delay = Math.pow(2, i) * 1000 + Math.random() * 500;
                        await new Promise(resolve => setTimeout(resolve, delay));
                    }
                }
            }

            function getStoryPrompt(standardCode, level, gradeLevel, fullStandardText) { 
                let storyRules = "Generate a story (2-3 paragraphs) that explains the core concept of the standard.";
                let storyStyle = `You must write for a **${gradeLevel}** student. Use a nagging, yet supportive, tutor persona to transmit the information. Be culturally responsible.`;

                if (level === 'ELL') {
                    storyRules = "Generate a story that explains the core concept of the standard. The narrative must be exactly 2-3 **very short, simple sentences** per paragraph, using the simplest vocabulary possible. Immediately after the story, provide a single sentence describing a simple picture or visual aid that the teacher should use to teach this concept (e.g., 'Visual Aid Suggestion: Picture of two kids sharing a cookie.').";
                    storyStyle = `Use a supportive, encouraging tone. Use minimal to no complex English suitable for a **${gradeLevel}** ELL student. Bold key vocabulary words.`;
                }

                return {
                    system: `You are a pedagogical expert and tutor. Follow these instructions precisely. The content must be 100% aligned to this standard's text: [${fullStandardText}]. You may use creative scenarios and examples if they benefit student academic understanding. ${storyStyle}`,
                    user: `Based on the FL Standard ${standardCode}: ${storyRules}`
                };
            }

            function getAssignmentInstructions(standardCode, format, level, count, gradeLevel, fullStandardText) { 
                let assignmentType = "";
                let difficulty = "";
                const gradeInstruction = `The content must be appropriate for a **${gradeLevel}** student.`;

                switch (level) {
                    case 'Advanced':
                        difficulty = "Generate questions/items at Depth of Knowledge (DOK) level 3 or 4, requiring synthesis, analysis, and evaluation. Use complex, academic vocabulary.";
                        break;
                    case 'Developing':
                        difficulty = "Generate questions/items at Depth of Knowledge (DOK) level 1 or 2, focusing on recall, application, and basic understanding. Provide generous contextual clues.";
                        break;
                    case 'ELL':
                        difficulty = "Generate questions/items using the absolute simplest grammar and vocabulary. Questions must be brief, short, and highly chunked. The focus is on basic identification.";
                        break;
                    case 'On-Level':
                    default:
                        difficulty = `Generate questions/items appropriate for a typical ${gradeLevel} student, balanced across DOK levels 2 and 3.`;
                }

                switch (format) {
                    case 'MCQ':
                        assignmentType = `Generate a Multiple Choice Quiz with exactly ${count} questions. Each question must have four options (A, B, C, D) and a single correct answer.`;
                        break;
                    case 'ConceptMap':
                        assignmentType = `Generate a list of exactly ${count} core concepts related to the standard. For each concept, provide a concise, differentiated definition (the 'Map' structure). No quiz questions.`;
                        break;
                    case 'TDQs':
                        assignmentType = `Generate exactly ${count} Text-Dependent Questions (TDQs) based on the story/text. The TDQs MUST mirror the style of the FL FAST Reading Test, including multi-part questions or questions requiring evidence.`;
                        break;
                    case 'Mixed':
                        const halfCount = Math.floor(count / 2);
                        assignmentType = `Generate a Mixed Assignment. It must contain ${halfCount} Multiple Choice Questions (A-D, single correct answer) AND ${Math.ceil(count / 2)} longer Short Answer/Open-Ended Questions.`;
                        break;
                }

                return {
                    system: `You are a pedagogical expert specializing in Florida B.E.S.T. Standards. ${gradeInstruction} The content must be 100% aligned to this standard's text: [${fullStandardText}]. You may use creative scenarios and examples if they benefit student academic understanding. Generate ${format} content based on the standard ${standardCode}. You MUST follow the JSON schema. Be culturally responsible. Differentiation: ${difficulty}`,
                    user: `FL Standard: ${standardCode}. Task: ${assignmentType}`
                };
            }

            const quizSchema = (count) => ({ type: "OBJECT", properties: { quizTitle: { type: "STRING" }, level: { type: "STRING" }, questions: { type: "ARRAY", description: `Array of exactly ${count} multiple-choice questions.`, items: { type: "OBJECT", properties: { questionText: { type: "STRING" }, options: { type: "OBJECT", properties: { A: { type: "STRING" }, B: { type: "STRING" }, C: { type: "STRING" }, D: { type: "STRING" } }, required: ["A", "B", "C", "D"] }, correctAnswer: { type: "STRING" } }, required: ["questionText", "options", "correctAnswer"] } } }, required: ["quizTitle", "level", "questions"] });
            const conceptMapSchema = (count) => ({ type: "OBJECT", properties: { title: { type: "STRING" }, level: { type: "STRING" }, concepts: { type: "ARRAY", description: `Array of exactly ${count} core concepts and their differentiated definitions.`, items: { type: "OBJECT", properties: { concept: { type: "STRING" }, definition: { type: "STRING" }, }, required: ["concept", "definition"] } } }, required: ["title", "level", "concepts"] });
            const tdqSchema = (count) => ({ type: "OBJECT", properties: { assignmentTitle: { type: "STRING" }, level: { type: "STRING" }, story: { type: "STRING", description: "The full story/informational text generated for the TDQs." }, questions: { type: "ARRAY", description: `Array of exactly ${count} Text-Dependent Questions (TDQs).`, items: { type: "OBJECT", properties: { question: { type: "STRING" }, complexity: { type: "STRING", description: "DOK Level (1, 2, 3, or 4)." }, }, required: ["question", "complexity"] } } }, required: ["assignmentTitle", "level", "story", "questions"] });
            const mixedSchema = (count) => ({ type: "OBJECT", properties: { assignmentTitle: { type: "STRING" }, level: { type: "STRING" }, mcqs: { type: "ARRAY", description: `Array of exactly ${Math.floor(count / 2)} Multiple Choice Questions.`, items: { type: "OBJECT", properties: { questionText: { type: "STRING" }, options: { type: "OBJECT", properties: { A: { type: "STRING" }, B: { type: "STRING" }, C: { type: "STRING" }, D: { type: "STRING" } }, required: ["A", "B", "C", "D"] }, correctAnswer: { type: "STRING" } }, required: ["questionText", "options", "correctAnswer"] } }, longerQuestions: { type: "ARRAY", description: `Array of exactly ${Math.ceil(count / 2)} short answer/open-ended questions.`, items: { type: "OBJECT", properties: { prompt: { type: "STRING" }, requiredLength: { type: "STRING", description: "e.g., 2-3 sentences or 1 paragraph." } }, required: ["prompt", "requiredLength"] } } }, required: ["assignmentTitle", "level", "mcqs", "longerQuestions"] });

            function getPayloadAndSchema(standardCode, format, level, count, gradeLevel, fullStandardText) { 
                const instructions = getAssignmentInstructions(standardCode, format, level, count, gradeLevel, fullStandardText);
                let schema;

                switch (format) {
                    case 'MCQ': schema = quizSchema(count); break;
                    case 'ConceptMap': schema = conceptMapSchema(count); break;
                    case 'TDQs': schema = tdqSchema(count); break;
                    case 'Mixed': schema = mixedSchema(count); break;
                    default: throw new Error("Invalid format selected.");
                }

                return {
                    payload: {
                        contents: [{ parts: [{ text: instructions.user }] }],
                        systemInstruction: { parts: [{ text: instructions.system }] },
                        generationConfig: {
                            responseMimeType: "application/json",
                            responseSchema: schema
                        }
                    },
                    schema: schema
                };
            }
            
            function renderStory(text, level) { 
                let formattedText = text;
                let title = "The Friendly Nag (Story & Context)";
                let visualAid = "";

                if (level === 'ELL') {
                    const visualMatch = text.match(/Visual Aid Suggestion:\s*(.*)/i);
                    if (visualMatch && visualMatch[1]) {
                        visualAid = `<p class="mt-4 p-3 border-l-4 border-yellow-500 bg-yellow-50 text-yellow-800">
                            **Visual Aid Suggestion for Teacher:** ${visualMatch[1].trim()}
                            <span class="block text-xs mt-1">(Use this simple picture to help explain the main idea with minimal language.)</span>
                        </p>`;
                        formattedText = text.replace(visualMatch[0], '').trim();
                    }
                    title = "The Friendly Nag (Simple ELL Narrative)";
                }

                storyContent.innerHTML = `
                    <h3 class="text-xl font-semibold text-gray-800 mb-3">${title}</h3>
                    <div class="p-4 rounded-lg bg-gray-50 text-gray-700">
                        ${formattedText.split('\n\n').map(p => `<p class="mb-2">${p}</p>`).join('')}
                        ${visualAid}
                    </div>
                `;
            }

            function renderAssignment(data, format) { 
                assignmentContent.innerHTML = '';
                let html = `<h3 class="text-xl font-semibold text-gray-800 mb-4">${data.assignmentTitle || data.title || format} <span class="text-sm font-medium text-indigo-500">(${data.level})</span></h3>`;

                const renderQuestionList = (questions, isLonger) => {
                    return questions.map((q, index) => {
                        let optionsHtml = '';
                        let footerHtml = '';
                        const qIndex = isLonger ? index + 1 : index + 1;

                        if (q.options) {
                            optionsHtml = ['A', 'B', 'C', 'D'].map(key => `
                                <li class="p-3 mb-2 rounded-lg transition duration-100 border border-gray-200 ${q.correctAnswer === key ? 'bg-green-50' : ''}">
                                    <span class="font-bold mr-2 text-indigo-600">${key}.</span>
                                    ${q.options[key]}
                                </li>
                            `).join('');
                            footerHtml += `<p class="mt-3 text-sm font-medium text-green-700">Correct Answer: ${q.correctAnswer}</p>`;
                        } else if (q.requiredLength) {
                            footerHtml += `<p class="text-sm text-gray-500 mt-1">Required Length: ${q.requiredLength}</p>`;
                        }
                        
                        if (q.complexity) {
                            footerHtml += `<p class="text-sm text-gray-500 mt-1">Complexity: DOK ${q.complexity}</p>`;
                        }

                        return `
                            <div class="p-5 bg-white rounded-xl border border-gray-100 shadow-sm mb-4">
                                <p class="text-lg font-semibold text-gray-800 mb-3">${isLonger ? 'Prompt' : 'Question'} ${qIndex}: ${q.questionText || q.prompt || q.question}</p>
                                ${optionsHtml ? `<ul class="space-y-1 text-gray-700 text-sm list-none">${optionsHtml}</ul>` : ''}
                                ${footerHtml}
                            </div>
                        `;
                    }).join('');
                };

                // --- MCQ Rendering ---
                if (format === 'MCQ' && data.questions) {
                    html += `<div class="space-y-6">${renderQuestionList(data.questions, false)}</div>`;
                }

                // --- Concept Map Rendering ---
                else if (format === 'ConceptMap' && data.concepts) {
                    html += `<div class="grid grid-cols-1 md:grid-cols-2 gap-4">`;
                    data.concepts.forEach((c, index) => {
                        html += `
                            <div class="p-5 bg-white rounded-xl border border-gray-100 shadow-sm">
                                <p class="text-lg font-bold text-indigo-700 mb-1">${index + 1}. ${c.concept}</p>
                                <p class="text-gray-700">${c.definition}</p>
                            </div>
                        `;
                    });
                    html += `</div>`;
                }

                // --- TDQ Rendering ---
                else if (format === 'TDQs' && data.story && data.questions) {
                    html += `<div class="p-5 bg-gray-50 rounded-xl mb-6">
                                <h4 class="text-lg font-bold mb-2 text-gray-800">Source Text:</h4>
                                <div class="text-gray-700 whitespace-pre-wrap">${data.story}</div>
                            </div>`;
                    html += `<div class="space-y-6">${renderQuestionList(data.questions, false)}</div>`;
                }

                // --- Mixed Assignment Rendering ---
                else if (format === 'Mixed' && data.mcqs && data.longerQuestions) {
                    // Render MCQs
                    html += `<h4 class="text-xl font-bold mt-6 mb-4 text-gray-800">Multiple Choice Questions (Differentiated)</h4>`;
                    html += renderQuestionList(data.mcqs, false);

                    // Render Longer Questions
                    html += `<h4 class="text-xl font-bold mt-10 mb-4 text-gray-800">Short Answer/Extended Response (Differentiated)</h4>`;
                    html += renderQuestionList(data.longerQuestions, true);
                }
                else {
                    html = `<p class="text-red-500">Error: Could not render structured data for the selected format. The model may have returned an incorrect structure. (Check console for details)</p>`;
                }
                assignmentContent.innerHTML = html;
            }


            // --- Logic Block 2: Data Analyzer Functions ---

            // JSON Schema for Data Analysis (Mastery Bands and Insights)
            const analysisSchema = {
                type: "OBJECT",
                properties: {
                    masteryBand: {
                        type: "OBJECT",
                        description: "Overall class performance band.",
                        properties: {
                            band: { type: "STRING", enum: ["High Mastery", "Proficient", "Developing", "Needs Remediation"] },
                            score: { type: "STRING", description: "Approximate class average score (e.g., 78%)." },
                            summary: { type: "STRING", description: "One sentence summary of the status." }
                        },
                        required: ["band", "score", "summary"]
                    },
                    generalInsights: {
                        type: "STRING",
                        description: "General, high-level pedagogical findings for the class (1-2 paragraphs)."
                    },
                    classFindings: {
                        type: "STRING",
                        description: "Specific common errors, fuzzy concepts, or variations in student answers (1-2 paragraphs). Inject N/A if specific data is missing."
                    },
                    pedagogicalRecommendations: {
                        type: "STRING",
                        description: "Actionable, multi-step teaching strategies for remediation, customized to the found deficits (1-2 paragraphs)."
                    },
                    individualFlags: {
                        type: "STRING",
                        description: "Identifies 1-2 specific students (by name/ID if available) who need immediate intervention, based on lowest scores or unique error patterns. Inject N/A if specific student data is missing."
                    }
                },
                required: ["masteryBand", "generalInsights", "classFindings", "pedagogicalRecommendations", "individualFlags"]
            };

            function getAnalysisPrompt(standardCode, gradeLevel, fullStandardText, rawData) {
                const system = `You are a Master Pedagogical Data Analyst and Curriculum Consultant. Your task is to analyze the provided raw student performance data against the standard. Your output MUST strictly follow the JSON schema. Be flexible: if raw student names/IDs or specific error patterns are not found, use 'N/A' in the corresponding fields. Your ultimate goal is to provide concise, actionable remediation steps for the teacher. The standard's context is: [${fullStandardText}].`;
                
                const user = `Analyze the following raw performance data for the standard ${standardCode} (Grade ${gradeLevel}):\n\nRaw Data:\n${rawData}\n\nProvide the required mastery band, findings, and pedagogical recommendations.`;

                return {
                    system: system,
                    user: user
                };
            }

            function renderAnalysisReport(data, standardCode) {
                const getCardClass = (band) => {
                    if (band === 'High Mastery') return 'bg-green-100 text-green-800 border-green-500';
                    if (band === 'Proficient') return 'bg-indigo-100 text-indigo-800 border-indigo-500';
                    if (band === 'Developing') return 'bg-yellow-100 text-yellow-800 border-yellow-500';
                    return 'bg-red-100 text-red-800 border-red-500';
                };

                const dashboardHtml = `
                    <div class="p-4 rounded-xl border-l-4 ${getCardClass(data.masteryBand.band)}">
                        <p class="text-sm font-medium">Overall Class Mastery Band</p>
                        <p class="text-3xl font-bold">${data.masteryBand.band}</p>
                        <p class="mt-1">${data.masteryBand.summary}</p>
                        <p class="text-xs mt-2">Approximate Average Score: ${data.masteryBand.score}</p>
                    </div>
                    <div class="p-4 rounded-xl bg-gray-100 border-l-4 border-gray-400 md:col-span-2">
                        <p class="text-sm font-medium text-gray-700">Standard Analyzed</p>
                        <p class="text-lg font-bold">${standardCode}</p>
                        <p class="text-xs mt-1 text-gray-600">Grade ${gradeSelect.value} - Subject ${subjectSelect.value}</p>
                    </div>
                `;

                masteryDashboard.innerHTML = dashboardHtml;
                analysisOutput.classList.remove('hidden');

                aiInsights.innerHTML = `
                    <div class="p-5 border border-gray-200 rounded-xl">
                        <h4 class="text-lg font-bold text-gray-800 mb-2">General Pedagogical Findings</h4>
                        <p class="text-gray-700">${data.generalInsights}</p>
                    </div>
                    <div class="p-5 border border-gray-200 rounded-xl">
                        <h4 class="text-lg font-bold text-gray-800 mb-2">Specific Class Deficits (Fuzzy Concepts/Variations)</h4>
                        <p class="text-gray-700">${data.classFindings}</p>
                    </div>
                    <div class="p-5 border border-gray-200 rounded-xl">
                        <h4 class="text-lg font-bold text-gray-800 mb-2">Actionable Remediation Recommendations</h4>
                        <p class="text-gray-700">${data.pedagogicalRecommendations}</p>
                    </div>
                    <div class="p-5 border border-gray-200 rounded-xl">
                        <h4 class="text-lg font-bold text-red-700 mb-2">Individual Intervention Flags</h4>
                        <p class="text-red-700">${data.individualFlags}</p>
                    </div>
                `;
            }


            // --- Main Event Handler (Content Generator) ---

            generateButton.addEventListener('click', async () => {
                if (!firebaseReady) { errorMessageElement.textContent = 'ERROR: Secure session not active.'; errorMessageElement.classList.remove('hidden'); return; }
                const standardCode = standardSelect.value;
                const subject = subjectSelect.value;
                const gradeLevel = gradeSelect.value;
                const format = formatSelect.value;
                const level = levelSelect.value;
                const count = parseInt(countSelect.value);

                if (!standardCode || standardCode === "" || standardCode === "PLACEHOLDER") { errorMessageElement.textContent = 'Please select a standard code.'; errorMessageElement.classList.remove('hidden'); return; }

                storyContent.innerHTML = '';
                assignmentContent.innerHTML = '';
                errorMessageElement.classList.add('hidden');
                outputCard.classList.remove('hidden');
                loadingIndicator.classList.remove('hidden');
                generateButton.disabled = true;
                generateButton.textContent = 'Generating... (Step 1 of 2: Story)';

                try {
                    const fullStandardText = getFullStandardText(standardCode, subject);
                    const storyInstructions = getStoryPrompt(standardCode, level, gradeLevel, fullStandardText); 
                    
                    let storyPayload = {
                        contents: [{ parts: [{ text: storyInstructions.user }] }],
                        systemInstruction: { parts: [{ text: storyInstructions.system }] }
                    };

                    let response = await fetchWithRetries(API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(storyPayload)
                    });

                    let result = await response.json();
                    let storyText = result.candidates?.[0]?.content?.parts?.[0]?.text || "Error: Could not generate narrative context.";
                    renderStory(storyText, level);

                    generateButton.textContent = 'Generating... (Step 2 of 2: Assignment)';

                    const { payload } = getPayloadAndSchema(standardCode, format, level, count, gradeLevel, fullStandardText); 

                    response = await fetchWithRetries(API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    result = await response.json();
                    const jsonString = result.candidates?.[0]?.content?.parts?.[0]?.text;

                    if (!jsonString) {
                        throw new Error("Model failed to return structured JSON for the assignment.");
                    }

                    const assignmentData = JSON.parse(jsonString);
                    renderAssignment(assignmentData, format);

                } catch (error) {
                    console.error("Gemini API Error:", error);
                    errorMessageElement.textContent = `Error generating content: ${error.message}. Ensure inputs are correct.`;
                    errorMessageElement.classList.remove('hidden');
                } finally {
                    loadingIndicator.classList.add('hidden');
                    generateButton.disabled = false;
                    generateButton.textContent = 'Generate Differentiated Content';
                }
            });

            // --- Main Event Handler (Data Analyzer) ---
            analyzeButton.addEventListener('click', async () => {
                if (!firebaseReady) {
                    errorMessageElement.textContent = 'ERROR: Secure session not active. Analysis is disabled.';
                    errorMessageElement.classList.remove('hidden');
                    return;
                }
                
                const standardCode = standardSelect.value;
                const gradeLevel = gradeSelect.value;
                const rawData = rawDataInput.value.trim();

                if (!standardCode || standardCode === "" || !rawData) {
                    errorMessageElement.textContent = 'Please select a standard code AND paste raw performance data.';
                    errorMessageElement.classList.remove('hidden');
                    return;
                }
                
                // Clear content section and show loading
                analysisOutput.classList.add('hidden');
                outputCard.classList.remove('hidden');
                loadingIndicator.classList.remove('hidden');
                analyzeButton.disabled = true;
                analyzeButton.textContent = 'Analyzing Data...';

                try {
                    const fullStandardText = getFullStandardText(standardCode, subjectSelect.value);
                    const prompt = getAnalysisPrompt(standardCode, gradeLevel, fullStandardText, rawData);

                    const analysisPayload = {
                        contents: [{ parts: [{ text: prompt.user }] }],
                        systemInstruction: { parts: [{ text: prompt.system }] },
                        generationConfig: {
                            responseMimeType: "application/json",
                            responseSchema: analysisSchema
                        }
                    };

                    const response = await fetchWithRetries(API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(analysisPayload)
                    });

                    const result = await response.json();
                    const jsonString = result.candidates?.[0]?.content?.parts?.[0]?.text;

                    if (!jsonString) {
                        throw new Error("Model failed to return structured JSON for the analysis.");
                    }

                    const analysisData = JSON.parse(jsonString);
                    renderAnalysisReport(analysisData, standardCode);

                } catch (error) {
                    console.error("Gemini API Error (Analysis):", error);
                    errorMessageElement.textContent = `Error during analysis: ${error.message}. Check network and data format.`;
                    errorMessageElement.classList.remove('hidden');
                } finally {
                    loadingIndicator.classList.add('hidden');
                    analyzeButton.disabled = false;
                    analyzeButton.textContent = 'Analyze Data & Generate Report';
                }
            });
            
            // Start the initialization process
            initializeFirebase();
        });
    </script>
</body>
</html>
