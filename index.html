<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Standards Differentiated Content Generator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, query, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        // Export necessary functions globally for use in the main script block
        window.firebaseExports = { initializeApp, getAuth, signInAnonymously, signInWithCustomToken, getFirestore, doc, setDoc, getDoc, collection, query, onSnapshot };
    </script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .card { box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05); }
        .assignment-output { line-height: 1.6; }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-top-color: #3b82f6;
            border-radius: 50%;
            width: 2rem;
            height: 2rem;
            animation: spin 1s ease-in-out infinite;
        }
        /* Custom styling for dropdown appearance */
        select, input[type="file"] {
            appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 20' fill='none' stroke='%234b5563'%3e%3cpath d='M7 7l3 3 3-3' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round'/%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 0.75rem center;
            background-size: 1.5em 1.5em;
        }
    </style>
</head>
<body class="p-4 sm:p-8 min-h-screen">

    <div id="app-container" class="max-w-4xl mx-auto space-y-8 hidden">
        <header class="text-center">
            <h1 class="text-4xl font-extrabold text-gray-900 mb-2">FL Standards Differentiation Tool</h1>
            <p class="text-gray-600">Generate level-differentiated assignments and data insights.</p>
        </header>

        <div class="flex border-b border-gray-200">
            <button id="tab-content" class="px-4 py-2 text-sm font-medium border-r border-gray-200 text-white bg-indigo-600 rounded-tl-lg hover:bg-indigo-700 transition">Content Generator</button>
            <button id="tab-data" class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 rounded-tr-lg hover:bg-gray-200 transition">Data Analyzer</button>
        </div>

        <div id="section-content" class="card bg-white p-6 rounded-b-xl border-t-4 border-indigo-500">
            <h2 class="text-2xl font-semibold text-gray-800 mb-6">Assignment Creation Parameters</h2>

            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">

                <div class="lg:col-span-3">
                    <label for="standards-file" class="block text-sm font-semibold text-indigo-700 mb-1">1. Standards File (JSON Upload)</label>
                    <input type="file" id="standards-file" accept=".json" class="w-full text-gray-700 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100">
                    <p id="file-status" class="mt-2 text-sm text-red-500 font-medium"></p>
                </div>

                <div>
                    <label for="subject-select" class="block text-sm font-semibold text-indigo-700 mb-1">2. Select Subject</label>
                    <select id="subject-select" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 text-gray-700 bg-white">
                        <option value="Civics">Civics</option>
                        <option value="USHistory">U.S. History</option>
                        <option value="WorldHistory">World History</option>
                        <option value="ELA">ELA</option>
                        <option value="Math">Math</option>
                    </select>
                </div>

                <div>
                    <label for="grade-select" class="block text-sm font-semibold text-indigo-700 mb-1">3. Select Grade Level</label>
                    <select id="grade-select" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 text-gray-700 bg-white">
                        <option value="6th Grade">6th Grade</option>
                        <option value="7th Grade">7th Grade</option>
                        <option value="8th Grade">8th Grade</option>
                    </select>
                </div>

                <div>
                    <label for="standard-select" class="block text-sm font-semibold text-indigo-700 mb-1">4. Select Standard Code</label>
                    <select id="standard-select" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 text-gray-700 bg-white">
                        <option value="" disabled selected>Upload file to load standards</option>
                    </select>
                </div>

                <div>
                    <label for="format-select" class="block text-sm font-semibold text-indigo-700 mb-1">5. Select Format</label>
                    <select id="format-select" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 text-gray-700 bg-white">
                        <option value="MCQ">Multiple Choice Quiz (MCQ)</option>
                        <option value="ConceptMap">Concept to Definition Map</option>
                        <option value="TDQs">Short Story with TDQs (FAST Style)</option>
                        <option value="Mixed">Mixed MCQ & Longer Questions</option>
                    </select>
                </div>

                <div>
                    <label for="level-select" class="block text-sm font-semibold text-indigo-700 mb-1">6. Select Differentiation Level</label>
                    <select id="level-select" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 text-gray-700 bg-white">
                        <option value="On-Level">On-Level</option>
                        <option value="Developing">Developing (DOK 1/2)</option>
                        <option value="Advanced">Advanced (DOK 3/4)</option>
                        <option value="ELL">ELL (Minimal Text/Visual Aids)</option>
                    </select>
                </div>

                <div>
                    <label for="question-count" class="block text-sm font-semibold text-indigo-700 mb-1">7. Item Count</label>
                    <select id="question-count" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 text-gray-700 bg-white">
                        <option value="5">5 Questions/Concepts</option>
                        <option value="10">10 Questions/Concepts</option>
                        <option value="15">15 Questions/Concepts</option>
                    </select>
                </div>
            </div>

            <button id="generate-button"
                class="w-full mt-8 bg-indigo-600 text-white font-bold py-3 rounded-lg hover:bg-indigo-700 transition duration-150 shadow-lg text-lg" disabled>
                Initializing Secure Session...
            </button>
        </div>

        <div id="section-data" class="card bg-white p-6 rounded-b-xl border-t-4 border-indigo-500 hidden">
            <h2 class="text-2xl font-semibold text-gray-800 mb-6">Pedagogical Data Analyzer</h2>

            <div class="space-y-4">
                <p class="text-sm text-gray-600">Analyze performance by selecting a standard and pasting raw test data below (e.g., student ID, score, common errors, etc., from CSV/Excel). Data will be analyzed against the selected standard to provide insights.</p>

                <div>
                    <label for="raw-data-input" class="block text-sm font-semibold text-indigo-700 mb-1">Raw Performance Data (Paste CSV/Excel Data Here)</label>
                    <textarea id="raw-data-input" rows="8" placeholder="Paste data here. Format: Student ID, Student Name, Score, Errors/Variations..." class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 text-gray-700"></textarea>
                </div>
            </div>

            <button id="analyze-button"
                class="w-full mt-6 bg-green-600 text-white font-bold py-3 rounded-lg hover:bg-green-700 transition duration-150 shadow-lg text-lg" disabled>
                Analyze Data & Generate Report
            </button>

            <div id="analysis-output" class="mt-8 space-y-6 hidden">
                <h3 class="text-xl font-semibold text-gray-800 border-b pb-2">Analysis Results</h3>

                <div id="mastery-dashboard" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    </div>

                <div id="ai-insights" class="space-y-6">
                    </div>
            </div>
        </div>

        <div id="output-card" class="card bg-white p-6 rounded-xl border-t-4 border-indigo-500 hidden">

            <div id="loading-indicator" class="flex justify-center items-center py-10 hidden">
                <div class="spinner mr-3"></div>
                <p class="text-lg text-indigo-600">Generating content... please wait. (This requires two API calls.)</p>
            </div>

            <div id="story-content" class="mb-8">
                <h2 class="text-2xl font-semibold text-gray-800 mb-3 border-b pb-2">The Friendly Nag (Story & Context)</h2>
                </div>

            <div id="assignment-output">
                <h2 class="text-2xl font-semibold text-gray-800 mb-3 border-b pb-2">Assignment Output</h2>
                <div id="assignment-content" class="assignment-output space-y-6">
                    </div>
            </div>

            <div id="error-message" class="text-red-600 font-medium mt-6 hidden"></div>
        </div>
    </div>

    <div id="initialization-status" class="fixed top-0 left-0 m-4 p-2 bg-indigo-500 text-white text-xs rounded shadow-lg">Initializing...</div>

    <script>
        // --- CRITICAL FIX: All initialization is wrapped in DOMContentLoaded listener ---
        window.addEventListener('DOMContentLoaded', () => {

            // --- API Configuration ---
            const API_KEY = ""; // Placeholder for injection from the environment
            const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${API_KEY}`;
            let loadedStandardsData = {}; // Stores standards loaded from Firestore
            let appId = 'default-app-id'; 
            
            // --- STANDARDS IMPORT: Hardcoded data for initial load and stability ---
            // NOTE: This data is used immediately to populate the dropdowns.
            const initialStandardsImport = {
                "Civics": [
                    {"code": "SS.7.CG.1.1", "desc": "Ancient Influences on Republic", "full_text": "Standard: Analyze the influences of ancient Greece, ancient Rome and the Judeo-Christian tradition on America's constitutional republic. Clarifications: Students will explain the influence of ancient Greece (e.g., civic participation, legislative bodies, voting rights, written constitution); ancient Rome (e.g., republicanism, rule of law, separation of powers); and Judeo-Christian ethics (justice, individual worth)."},
                    {"code": "SS.7.CG.1.10", "desc": "Federalists vs. Anti-Federalists", "full_text": "Compare the viewpoints of the Federalists and the Anti-Federalists regarding ratification of the U.S. Constitution and including a bill of rights. Clarifications: Identify arguments for a strong central government (Federalists) vs. demand for a Bill of Rights (Anti-Federalists)."},
                    {"code": "SS.7.CG.1.11", "desc": "Define Rule of Law", "full_text": "Define the rule of law and recognize its influence on the development of legal, political and governmental systems in the United States. Clarifications: Contrast characteristics of a society with the rule of law vs. one without. Assess importance of due process."},
                    {"code": "SS.7.CG.1.9", "desc": "Separation of Powers/Checks", "full_text": "Describe how the U.S. Constitution limits the powers of government through separation of powers, checks and balances, individual rights, rule of law and due process of law. Clarifications: Distinguish between separation of powers (three distinct jobs) and checks and balances (each branch limits the others)."}
                ],
                "USHistory": [
                    {"code": "SS.68.AA.1.1", "desc": "Afro-Eurasian trade pre-Atlantic slave trade", "full_text": "Identify Afro-Eurasian trade routes and methods prior to the development of the Atlantic slave trade. Instruction includes how slavery was utilized in Asian, European and African cultures and the similarities and differences between serfdom and slavery."},
                    {"code": "SS.68.AA.1.3", "desc": "Indentured Servitude Evolution", "full_text": "Examine the evolution of the labor force in the use of indentured servitude contracts. Instruction includes the comparative treatment of indentured servants of European and African extraction and the transition from an indentured to a slave-based economy."}
                ],
                "ELA": [
                    {"code": "ELA.7.R.1.3", "desc": "Explain influence of narrator/POV", "full_text": "Explain the influence of narrator(s), including unreliable narrator(s), and/or shifts in point of view in a literary text. Clarifications: Unreliable narrator lacks credibility; shifts in point of view change perspective for effect."},
                    {"code": "ELA.6.C.1.3", "desc": "Write and support a claim", "full_text": "Write and support a claim using logical reasoning, relevant evidence from multiple sources, elaboration, and a logical organizational structure with varied transitions."}
                ],
                "Math": [
                    {"code": "MA.7.AR.3.4", "desc": "Solving Equations/Inequalities", "full_text": "Write and solve linear two-step equations and inequalities in one variable."},
                    {"code": "MA.6.GR.1.1", "desc": "Area of Polygons", "full_text": "Find the area of polygons by decomposing them into triangles and rectangles."}
                ],
                "WorldHistory": [
                    {"code": "SS.6.W.2.1", "desc": "Ancient River Civilizations", "full_text": "Describe the main characteristics and beliefs of major river valley civilizations (Mesopotamia, Egypt, Indus, China)."},
                    {"code": "SS.6.W.3.5", "desc": "European Middle Ages", "full_text": "Analyze the causes and effects of the feudal system and the role of the Catholic Church during the European Middle Ages."}
                ]
            };


            // --- DOM Elements ---
            const appContainer = document.getElementById('app-container');
            const subjectSelect = document.getElementById('subject-select');
            const gradeSelect = document.getElementById('grade-select');
            const standardSelect = document.getElementById('standard-select');
            const formatSelect = document.getElementById('format-select');
            const levelSelect = document.getElementById('level-select');
            const countSelect = document.getElementById('question-count');
            const generateButton = document.getElementById('generate-button');
            const analyzeButton = document.getElementById('analyze-button');
            const outputCard = document.getElementById('output-card');
            const loadingIndicator = document.getElementById('loading-indicator');
            const storyContent = document.getElementById('story-content');
            const assignmentContent = document.getElementById('assignment-content');
            const errorMessageElement = document.getElementById('error-message');
            const standardsFile = document.getElementById('standards-file');
            const fileStatus = document.getElementById('file-status');
            const initStatus = document.getElementById('initialization-status');
            
            // Tab Elements
            const tabContent = document.getElementById('tab-content');
            const tabData = document.getElementById('tab-data');
            const sectionContent = document.getElementById('section-content');
            const sectionData = document.getElementById('section-data');
            const rawDataInput = document.getElementById('raw-data-input');
            const analysisOutput = document.getElementById('analysis-output');
            const masteryDashboard = document.getElementById('mastery-dashboard');
            const aiInsights = document.getElementById('ai-insights');


            // --- Tab Switching Logic ---
            function switchTab(target) {
                if (target === 'content') {
                    sectionContent.classList.remove('hidden');
                    sectionData.classList.add('hidden');
                    tabContent.classList.replace('bg-gray-100', 'bg-indigo-600');
                    tabContent.classList.replace('text-gray-700', 'text-white');
                    tabData.classList.replace('bg-indigo-600', 'bg-gray-100');
                    tabData.classList.replace('text-white', 'text-gray-700');
                } else {
                    sectionContent.classList.add('hidden');
                    sectionData.classList.remove('hidden');
                    tabData.classList.replace('bg-gray-100', 'bg-indigo-600');
                    tabData.classList.replace('text-gray-700', 'text-white');
                    tabContent.classList.replace('bg-indigo-600', 'bg-gray-100');
                    tabContent.classList.replace('text-white', 'text-gray-700');
                }
                outputCard.classList.add('hidden'); 
                errorMessageElement.classList.add('hidden');
            }

            tabContent.addEventListener('click', () => switchTab('content'));
            tabData.addEventListener('click', () => switchTab('data'));
            

            // --- Firebase Setup (Mandatory and Secure) ---
            let db, auth, userId;
            let firebaseReady = false;

            async function initializeFirebase() {
                try {
                    const config = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
                    const token = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                    const envAppId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                    appId = envAppId; 

                    if (!window.firebaseExports || !config) {
                        throw new Error("Missing secure configuration (Firebase globals). Deployment required.");
                    }

                    const { initializeApp, getAuth, signInWithCustomToken, signInAnonymously, getFirestore } = window.firebaseExports;

                    const app = initializeApp(config);
                    db = getFirestore(app);
                    auth = getAuth(app);

                    initStatus.textContent = "Authenticating...";

                    if (token) {
                        await signInWithCustomToken(auth, token);
     
