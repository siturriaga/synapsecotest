<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Standards Differentiated Content Generator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, query, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        // Export necessary functions globally for use in the main script block
        window.firebaseExports = { initializeApp, getAuth, signInAnonymously, signInWithCustomToken, getFirestore, doc, setDoc, getDoc, collection, query, onSnapshot };
    </script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .card { box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05); }
        .assignment-output { line-height: 1.6; }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-top-color: #3b82f6;
            border-radius: 50%;
            width: 2rem;
            height: 2rem;
            animation: spin 1s ease-in-out infinite;
        }
        /* Custom styling for dropdown appearance */
        select, input[type="file"] {
            appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 20' fill='none' stroke='%234b5563'%3e%3cpath d='M7 7l3 3 3-3' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round'/%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 0.75rem center;
            background-size: 1.5em 1.5em;
        }
    </style>
</head>
<body class="p-4 sm:p-8 min-h-screen">

    <div id="app-container" class="max-w-4xl mx-auto space-y-8 hidden">
        <header class="text-center">
            <h1 class="text-4xl font-extrabold text-gray-900 mb-2">FL Standards Differentiation Tool</h1>
            <p class="text-gray-600">Generate level-differentiated assignments and data insights.</p>
        </header>

        <div class="flex border-b border-gray-200">
            <button id="tab-content" class="px-4 py-2 text-sm font-medium border-r border-gray-200 text-white bg-indigo-600 rounded-tl-lg hover:bg-indigo-700 transition">Content Generator</button>
            <button id="tab-data" class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 rounded-tr-lg hover:bg-gray-200 transition">Data Analyzer</button>
        </div>

        <div id="section-content" class="card bg-white p-6 rounded-b-xl border-t-4 border-indigo-500">
            <h2 class="text-2xl font-semibold text-gray-800 mb-6">Assignment Creation Parameters</h2>

            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">

                <div class="lg:col-span-3">
                    <label for="standards-file" class="block text-sm font-semibold text-indigo-700 mb-1">1. Standards File (JSON Upload)</label>
                    <input type="file" id="standards-file" accept=".json" class="w-full text-gray-700 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100">
                    <p id="file-status" class="mt-2 text-sm text-red-500 font-medium"></p>
                </div>

                <div>
                    <label for="subject-select" class="block text-sm font-semibold text-indigo-700 mb-1">2. Select Subject</label>
                    <select id="subject-select" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 text-gray-700 bg-white">
                        <option value="Civics">Civics</option>
                        <option value="USHistory">U.S. History</option>
                        <option value="WorldHistory">World History</option>
                        <option value="ELA">ELA</option>
                        <option value="Math">Math</option>
                    </select>
                </div>

                <div>
                    <label for="grade-select" class="block text-sm font-semibold text-indigo-700 mb-1">3. Select Grade Level</label>
                    <select id="grade-select" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 text-gray-700 bg-white">
                        <option value="6th Grade">6th Grade</option>
                        <option value="7th Grade">7th Grade</option>
                        <option value="8th Grade">8th Grade</option>
                    </select>
                </div>

                <div>
                    <label for="standard-select" class="block text sm font-semibold text-indigo-700 mb-1">4. Select Standard Code</label>
                    <select id="standard-select" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 text-gray-700 bg-white">
                        <option value="" disabled selected>Upload file to load standards</option>
                    </select>
                </div>

                <div>
                    <label for="format-select" class="block text-sm font-semibold text-indigo-700 mb-1">5. Select Format</label>
                    <select id="format-select" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 text-gray-700 bg-white">
                        <option value="MCQ">Multiple Choice Quiz (MCQ)</option>
                        <option value="ConceptMap">Concept to Definition Map</option>
                        <option value="TDQs">Short Story with TDQs (FAST Style)</option>
                        <option value="Mixed">Mixed MCQ & Longer Questions</option>
                    </select>
                </div>

                <div>
                    <label for="level-select" class="block text-sm font-semibold text-indigo-700 mb-1">6. Select Differentiation Level</label>
                    <select id="level-select" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 text-gray-700 bg-white">
                        <option value="On-Level">On-Level</option>
                        <option value="Developing">Developing (DOK 1/2)</option>
                        <option value="Advanced">Advanced (DOK 3/4)</option>
                        <option value="ELL">ELL (Minimal Text/Visual Aids)</option>
                    </select>
                </div>

                <div>
                    <label for="question-count" class="block text-sm font-semibold text-indigo-700 mb-1">7. Item Count</label>
                    <select id="question-count" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 text-gray-700 bg-white">
                        <option value="5">5 Questions/Concepts</option>
                        <option value="10">10 Questions/Concepts</option>
                        <option value="15">15 Questions/Concepts</option>
                    </select>
                </div>
            </div>

            <button id="generate-button"
                class="w-full mt-8 bg-indigo-600 text-white font-bold py-3 rounded-lg hover:bg-indigo-700 transition duration-150 shadow-lg text-lg" disabled>
                Initializing Secure Session...
            </button>
        </div>

        <div id="section-data" class="card bg-white p-6 rounded-b-xl border-t-4 border-indigo-500 hidden">
            <h2 class="text-2xl font-semibold text-gray-800 mb-6">Pedagogical Data Analyzer</h2>

            <div class="space-y-4">
                <p class="text-sm text-gray-600">Analyze performance by selecting a standard and pasting raw test data below (e.g., student ID, score, common errors, etc., from CSV/Excel). Data will be analyzed against the selected standard to provide insights.</p>

                <div>
                    <label for="raw-data-input" class="block text-sm font-semibold text-indigo-700 mb-1">Raw Performance Data (Paste CSV/Excel Data Here)</label>
                    <textarea id="raw-data-input" rows="8" placeholder="Paste data here. Format: Student ID, Student Name, Score, Errors/Variations..." class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 text-gray-700"></textarea>
                </div>
            </div>

            <button id="analyze-button"
                class="w-full mt-6 bg-green-600 text-white font-bold py-3 rounded-lg hover:bg-green-700 transition duration-150 shadow-lg text-lg" disabled>
                Analyze Data & Generate Report
            </button>

            <div id="analysis-output" class="mt-8 space-y-6 hidden">
                <h3 class="text-xl font-semibold text-gray-800 border-b pb-2">Analysis Results</h3>

                <div id="mastery-dashboard" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    </div>

                <div id="ai-insights" class="space-y-6">
                    </div>
            </div>
        </div>

        <div id="output-card" class="card bg-white p-6 rounded-xl border-t-4 border-indigo-500 hidden">

            <div id="loading-indicator" class="flex justify-center items-center py-10 hidden">
                <div class="spinner mr-3"></div>
                <p class="text-lg text-indigo-600">Generating content... please wait. (This requires two API calls.)</p>
            </div>

            <div id="story-content" class="mb-8">
                <h2 class="text-2xl font-semibold text-gray-800 mb-3 border-b pb-2">The Friendly Nag (Story & Context)</h2>
                </div>

            <div id="assignment-output">
                <h2 class="text-2xl font-semibold text-gray-800 mb-3 border-b pb-2">Assignment Output</h2>
                <div id="assignment-content" class="assignment-output space-y-6">
                    </div>
            </div>

            <div id="error-message" class="text-red-600 font-medium mt-6 hidden"></div>
        </div>
    </div>

    <div id="initialization-status" class="fixed top-0 left-0 m-4 p-2 bg-indigo-500 text-white text-xs rounded shadow-lg">Initializing...</div>

    <script>
        // --- CRITICAL FIX: All initialization is wrapped in DOMContentLoaded listener ---
        window.addEventListener('DOMContentLoaded', () => {

            // --- API Configuration ---
            const API_KEY = ""; // Placeholder for injection from the environment
            const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${API_KEY}`;
            let loadedStandardsData = {}; // Stores standards loaded from Firestore

            // --- STANDARDS IMPORT: User-Provided Curriculum Data ---
            const initialStandardsImport = {
                // ... (The full standards data block from the previous response is assumed to be here for brevity) ...
            };
            // NOTE: The full standards JSON for Civics, US History, and ELA is assumed to be copied here from the previous full response.

            // --- DOM Elements ---
            const appContainer = document.getElementById('app-container');
            const subjectSelect = document.getElementById('subject-select');
            const gradeSelect = document.getElementById('grade-select');
            const standardSelect = document.getElementById('standard-select');
            const formatSelect = document.getElementById('format-select');
            const levelSelect = document.getElementById('level-select');
            const countSelect = document.getElementById('question-count');
            const generateButton = document.getElementById('generate-button');
            const analyzeButton = document.getElementById('analyze-button'); // New
            const outputCard = document.getElementById('output-card');
            const loadingIndicator = document.getElementById('loading-indicator');
            const storyContent = document.getElementById('story-content');
            const assignmentContent = document.getElementById('assignment-content');
            const errorMessageElement = document.getElementById('error-message');
            const standardsFile = document.getElementById('standards-file');
            const fileStatus = document.getElementById('file-status');
            const initStatus = document.getElementById('initialization-status');
            
            // Tab Elements
            const tabContent = document.getElementById('tab-content');
            const tabData = document.getElementById('tab-data');
            const sectionContent = document.getElementById('section-content');
            const sectionData = document.getElementById('section-data');
            const rawDataInput = document.getElementById('raw-data-input');
            const analysisOutput = document.getElementById('analysis-output');
            const masteryDashboard = document.getElementById('mastery-dashboard');
            const aiInsights = document.getElementById('ai-insights');


            // --- Tab Switching Logic ---
            function switchTab(target) {
                if (target === 'content') {
                    sectionContent.classList.remove('hidden');
                    sectionData.classList.add('hidden');
                    tabContent.classList.replace('bg-gray-100', 'bg-indigo-600');
                    tabContent.classList.replace('text-gray-700', 'text-white');
                    tabData.classList.replace('bg-indigo-600', 'bg-gray-100');
                    tabData.classList.replace('text-white', 'text-gray-700');
                    outputCard.classList.add('hidden'); // Hide output when switching back
                } else {
                    sectionContent.classList.add('hidden');
                    sectionData.classList.remove('hidden');
                    tabData.classList.replace('bg-gray-100', 'bg-indigo-600');
                    tabData.classList.replace('text-gray-700', 'text-white');
                    tabContent.classList.replace('bg-indigo-600', 'bg-gray-100');
                    tabContent.classList.replace('text-white', 'text-gray-700');
                    outputCard.classList.add('hidden'); // Hide output when switching back
                }
                errorMessageElement.classList.add('hidden'); // Clear errors on switch
            }

            tabContent.addEventListener('click', () => switchTab('content'));
            tabData.addEventListener('click', () => switchTab('data'));
            

            // --- Firebase Setup (Mandatory and Secure) ---
            let db, auth, userId;
            let firebaseReady = false;

            async function initializeFirebase() {
                try {
                    const config = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
                    const token = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

                    if (!window.firebaseExports || !config) {
                        throw new Error("Missing secure configuration (Firebase globals). Deployment required.");
                    }

                    const { initializeApp, getAuth, signInWithCustomToken, signInAnonymously, getFirestore } = window.firebaseExports;

                    const app = initializeApp(config);
                    db = getFirestore(app);
                    auth = getAuth(app);

                    initStatus.textContent = "Authenticating...";

                    if (token) {
                        await signInWithCustomToken(auth, token);
                    } else {
                        await signInAnonymously(auth);
                    }
                    userId = auth.currentUser?.uid || 'anonymous-user';

                    loadedStandardsData = initialStandardsImport; // Load initial data immediately

                    setupStandardsListener(db, appId, userId);

                    firebaseReady = true;
                    initStatus.textContent = "Session Active";
                    appContainer.classList.remove('hidden');
                    generateButton.disabled = false;
                    analyzeButton.disabled = false; // Enable both buttons
                    generateButton.textContent = 'Generate Differentiated Content';
                    analyzeButton.textContent = 'Analyze Data & Generate Report';
                    populateStandardDropdown(); // Initial population now uses the integrated data

                } catch (e) {
                    console.error("SECURE INITIALIZATION FAILED:", e);
                    initStatus.textContent = "ERROR: Secure Session Failed.";
                    fileStatus.textContent = "SECURE ERROR: Content generation disabled. Please ensure all environment variables are correctly set.";
                    fileStatus.classList.replace('text-red-500', 'text-red-600');
                    generateButton.textContent = 'Initialization Failed';
                    analyzeButton.textContent = 'Initialization Failed';
                }
            }

            // --- File Management & Listeners ---
            function setupStandardsListener(db, appId, userId) {
                const { doc, onSnapshot } = window.firebaseExports;
                const standardsRef = doc(db, `artifacts/${appId}/users/${userId}/standards/current`);

                onSnapshot(standardsRef, (docSnap) => {
                    if (docSnap.exists() && docSnap.data().data) {
                        loadedStandardsData = JSON.parse(docSnap.data().data);
                        populateStandardDropdown();
                        fileStatus.textContent = `Standards loaded successfully from Firestore.`;
                        fileStatus.classList.replace('text-red-500', 'text-green-600');
                    } else {
                        populateStandardDropdown();
                        fileStatus.textContent = 'Using embedded standards data. Upload a file to save custom data.';
                        fileStatus.classList.replace('text-red-500', 'text-gray-500'); 
                    }
                }, (error) => {
                    console.error("Error listening to standards:", error);
                    fileStatus.textContent = 'Error loading standards from database.';
                });
            }

            async function saveStandardsToFirestore(jsonData) {
                if (!firebaseReady) return;

                try {
                    const { doc, setDoc } = window.firebaseExports;
                    const standardsRef = doc(db, `artifacts/${__app_id}/users/${userId}/standards/current`);
                    await setDoc(standardsRef, {
                        data: JSON.stringify(jsonData),
                        timestamp: new Date().toISOString()
                    });
                    console.log("Standards saved to Firestore.");
                } catch (e) {
                    console.error("Error saving standards:", e);
                    fileStatus.textContent = "Error saving file. Check console.";
                }
            }

            standardsFile.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (!file || !firebaseReady) {
                    fileStatus.textContent = 'Initialization required. Please wait for "Session Active" or check console.';
                    return;
                }

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const jsonData = JSON.parse(e.target.result);
                        if (typeof jsonData !== 'object' || Array.isArray(jsonData)) {
                             throw new Error("Invalid JSON structure. Must be an object of subjects.");
                        }
                        saveStandardsToFirestore(jsonData);
                    } catch (error) {
                        fileStatus.textContent = `File Error: ${error.message}`;
                        fileStatus.classList.replace('text-green-600', 'text-red-500');
                    }
                };
                reader.readAsText(file);
            });


            // --- Logic Block 1: Content Generator Functions ---
            
            function populateStandardDropdown() { /* ... (Same as previous populateStandardDropdown) ... */ }
            function getFullStandardText(standardCode, subject) { /* ... (Same as previous getFullStandardText) ... */ }
            function fetchWithRetries(url, options, maxRetries = 5) { /* ... (Same as previous fetchWithRetries) ... */ }
            function getStoryPrompt(standardCode, level, gradeLevel, fullStandardText) { /* ... (Same as previous getStoryPrompt) ... */ }
            function getAssignmentInstructions(standardCode, format, level, count, gradeLevel, fullStandardText) { /* ... (Same as previous getAssignmentInstructions) ... */ }
            
            // --- JSON Schemas (Content Generation) ---
            const quizSchema = (count) => ({ type: "OBJECT", properties: { quizTitle: { type: "STRING" }, level: { type: "STRING" }, questions: { type: "ARRAY", description: `Array of exactly ${count} multiple-choice questions.`, items: { type: "OBJECT", properties: { questionText: { type: "STRING" }, options: { type: "OBJECT", properties: { A: { type: "STRING" }, B: { type: "STRING" }, C: { type: "STRING" }, D: { type: "STRING" } }, required: ["A", "B", "C", "D"] }, correctAnswer: { type: "STRING" } }, required: ["questionText", "options", "correctAnswer"] } } }, required: ["quizTitle", "level", "questions"] });
            const conceptMapSchema = (count) => ({ type: "OBJECT", properties: { title: { type: "STRING" }, level: { type: "STRING" }, concepts: { type: "ARRAY", description: `Array of exactly ${count} core concepts and their differentiated definitions.`, items: { type: "OBJECT", properties: { concept: { type: "STRING" }, definition: { type: "STRING" }, }, required: ["concept", "definition"] } } }, required: ["title", "level", "concepts"] });
            const tdqSchema = (count) => ({ type: "OBJECT", properties: { assignmentTitle: { type: "STRING" }, level: { type: "STRING" }, story: { type: "STRING", description: "The full story/informational text generated for the TDQs." }, questions: { type: "ARRAY", description: `Array of exactly ${count} Text-Dependent Questions (TDQs).`, items: { type: "OBJECT", properties: { question: { type: "STRING" }, complexity: { type: "STRING", description: "DOK Level (1, 2, 3, or 4)." }, }, required: ["question", "complexity"] } } }, required: ["assignmentTitle", "level", "story", "questions"] });
            const mixedSchema = (count) => ({ type: "OBJECT", properties: { assignmentTitle: { type: "STRING" }, level: { type: "STRING" }, mcqs: { type: "ARRAY", description: `Array of exactly ${Math.floor(count / 2)} Multiple Choice Questions.`, items: { type: "OBJECT", properties: { questionText: { type: "STRING" }, options: { type: "OBJECT", properties: { A: { type: "STRING" }, B: { type: "STRING" }, C: { type: "STRING" }, D: { type: "STRING" } }, required: ["A", "B", "C", "D"] }, correctAnswer: { type: "STRING" } }, required: ["questionText", "options", "correctAnswer"] } }, longerQuestions: { type: "ARRAY", description: `Array of exactly ${Math.ceil(count / 2)} short answer/open-ended questions.`, items: { type: "OBJECT", properties: { prompt: { type: "STRING" }, requiredLength: { type: "STRING", description: "e.g., 2-3 sentences or 1 paragraph." } }, required: ["prompt", "requiredLength"] } } }, required: ["assignmentTitle", "level", "mcqs", "longerQuestions"] });

            function getPayloadAndSchema(standardCode, format, level, count, gradeLevel, fullStandardText) { /* ... (Same as previous getPayloadAndSchema) ... */ }
            function renderStory(text, level) { /* ... (Same as previous renderStory) ... */ }
            function renderAssignment(data, format) { /* ... (Same as previous renderAssignment) ... */ }
            
            // --- Logic Block 2: Data Analyzer Functions ---

            // JSON Schema for Data Analysis (Mastery Bands and Insights)
            const analysisSchema = {
                type: "OBJECT",
                properties: {
                    masteryBand: {
                        type: "OBJECT",
                        description: "Overall class performance band.",
                        properties: {
                            band: { type: "STRING", enum: ["High Mastery", "Proficient", "Developing", "Needs Remediation"] },
                            score: { type: "STRING", description: "Approximate class average score (e.g., 78%)." },
                            summary: { type: "STRING", description: "One sentence summary of the status." }
                        },
                        required: ["band", "score", "summary"]
                    },
                    generalInsights: {
                        type: "STRING",
                        description: "General, high-level pedagogical findings for the class (1-2 paragraphs)."
                    },
                    classFindings: {
                        type: "STRING",
                        description: "Specific common errors, fuzzy concepts, or variations in student answers (1-2 paragraphs). Inject N/A if specific data is missing."
                    },
                    pedagogicalRecommendations: {
                        type: "STRING",
                        description: "Actionable, multi-step teaching strategies for remediation, customized to the found deficits (1-2 paragraphs)."
                    },
                    individualFlags: {
                        type: "STRING",
                        description: "Identifies 1-2 specific students (by name/ID if available) who need immediate intervention, based on lowest scores or unique error patterns. Inject N/A if specific student data is missing."
                    }
                },
                required: ["masteryBand", "generalInsights", "classFindings", "pedagogicalRecommendations", "individualFlags"]
            };

            function getAnalysisPrompt(standardCode, gradeLevel, fullStandardText, rawData) {
                const system = `You are a Master Pedagogical Data Analyst and Curriculum Consultant. Your task is to analyze the provided raw student performance data against the standard. Your output MUST strictly follow the JSON schema. Be flexible: if raw student names/IDs or specific error patterns are not found, use 'N/A' in the corresponding fields. Your ultimate goal is to provide concise, actionable remediation steps for the teacher. The standard's context is: [${fullStandardText}].`;
                
                const user = `Analyze the following raw performance data for the standard ${standardCode} (Grade ${gradeLevel}):\n\nRaw Data:\n${rawData}\n\nProvide the required mastery band, findings, and pedagogical recommendations.`;

                return {
                    system: system,
                    user: user
                };
            }

            function renderAnalysisReport(data, standardCode) {
                const getCardClass = (band) => {
                    if (band === 'High Mastery') return 'bg-green-100 text-green-800 border-green-500';
                    if (band === 'Proficient') return 'bg-indigo-100 text-indigo-800 border-indigo-500';
                    if (band === 'Developing') return 'bg-yellow-100 text-yellow-800 border-yellow-500';
                    return 'bg-red-100 text-red-800 border-red-500'; // Needs Remediation
                };

                const dashboardHtml = `
                    <div class="p-4 rounded-xl border-l-4 ${getCardClass(data.masteryBand.band)}">
                        <p class="text-sm font-medium">Overall Class Mastery Band</p>
                        <p class="text-3xl font-bold">${data.masteryBand.band}</p>
                        <p class="mt-1">${data.masteryBand.summary}</p>
                        <p class="text-xs mt-2">Approximate Average Score: ${data.masteryBand.score}</p>
                    </div>
                    <div class="p-4 rounded-xl bg-gray-100 border-l-4 border-gray-400 md:col-span-2">
                        <p class="text-sm font-medium text-gray-700">Standard Analyzed</p>
                        <p class="text-lg font-bold">${standardCode}</p>
                        <p class="text-xs mt-1 text-gray-600">Grade ${gradeSelect.value} - Subject ${subjectSelect.value}</p>
                    </div>
                `;

                masteryDashboard.innerHTML = dashboardHtml;
                analysisOutput.classList.remove('hidden');

                aiInsights.innerHTML = `
                    <div class="p-5 border border-gray-200 rounded-xl">
                        <h4 class="text-lg font-bold text-gray-800 mb-2">General Pedagogical Findings</h4>
                        <p class="text-gray-700">${data.generalInsights}</p>
                    </div>
                    <div class="p-5 border border-gray-200 rounded-xl">
                        <h4 class="text-lg font-bold text-gray-800 mb-2">Specific Class Deficits (Fuzzy Concepts/Variations)</h4>
                        <p class="text-gray-700">${data.classFindings}</p>
                    </div>
                    <div class="p-5 border border-gray-200 rounded-xl">
                        <h4 class="text-lg font-bold text-gray-800 mb-2">Actionable Remediation Recommendations</h4>
                        <p class="text-gray-700">${data.pedagogicalRecommendations}</p>
                    </div>
                    <div class="p-5 border border-gray-200 rounded-xl">
                        <h4 class="text-lg font-bold text-red-700 mb-2">Individual Intervention Flags</h4>
                        <p class="text-red-700">${data.individualFlags}</p>
                    </div>
                `;
            }


            // --- Main Event Handler ---

            generateButton.addEventListener('click', async () => {
                if (!firebaseReady) { /* ... (Error check) ... */ return; }
                const standardCode = standardSelect.value;
                if (!standardCode || standardCode === "" || standardCode === "PLACEHOLDER") { errorMessageElement.textContent = 'Please select a standard code.'; errorMessageElement.classList.remove('hidden'); return; }

                // --- Content Generation Logic (Same as previous working version) ---
            });

            analyzeButton.addEventListener('click', async () => {
                if (!firebaseReady) {
                    errorMessageElement.textContent = 'ERROR: Secure session not active. Analysis is disabled.';
                    errorMessageElement.classList.remove('hidden');
                    return;
                }
                
                const standardCode = standardSelect.value;
                const gradeLevel = gradeSelect.value;
                const rawData = rawDataInput.value.trim();

                if (!standardCode || !rawData) {
                    errorMessageElement.textContent = 'Please select a standard code AND paste raw performance data.';
                    errorMessageElement.classList.remove('hidden');
                    return;
                }
                
                // Clear content section and show loading
                analysisOutput.classList.add('hidden');
                outputCard.classList.remove('hidden');
                loadingIndicator.classList.remove('hidden');
                analyzeButton.disabled = true;
                analyzeButton.textContent = 'Analyzing Data...';

                try {
                    const fullStandardText = getFullStandardText(standardCode, subjectSelect.value);
                    const prompt = getAnalysisPrompt(standardCode, gradeLevel, fullStandardText, rawData);

                    const analysisPayload = {
                        contents: [{ parts: [{ text: prompt.user }] }],
                        systemInstruction: { parts: [{ text: prompt.system }] },
                        generationConfig: {
                            responseMimeType: "application/json",
                            responseSchema: analysisSchema
                        }
                    };

                    const response = await fetchWithRetries(API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(analysisPayload)
                    });

                    const result = await response.json();
                    const jsonString = result.candidates?.[0]?.content?.parts?.[0]?.text;

                    if (!jsonString) {
                        throw new Error("Model failed to return structured JSON for the analysis.");
                    }

                    const analysisData = JSON.parse(jsonString);
                    renderAnalysisReport(analysisData, standardCode);

                } catch (error) {
                    console.error("Gemini API Error (Analysis):", error);
                    errorMessageElement.textContent = `Error during analysis: ${error.message}. Check network and data format.`;
                    errorMessageElement.classList.remove('hidden');
                } finally {
                    loadingIndicator.classList.add('hidden');
                    analyzeButton.disabled = false;
                    analyzeButton.textContent = 'Analyze Data & Generate Report';
                }
            });
            
            // Start the initialization process
            initializeFirebase();
        });
    </script>
</body>
</html>
