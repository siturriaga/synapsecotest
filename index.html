<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Standards Differentiated Content Generator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Firebase Imports -->
    <script type="module">
        // Make firebase functions available globally on the window object
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        window.firebase = {
            initializeApp,
            getAuth,
            onAuthStateChanged,
            GoogleAuthProvider,
            signInWithPopup,
            signOut,
            getFirestore,
            doc,
            setDoc,
            onSnapshot
        };
    </script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .card { box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05); }
        .assignment-output { line-height: 1.6; white-space: pre-wrap; word-wrap: break-word; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-top-color: #3b82f6;
            border-radius: 50%;
            width: 2rem;
            height: 2rem;
            animation: spin 1s ease-in-out infinite;
        }
        select, input[type="file"], button {
            -webkit-tap-highlight-color: transparent;
        }
        select, input[type="file"] {
            appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 20' fill='none' stroke='%234b5563'%3e%3cpath d='M7 7l3 3 3-3' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round'/%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 0.75rem center;
            background-size: 1.5em 1.5em;
        }
        #app-container { display: none; } /* Hidden until auth is complete */
        #login-container { display: block; }
    </style>
</head>
<body class="p-4 sm:p-8 min-h-screen">

    <!-- Login Container (Visible First) -->
    <div id="login-container" class="max-w-md mx-auto text-center mt-20">
        <div class="card bg-white p-8 rounded-xl">
            <h1 class="text-3xl font-extrabold text-gray-900 mb-4">AI Curriculum Tool</h1>
            <p class="text-gray-600 mb-8">Please sign in with your Google account to continue.</p>
            <button id="login-button" class="w-full bg-blue-600 text-white font-bold py-3 rounded-lg hover:bg-blue-700 transition duration-150 shadow-lg text-lg flex items-center justify-center">
                <svg class="w-6 h-6 mr-3" fill="currentColor" viewBox="0 0 48 48">
                    <path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"></path>
                    <path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v8.51h12.8c-.57 2.8-2.3 5.31-4.79 7l7.98 6.19C45.02 37.95 48 31.85 48 24c0-.66-.05-1.31-.14-1.95h.12z"></path>
                    <path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24s.92 7.54 2.56 10.78l7.97-6.19z"></path>
                    <path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.98-6.19C30.01 37.8 27.23 38.5 24 38.5c-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"></path>
                    <path fill="none" d="M0 0h48v48H0z"></path>
                </svg>
                Sign in with Google
            </button>
            <p id="login-status" class="mt-4 text-sm text-gray-500"></p>
        </div>
    </div>

    <!-- Main App Container (Hidden) -->
    <div id="app-container" class="max-w-4xl mx-auto space-y-8">
        <header class="text-center">
            <h1 class="text-4xl font-extrabold text-gray-900 mb-2">FL Standards Differentiation Tool</h1>
            <div class="flex justify-between items-center max-w-lg mx-auto mt-2">
                <p class="text-gray-600" id="user-welcome">Welcome!</p>
                <button id="sign-out-button" class="px-3 py-1 text-sm font-medium text-indigo-600 bg-indigo-100 rounded-full hover:bg-indigo-200 transition">
                    Sign Out
                </button>
            </div>
        </header>

        <!-- Tabbed Interface -->
        <div class="flex border-b border-gray-200">
            <button id="tab-content" class="px-4 py-2 text-sm font-medium border-r border-gray-200 text-white bg-indigo-600 rounded-tl-lg hover:bg-indigo-700 transition">Content Generator</button>
            <button id="tab-data" class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 rounded-tr-lg hover:bg-gray-200 transition">Data Analyzer</button>
        </div>

        <!-- Tab Content 1: Content Generator -->
        <div id="section-content" class="card bg-white p-6 rounded-b-xl border-t-4 border-indigo-500">
            <h2 class="text-2xl font-semibold text-gray-800 mb-6">Assignment Creation Parameters</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <div class="lg:col-span-3">
                    <label for="standards-file" class="block text-sm font-semibold text-indigo-700 mb-1">1. Standards File (JSON Upload)</label>
                    <input type="file" id="standards-file" accept=".json" class="w-full text-gray-700 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100">
                    <p id="file-status" class="mt-2 text-sm text-red-500 font-medium"></p>
                </div>
                <div>
                    <label for="subject-select" class="block text-sm font-semibold text-indigo-700 mb-1">2. Select Subject</label>
                    <select id="subject-select" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 text-gray-700 bg-white"></select>
                </div>
                <div>
                    <label for="grade-select" class="block text-sm font-semibold text-indigo-700 mb-1">3. Select Grade Level</label>
                    <select id="grade-select" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 text-gray-700 bg-white">
                        <option value="6th Grade">6th Grade</option>
                        <option value="7th Grade">7th Grade</option>
                        <option value="8th Grade">8th Grade</option>
                    </select>
                </div>
                <div>
                    <label for="standard-select" class="block text-sm font-semibold text-indigo-700 mb-1">4. Select Standard Code</label>
                    <select id="standard-select" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 text-gray-700 bg-white">
                        <option value="" disabled selected>Upload file to load standards</option>
                    </select>
                </div>
                <div>
                    <label for="format-select" class="block text-sm font-semibold text-indigo-700 mb-1">5. Select Format</label>
                    <select id="format-select" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 text-gray-700 bg-white">
                        <option value="MCQ">Multiple Choice Quiz (MCQ)</option>
                        <option value="ConceptMap">Concept to Definition Map</option>
                        <option value="TDQs">Short Story with TDQs (FAST Style)</option>
                        <option value="Mixed">Mixed MCQ & Longer Questions</option>
                    </select>
                </div>
                <div>
                    <label for="level-select" class="block text-sm font-semibold text-indigo-700 mb-1">6. Select Differentiation Level</label>
                    <select id="level-select" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 text-gray-700 bg-white">
                        <option value="On-Level">On-Level</option>
                        <option value="Developing">Developing (DOK 1/2)</option>
                        <option value="Advanced">Advanced (DOK 3/4)</option>
                        <option value="ELL">ELL (Minimal Text/Visual Aids)</option>
                    </select>
                </div>
                <div>
                    <label for="question-count" class="block text-sm font-semibold text-indigo-700 mb-1">7. Item Count</label>
                    <select id="question-count" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 text-gray-700 bg-white">
                        <option value="5">5 Questions/Concepts</option>
                        <option value="10">10 Questions/Concepts</option>
                        <option value="15">15 Questions/Concepts</option>
                    </select>
                </div>
            </div>
            <button id="generate-button"
                class="w-full mt-8 bg-indigo-600 text-white font-bold py-3 rounded-lg hover:bg-indigo-700 transition duration-150 shadow-lg text-lg" disabled>
                Sign in to Generate
            </button>
        </div>

        <!-- Tab Content 2: Data Analyzer (Hidden) -->
        <div id="section-data" class="card bg-white p-6 rounded-b-xl border-t-4 border-indigo-500 hidden">
            <h2 class="text-2xl font-semibold text-gray-800 mb-6">Pedagogical Data Analyzer</h2>
            <div class="space-y-4">
                <p class="text-sm text-gray-600">Analyze performance by selecting a standard and pasting raw test data below (e.g., student ID, score, common errors, etc., from CSV/Excel). Data will be analyzed against the selected standard to provide insights.</p>
                <div>
                    <label for="raw-data-input" class="block text-sm font-semibold text-indigo-700 mb-1">Raw Performance Data (Paste CSV/Excel Data Here)</label>
                    <textarea id="raw-data-input" rows="8" placeholder="Paste data here. Format: Student ID, Student Name, Score, Errors/Variations..." class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 text-gray-700"></textarea>
                </div>
            </div>
            <button id="analyze-button"
                class="w-full mt-6 bg-green-600 text-white font-bold py-3 rounded-lg hover:bg-green-700 transition duration-150 shadow-lg text-lg" disabled>
                Sign in to Analyze
            </button>
        </div>

        <!-- Output Area (Shared) -->
        <div id="output-card" class="card bg-white p-6 rounded-xl border-t-4 border-indigo-500 hidden">
            <div id="loading-indicator" class="flex justify-center items-center py-10 hidden">
                <div class="spinner mr-3"></div>
                <p class="text-lg text-indigo-600">Generating content... please wait.</p>
            </div>
            <div id="story-content" class="mb-8"></div>
            <div id="assignment-output"></div>
            <div id="analysis-output" class="mt-8 space-y-6 hidden">
                <h3 class="text-xl font-semibold text-gray-800 border-b pb-2">Analysis Results</h3>
                <div id="mastery-dashboard" class="grid grid-cols-1 md:grid-cols-3 gap-4"></div>
                <div id="ai-insights" class="space-y-6"></div>
            </div>
            <div id="error-message" class="text-red-600 font-medium mt-6 hidden"></div>
        </div>
    </div>
    
    <!-- 
      FIX: This script is now at the BOTTOM of the body, so all HTML elements
      above it are guaranteed to exist when it runs. This eliminates all
      "Cannot read properties of null" errors.
    -->
    <script type="module">
        
        // --- 1. CONFIG (From config.js) ---
        
        // Secure Netlify function endpoint
        const API_URL = "/.netlify/functions/generate"; 
        
        // Firebase Configuration (Hardcoded for guaranteed launch)
        const firebaseConfig = {
            apiKey: "AIzaSyBT95w8fzJr9J5WCYe8iwFkvSrwXds5sms",
            authDomain: "trackopmn.firebaseapp.com",
            projectId: "trackopmn",
            storageBucket: "trackopmn.firebasestorage.app",
            messagingSenderId: "325895934431",
            appId: "1:325895934431:web:50665d95aab0ac1a4b746a",
            measurementId: "G-QX53NY1CJC"
        };
        
        // --- 2. CURRICULUM DATA (From curriculum.js) ---
        
        const initialStandardsImport = {
            "Civics": {
                "subject": "Civics", "grade": 7, "standards": [
                    {"code": "SS.7.CG.1.1", "desc": "Ancient Influences on Republic", "full_text": "Standard: Analyze the influences of ancient Greece, ancient Rome and the Judeo-Christian tradition on America's constitutional republic. Clarifications: Students will explain the influence of ancient Greece (e.g., civic participation, legislative bodies, voting rights, written constitution); ancient Rome (e.g., republicanism, rule of law, separation of powers); and Judeo-Christian ethics (justice, individual worth)."},
                    {"code": "SS.7.CG.1.10", "desc": "Federalists vs. Anti-Federalists", "full_text": "Compare the viewpoints of the Federalists and the Anti-Federalists regarding ratification of the U.S. Constitution and including a bill of rights. Clarifications: Identify arguments for a strong central government (Federalists) vs. demand for a Bill of Rights (Anti-Federalists)."},
                    {"code": "SS.7.CG.1.11", "desc": "Define Rule of Law", "full_text": "Define the rule of law and recognize its influence on the development of legal, political and governmental systems in the United States. Clarifications: Contrast characteristics of a society with the rule of law vs. one without. Assess importance of due process."},
                ]
            },
            "USHistory": {
                "subject": "U.S. History", "grade": 6, "standards": [
                    {"code": "SS.68.AA.1.1", "desc": "Afro-Eurasian trade pre-Atlantic slave trade", "full_text": "Identify Afro-Eurasian trade routes and methods prior to the development of the Atlantic slave trade. Instruction includes how slavery was utilized in Asian, European and African cultures and the similarities and differences between serfdom and slavery."},
                    {"code": "SS.68.AA.1.3", "desc": "Indentured Servitude Evolution", "full_text": "Examine the evolution of the labor force in the use of indentured servitude contracts. Instruction includes the comparative treatment of indentured servants of European and African extraction and the transition from an indentured to a slave-based economy."}
                ]
            },
            "ELA": {
                "subject": "ELA", "grade": 6, "standards": [
                    {"code": "ELA.7.R.1.3", "desc": "Explain influence of narrator/POV", "full_text": "Explain the influence of narrator(s), including unreliable narrator(s), and/or shifts in point of view in a literary text. Clarifications: Unreliable narrator lacks credibility; shifts in point of view change perspective for effect."},
                    {"code": "ELA.6.C.1.3", "desc": "Write and support a claim", "full_text": "Write and support a claim using logical reasoning, relevant evidence from multiple sources, elaboration, and a logical organizational structure with varied transitions."}
                ]
            },
            "Math": {
                "subject": "Math", "grade": 7, "standards": [
                    {"code": "MA.7.AR.3.4", "desc": "Solving Equations/Inequalities", "full_text": "Write and solve linear two-step equations and inequalities in one variable."},
                    {"code": "MA.6.GR.1.1", "desc": "Area of Polygons", "full_text": "Find the area of polygons by decomposing them into triangles and rectangles."}
                ]
            },
            "WorldHistory": {
                "subject": "World History", "grade": 6, "standards": [
                    {"code": "SS.6.W.2.1", "desc": "Ancient River Civilizations", "full_text": "Describe the main characteristics and beliefs of major river valley civilizations (Mesopotamia, Egypt, Indus, China)."}
                ]
            }
        };
        
        // --- 3. AI LOGIC (From ai_logic.js) ---
        
        // Schemas
        const quizSchema = (count) => ({ type: "OBJECT", properties: { quizTitle: { type: "STRING" }, level: { type: "STRING" }, questions: { type: "ARRAY", description: `Array of exactly ${count} multiple-choice questions.`, items: { type: "OBJECT", properties: { questionText: { type: "STRING" }, options: { type: "OBJECT", properties: { A: { type: "STRING" }, B: { type: "STRING" }, C: { type: "STRING" }, D: { type: "STRING" } }, required: ["A", "B", "C", "D"] }, correctAnswer: { type: "STRING" } }, required: ["questionText", "options", "correctAnswer"] } } }, required: ["quizTitle", "level", "questions"] });
        const conceptMapSchema = (count) => ({ type: "OBJECT", properties: { title: { type: "STRING" }, level: { type: "STRING" }, concepts: { type: "ARRAY", description: `Array of exactly ${count} core concepts and their differentiated definitions.`, items: { type: "OBJECT", properties: { concept: { type: "STRING" }, definition: { type: "STRING" }, }, required: ["concept", "definition"] } } }, required: ["title", "level", "concepts"] });
        const tdqSchema = (count) => ({ type: "OBJECT", properties: { assignmentTitle: { type: "STRING" }, level: { type: "STRING" }, story: { type: "STRING", description: "The full story/informational text generated for the TDQs." }, questions: { type: "ARRAY", description: `Array of exactly ${count} Text-Dependent Questions (TDQs).`, items: { type: "OBJECT", properties: { question: { type: "STRING" }, complexity: { type: "STRING", description: "DOK Level (1, 2, 3, or 4)." }, }, required: ["question", "complexity"] } } }, required: ["assignmentTitle", "level", "story", "questions"] });
        const mixedSchema = (count) => ({ type: "OBJECT", properties: { assignmentTitle: { type: "STRING" }, level: { type: "STRING" }, mcqs: { type: "ARRAY", description: `Array of exactly ${Math.floor(count / 2)} Multiple Choice Questions.`, items: { type: "OBJECT", properties: { questionText: { type: "STRING" }, options: { type: "OBJECT", properties: { A: { type: "STRING" }, B: { type: "STRING" }, C: { type: "STRING" }, D: { type: "STRING" } }, required: ["A", "B", "C", "D"] }, correctAnswer: { type: "STRING" } }, required: ["questionText", "options", "correctAnswer"] } }, longerQuestions: { type: "ARRAY", description: `Array of exactly ${Math.ceil(count / 2)} short answer/open-ended questions.`, items: { type: "OBJECT", properties: { prompt: { type: "STRING" }, requiredLength: { type: "STRING", description: "e.g., 2-3 sentences or 1 paragraph." } }, required: ["prompt", "requiredLength"] } } }, required: ["assignmentTitle", "level", "mcqs", "longerQuestions"] });
        const analysisSchema = {
            type: "OBJECT",
            properties: {
                masteryBand: {
                    type: "OBJECT",
                    description: "Overall class performance band.",
                    properties: {
                        band: { type: "STRING", enum: ["High Mastery", "Proficient", "Developing", "Needs Remediation"] },
                        score: { type: "STRING", description: "Approximate class average score (e.g., 78%)." },
                        summary: { type: "STRING", description: "One sentence summary of the status." }
                    },
                    required: ["band", "score", "summary"]
                },
                generalInsights: {
                    type: "STRING",
                    description: "General, high-level pedagogical findings for the class (1-2 paragraphs)."
                },
                classFindings: {
                    type: "STRING",
                    description: "Specific common errors, fuzzy concepts, or variations in student answers (1-2 paragraphs). Inject N/A if specific data is missing."
                },
                pedagogicalRecommendations: {
                    type: "STRING",
                    description: "Actionable, multi-step teaching strategies for remediation, customized to the found deficits (1-2 paragraphs)."
                },
                individualFlags: {
                    type: "STRING",
                    description: "Identifies 1-2 specific students (by name/ID if available) who need immediate intervention, based on lowest scores or unique error patterns. Inject N/A if specific data is missing."
                }
            },
            required: ["masteryBand", "generalInsights", "classFindings", "pedagogicalRecommendations", "individualFlags"]
        };

        // Prompts
        function getStoryPrompt(standardCode, level, gradeLevel, fullStandardText) { 
            let storyRules = "Generate a story (2-3 paragraphs) that explains the core concept of the standard.";
            let storyStyle = `You must write for a **${gradeLevel}** student. Use a nagging, yet supportive, tutor persona to transmit the information. Be culturally responsible.`;

            if (level === 'ELL') {
                storyRules = "Generate a story that explains the core concept of the standard. The narrative must be exactly 2-3 **very short, simple sentences** per paragraph, using the simplest vocabulary possible. Immediately after the story, provide a single sentence describing a simple picture or visual aid that the teacher should use to teach this concept (e.g., 'Visual Aid Suggestion: Picture of two kids sharing a cookie.').";
                storyStyle = `Use a supportive, encouraging tone. Use minimal to no complex English suitable for a **${gradeLevel}** ELL student. Bold key vocabulary words.`;
            }

            return {
                system: `You are a pedagogical expert and tutor. Follow these instructions precisely. The content must be 100% aligned to this standard's text: [${fullStandardText}]. You may use creative scenarios and examples if they benefit student academic understanding. ${storyStyle}`,
                user: `Based on the FL Standard ${standardCode}: ${storyRules}`
            };
        }

        function getAssignmentInstructions(standardCode, format, level, count, gradeLevel, fullStandardText) { 
            let assignmentType = "";
            let difficulty = "";
            const gradeInstruction = `The content must be appropriate for a **${gradeLevel}** student.`;

            switch (level) {
                case 'Advanced':
                    difficulty = "Generate questions/items at Depth of Knowledge (DOK) level 3 or 4, requiring synthesis, analysis, and evaluation. Use complex, academic vocabulary.";
                    break;
                case 'Developing':
                    difficulty = "Generate questions/items at Depth of Knowledge (DOK) level 1 or 2, focusing on recall, application, and basic understanding. Provide generous contextual clues.";
                    break;
                case 'ELL':
                    difficulty = "Generate questions/items using the absolute simplest grammar and vocabulary. Questions must be brief, short, and highly chunked. The focus is on basic identification.";
                    break;
                case 'On-Level':
                default:
                    difficulty = `Generate questions/items appropriate for a typical ${gradeLevel} student, balanced across DOK levels 2 and 3.`;
            }

            switch (format) {
                case 'MCQ':
                    assignmentType = `Generate a Multiple Choice Quiz with exactly ${count} questions. Each question must have four options (A, B, C, D) and a single correct answer.`;
                    break;
                case 'ConceptMap':
                    assignmentType = `Generate a list of exactly ${count} core concepts related to the standard. For each concept, provide a concise, differentiated definition (the 'Map' structure). No quiz questions.`;
                    break;
                case 'TDQs':
                    assignmentType = `Generate exactly ${count} Text-Dependent Questions (TDQs) based on the story/text. The TDQs MUST mirror the style of the FL FAST Reading Test, including multi-part questions or questions requiring evidence.`;
                    break;
                case 'Mixed':
                    const halfCount = Math.floor(count / 2);
                    assignmentType = `Generate a Mixed Assignment. It must contain ${halfCount} Multiple Choice Questions (A, B, C, D and a single correct answer) AND ${Math.ceil(count / 2)} longer Short Answer/Open-Ended Questions.`;
                    break;
            }

            return {
                system: `You are a pedagogical expert specializing in Florida B.E.S.T. Standards. ${gradeInstruction} The content must be 100% aligned to this standard's text: [${fullStandardText}]. You may use creative scenarios and examples if they benefit student academic understanding. Generate ${format} content based on the standard ${standardCode}. You MUST follow the JSON schema. Be culturally responsible. Differentiation: ${difficulty}`,
                user: `FL Standard: ${standardCode}. Task: ${assignmentType}`
            };
        }

        function getPayloadAndSchema(standardCode, format, level, count, gradeLevel, fullStandardText) { 
            const instructions = getAssignmentInstructions(standardCode, format, level, count, gradeLevel, fullStandardText);
            let schema;

            switch (format) {
                case 'MCQ': schema = quizSchema(count); break;
                case 'ConceptMap': schema = conceptMapSchema(count); break;
                case 'TDQs': schema = tdqSchema(count); break;
                case 'Mixed': schema = mixedSchema(count); break;
                default: throw new Error("Invalid format selected.");
            }

            return {
                payload: {
                    contents: [{ parts: [{ text: instructions.user }] }],
                    systemInstruction: { parts: [{ text: instructions.system }] },
                    generationConfig: {
                        responseMimeType: "application/json",
                        responseSchema: schema
                    }
                },
                schema: schema
            };
        }

        function getAnalysisPrompt(standardCode, gradeLevel, fullStandardText, rawData) {
            const system = `You are a Master Pedagogical Data Analyst and Curriculum Consultant. Your task is to analyze the provided raw student performance data against the standard. Your output MUST strictly follow the JSON schema. Be flexible: if raw student names/IDs or specific error patterns are not found, use 'N/A' in the corresponding fields. Your ultimate goal is to provide concise, actionable remediation steps for the teacher. The standard's context is: [${fullStandardText}].`;
            
            const user = `Analyze the following raw performance data for the standard ${standardCode} (Grade ${gradeLevel}):\n\nRaw Data:\n${rawData}\n\nProvide the required mastery band, findings, and pedagogical recommendations.`;

            return {
                system: system,
                user: user,
                schema: analysisSchema
            };
        }
        
        // --- 4. FIREBASE LOGIC (From firebase.js) ---
        
        let auth;
        let db;

        function initializeAuth() {
            const app = window.firebase.initializeApp(firebaseConfig);
            auth = window.firebase.getAuth(app);
            db = window.firebase.getFirestore(app);
        }

        function handleGoogleSignIn() {
            const provider = new window.firebase.GoogleAuthProvider();
            return window.firebase.signInWithPopup(auth, provider);
        }

        function handleSignOut() {
            return window.firebase.signOut(auth);
        }

        function setupAuthStateListener(onSuccess, onFailure) {
            window.firebase.onAuthStateChanged(auth, (user) => {
                if (user) {
                    onSuccess(user);
                } else {
                    onFailure();
                }
            });
        }

        function setupStandardsListener(userId, onUpdate) {
            const standardsRef = window.firebase.doc(db, `users/${userId}/standards/current`);

            window.firebase.onSnapshot(standardsRef, (docSnap) => {
                if (docSnap.exists() && docSnap.data().data) {
                    onUpdate(JSON.parse(docSnap.data().data));
                } else {
                    onUpdate(null); // No custom data
                }
            }, (error) => {
                console.error("Error listening to standards:", error);
                onUpdate(null);
            });
        }

        async function saveStandardsToFirestore(userId, jsonData) {
            try {
                const standardsRef = window.firebase.doc(db, `users/${userId}/standards/current`);
                await window.firebase.setDoc(standardsRef, {
                    data: JSON.stringify(jsonData),
                    timestamp: new Date().toISOString()
                });
                console.log("Standards saved to Firestore.");
            } catch (e) {
                console.error("Error saving standards:", e);
                DOMElements['file-status'].textContent = "Error saving file. Check console.";
            }
        }
        
        // --- 5. UI LOGIC (From ui.js) ---
        
        // FIX: This must be *declared* before it is used.
        const DOMElements = {};

        function cacheDOMElements() {
            const ids = [
                'app-container', 'subject-select', 'grade-select', 'standard-select', 
                'format-select', 'level-select', 'count-select', 'generate-button', 
                'analyze-button', 'output-card', 'loading-indicator', 'story-content', 
                'assignment-output', 'error-message', 'standards-file', 'file-status', 
                'login-container', 'login-button', 'login-status', 'user-welcome',
                'tab-content', 'tab-data', 'section-content', 'section-data', 
                'raw-data-input', 'analysis-output', 'mastery-dashboard', 'ai-insights',
                'sign-out-button'
            ];
            ids.forEach(id => {
                DOMElements[id] = document.getElementById(id);
            });
        }

        function switchTab(target) {
            if (target === 'content') {
                DOMElements['section-content'].classList.remove('hidden');
                DOMElements['section-data'].classList.add('hidden');
                DOMElements['tab-content'].classList.replace('bg-gray-100', 'bg-indigo-600');
                DOMElements['tab-content'].classList.replace('text-gray-700', 'text-white');
                DOMElements['tab-data'].classList.replace('bg-indigo-600', 'bg-gray-100');
                DOMElements['tab-data'].classList.replace('text-white', 'text-gray-700');
            } else {
                DOMElements['section-content'].classList.add('hidden');
                DOMElements['section-data'].classList.remove('hidden');
                DOMElements['tab-data'].classList.replace('bg-gray-100', 'bg-indigo-600');
                DOMElements['tab-data'].classList.replace('text-gray-700', 'text-white');
                DOMElements['tab-content'].classList.replace('bg-indigo-600', 'bg-gray-100');
                DOMElements['tab-content'].classList.replace('text-white', 'text-gray-700');
            }
            DOMElements['output-card'].classList.add('hidden'); 
            DOMElements['error-message'].classList.add('hidden');
        }

        function setLoadingState(isLoading, message = "Generating...") {
            if (isLoading) {
                DOMElements['loading-indicator'].classList.remove('hidden');
                DOMElements['loading-indicator'].querySelector('p').textContent = message;
                DOMElements['error-message'].classList.add('hidden');
                DOMElements['story-content'].innerHTML = '';
                DOMElements['assignment-output'].innerHTML = '';
                DOMElements['analysis-output'].classList.add('hidden');
                DOMElements['generate-button'].disabled = true;
                DOMElements['analyze-button'].disabled = true;
            } else {
                DOMElements['loading-indicator'].classList.add('hidden');
                DOMElements['generate-button'].disabled = false;
                DOMElements['analyze-button'].disabled = false;
                DOMElements['generate-button'].textContent = 'Generate Differentiated Content';
                DOMElements['analyze-button'].textContent = 'Analyze Data & Generate Report';
            }
        }

        function setErrorMessage(message) {
            DOMElements['error-message'].textContent = message;
            DOMElements['error-message'].classList.remove('hidden');
        }

        function populateSubjectDropdown(standardsData) {
            const subjectSelect = DOMElements['subject-select'];
            const currentSubject = subjectSelect.value;
            subjectSelect.innerHTML = ''; 
            
            Object.keys(standardsData).forEach(subject => {
                const option = document.createElement('option');
                option.value = subject;
                option.textContent = subject;
                subjectSelect.appendChild(option);
            });
            
            if (standardsData[currentSubject]) {
                subjectSelect.value = currentSubject;
            }
        }

        function populateStandardDropdown(standardsData, subject) {
            const standardSelect = DOMElements['standard-select'];
            standardSelect.innerHTML = '';
            standardSelect.disabled = true;

            const standardsList = (standardsData[subject] && standardsData[subject].standards) ? standardsData[subject].standards : [];
            
            if (standardsList.length > 0) {
                standardsList.forEach(std => {
                    const option = document.createElement('option');
                    option.value = std.code;
                    const desc = std.desc || std.name || 'No Description';
                    option.textContent = `${std.code}: ${desc.substring(0, 40)}...`;
                    standardSelect.appendChild(option);
                });
                standardSelect.disabled = false;
            } else {
                standardSelect.innerHTML = `<option value="" disabled selected>No standards for ${subject}</option>`;
            }
        }

        function renderStory(text, level) { 
            let formattedText = text;
            let title = "The Friendly Nag (Story & Context)";
            let visualAid = "";

            if (level === 'ELL') {
                const visualMatch = text.match(/Visual Aid Suggestion:\s*(.*)/i);
                if (visualMatch && visualMatch[1]) {
                    visualAid = `<p class="mt-4 p-3 border-l-4 border-yellow-500 bg-yellow-50 text-yellow-800">
                        <strong>Visual Aid Suggestion for Teacher:</strong> ${visualMatch[1].trim()}
                        <span class="block text-xs mt-1">(Use this simple picture to help explain the main idea with minimal language.)</span>
                    </p>`;
                    formattedText = text.replace(visualMatch[0], '').trim();
                }
                title = "The Friendly Nag (Simple ELL Narrative)";
            }

            DOMElements['story-content'].innerHTML = `
                <h3 class="text-xl font-semibold text-gray-800 mb-3">${title}</h3>
                <div class="p-4 rounded-lg bg-gray-50 text-gray-700">
                    ${formattedText.split('\n\n').map(p => `<p class="mb-2">${p}</p>`).join('')}
                    ${visualAid}
                </div>
    `;
        }

        function renderAssignment(data, format) { 
            const assignmentContent = DOMElements['assignment-output'];
            assignmentContent.innerHTML = '';
            let html = `<h3 class="text-xl font-semibold text-gray-800 mb-4">${data.assignmentTitle || data.title || format} <span class="text-sm font-medium text-indigo-500">(${data.level})</span></h3>`;

            const renderQuestionList = (questions, isLonger) => {
                return questions.map((q, index) => {
                    let optionsHtml = '';
                    let footerHtml = '';
                    const qIndex = isLonger ? index + 1 : index + 1;

                    if (q.options) {
                        optionsHtml = ['A', 'B', 'C', 'D'].map(key => `
                            <li class="p-3 mb-2 rounded-lg transition duration-100 border border-gray-200 ${q.correctAnswer === key ? 'bg-green-50' : ''}">
                                <span class="font-bold mr-2 text-indigo-600">${key}.</span>
                                ${q.options[key]}
                            </li>
                        `).join('');
                        footerHtml += `<p class="mt-3 text-sm font-medium text-green-700">Correct Answer: ${q.correctAnswer}</p>`;
                    } else if (q.requiredLength) {
                        footerHtml += `<p class="text-sm text-gray-500 mt-1">Required Length: ${q.requiredLength}</p>`;
                    }
                    
                    if (q.complexity) {
                        footerHtml += `<p class="text-sm text-gray-500 mt-1">Complexity: DOK ${q.complexity}</p>`;
                    }

                    return `
                        <div class="p-5 bg-white rounded-xl border border-gray-100 shadow-sm mb-4">
                            <p class="text-lg font-semibold text-gray-800 mb-3">${isLonger ? 'Prompt' : 'Question'} ${qIndex}: ${q.questionText || q.prompt || q.question}</p>
                            ${optionsHtml ? `<ul class="space-y-1 text-gray-700 text-sm list-none">${optionsHtml}</ul>` : ''}
                            ${footerHtml}
                        </div>
                    `;
                }).join('');
            };

            if (format === 'MCQ' && data.questions) {
                html += `<div class="space-y-6">${renderQuestionList(data.questions, false)}</div>`;
            }
            else if (format === 'ConceptMap' && data.concepts) {
                html += `<div class="grid grid-cols-1 md:grid-cols-2 gap-4">`;
                data.concepts.forEach((c, index) => {
                    html += `
                        <div class="p-5 bg-white rounded-xl border border-gray-100 shadow-sm">
                            <p class="text-lg font-bold text-indigo-700 mb-1">${index + 1}. ${c.concept}</p>
                            <p class="text-gray-700">${c.definition}</p>
                        </div>
                    `;
                });
                html += `</div>`;
            }
            else if (format === 'TDQs' && data.story && data.questions) {
                html += `<div class="p-5 bg-gray-50 rounded-xl mb-6">
                            <h4 class="text-lg font-bold mb-2 text-gray-800">Source Text:</h4>
                            <div class="text-gray-700 whitespace-pre-wrap">${data.story}</div>
                        </div>`;
                html += `<div class="space-y-6">${renderQuestionList(data.questions, false)}</div>`;
            }
            else if (format === 'Mixed' && data.mcqs && data.longerQuestions) {
                html += `<h4 class="text-xl font-bold mt-6 mb-4 text-gray-800">Multiple Choice Questions (Differentiated)</h4>`;
                html += renderQuestionList(data.mcqs, false);
                html += `<h4 class="text-xl font-bold mt-10 mb-4 text-gray-800">Short Answer/Extended Response (Differentiated)</h4>`;
                html += renderQuestionList(data.longerQuestions, true);
            }
            else {
                html = `<p class="text-red-500">Error: Could not render structured content.</p>`;
            }
            assignmentContent.innerHTML = html;
        }

        function renderAnalysisReport(data, standardCode) {
            const getCardClass = (band) => {
                if (band === 'High Mastery') return 'bg-green-100 text-green-800 border-green-500';
                if (band === 'Proficient') return 'bg-indigo-100 text-indigo-800 border-indigo-500';
                if (band === 'Developing') return 'bg-yellow-100 text-yellow-800 border-yellow-500';
                return 'bg-red-100 text-red-800 border-red-500';
            };

            DOMElements['mastery-dashboard'].innerHTML = `
                <div class="p-4 rounded-xl border-l-4 ${getCardClass(data.masteryBand.band)}">
                    <p class="text-sm font-medium">Overall Class Mastery Band</p>
                    <p class="text-3xl font-bold">${data.masteryBand.band}</p>
                    <p class="mt-1">${data.masteryBand.summary}</p>
                    <p class="text-xs mt-2">Approximate Average Score: ${data.masteryBand.score}</p> 
                </div>
                <div class="p-4 rounded-xl bg-gray-100 border-l-4 border-gray-400 md:col-span-2">
                    <p class="text-sm font-medium text-gray-700">Standard Analyzed</p>
                    <p class="text-lg font-bold">${standardCode}</p>
                    <p class="text-xs mt-1 text-gray-600">Grade ${DOMElements['grade-select'].value} - Subject ${DOMElements['subject-select'].value}</p>
                </div>
            `;

            DOMElements['ai-insights'].innerHTML = `
                <div class="p-5 border border-gray-200 rounded-xl">
                    <h4 class="text-lg font-bold text-gray-800 mb-2">General Pedagogical Findings</h4>
                    <p class="text-gray-700">${data.generalInsights}</p>
                </div>
                <div class="p-5 border border-gray-200 rounded-xl">
                    <h4 class="text-lg font-bold text-gray-800 mb-2">Specific Class Deficits (Fuzzy Concepts/Variations)</h4>
                    <p class="text-gray-700">${data.classFindings}</p>
                </div>
                <div class="p-5 border border-gray-200 rounded-xl">
                    <h4 class="text-lg font-bold text-gray-800 mb-2">Actionable Remediation Recommendations</h4>
                    <p class="text-gray-700">${data.pedagogicalRecommendations}</p>
                </div>
                <div class="p-5 border border-gray-200 rounded-xl">
                    <h4 class="text-lg font-bold text-red-700 mb-2">Individual Intervention Flags</h4>
                    <p class="text-red-700">${data.individualFlags}</p>
                </div>
            `;
        }
        
        // --- 6. APP CONTROLLER (From app.js) ---
        
        // This is the main controller that connects all the pieces.
        
        function initializeApp() {
            // FIX: Cache elements FIRST
            cacheDOMElements(); 
            
            // Attach all event listeners
            DOMElements['tab-content'].addEventListener('click', () => switchTab('content'));
            DOMElements['tab-data'].addEventListener('click', () => switchTab('data'));
            DOMElements['subject-select'].addEventListener('change', () => populateStandardDropdown(loadedStandardsData, DOMElements['subject-select'].value));
            DOMElements['standards-file'].addEventListener('change', handleFileUpload);
            DOMElements['generate-button'].addEventListener('click', handleGenerateContent);
            DOMElements['analyze-button'].addEventListener('click', handleAnalyzeData);
            DOMElements['login-button'].addEventListener('click', onLoginClick);
            DOMElements['sign-out-button'].addEventListener('click', onSignOutClick);

            // Start Firebase Auth
            initializeAuth(); 
            setupAuthStateListener(onAuthSuccess, onAuthFailure);
        }

        async function onLoginClick() {
            try {
                DOMElements['login-status'].textContent = "Opening Google Sign-in...";
                await handleGoogleSignIn();
                // onAuthStateChanged will handle success
            } catch (error) {
                console.error("Google Sign-In Error:", error);
                DOMElements['login-status'].textContent = `Sign-in failed: ${error.message}`;
            }
        }

        async function onSignOutClick() {
            try {
                await handleSignOut();
                // onAuthStateChanged will handle failure
            } catch (error) {
                console.error("Sign Out Error:", error);
            }
        }

        function onAuthSuccess(user) {
            firebaseReady = true;
            currentUserId = user.uid;
            
            DOMElements['login-container'].style.display = 'none';
            DOMElements['app-container'].style.display = 'block';
            DOMElements['user-welcome'].textContent = `Welcome, ${user.displayName || 'User'}!`;
            
            DOMElements['generate-button'].disabled = false;
            DOMElements['analyze-button'].disabled = false;
            DOMElements['generate-button'].textContent = 'Generate Differentiated Content';
            DOMElements['analyze-button'].textContent = 'Analyze Data & Generate Report';

            loadedStandardsData = initialStandardsImport;
            setupStandardsListener(currentUserId, onStandardsUpdate);
            populateSubjectDropdown(loadedStandardsData);
            populateStandardDropdown(loadedStandardsData, DOMElements['subject-select'].value);
        }

        function onAuthFailure() {
            firebaseReady = false;
            currentUserId = null;
            DOMElements['login-container'].style.display = 'block';
            DOMElements['app-container'].style.display = 'none';
        }

        function onStandardsUpdate(data) {
            if (data) {
                loadedStandardsData = data;
                DOMElements['file-status'].textContent = `Custom standards loaded successfully.`;
                DOMElements['file-status'].classList.replace('text-red-500', 'text-green-600');
            } else {
                loadedStandardsData = initialStandardsImport;
                DOMElements['file-status'].textContent = 'Using embedded standards data. Upload a file to save custom data.';
                DOMElements['file-status'].classList.replace('text-red-500', 'text-gray-500'); 
            }
            populateSubjectDropdown(loadedStandardsData);
            populateStandardDropdown(loadedStandardsData, DOMElements['subject-select'].value);
        }

        function handleFileUpload(e) {
            const file = e.target.files[0];
            if (!file || !firebaseReady) return;
            const reader = new FileReader();
            reader.onload = (e_load) => {
                try {
                    const jsonData = JSON.parse(e_load.target.result);
                    if (typeof jsonData !== 'object' || Array.isArray(jsonData)) {
                         throw new Error("Invalid JSON structure. Must be an object of subjects.");
                    }
                    saveStandardsToFirestore(currentUserId, jsonData);
                } catch (error) {
                    DOMElements['file-status'].textContent = `File Error: ${error.message}`;
                }
            };
            reader.readAsText(file);
        }

        async function fetchWithRetries(payload, maxRetries = 3) {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        const errorBody = await response.text();
                        throw new Error(`API error! Status: ${response.status}. Body: ${errorBody}`);
                    }
                    
                    return response.json(); 

                } catch (error) {
                    if (i === maxRetries - 1) {
                        throw new Error(`API failed after ${maxRetries} attempts: ${error.message}`);
                    }
                    const delay = Math.pow(2, i) * 1000 + Math.random() * 500;
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
        }

        function getInputs() {
            return {
                standardCode: DOMElements['standard-select'].value,
                subject: DOMElements['subject-select'].value,
                gradeLevel: DOMElements['grade-select'].value,
                format: DOMElements['format-select'].value,
                level: DOMElements['level-select'].value,
                count: parseInt(DOMElements['question-count'].value),
                rawData: DOMElements['raw-data-input'].value.trim()
            };
        }

        function getFullStandardText(standardCode, subject) { 
            const standards = loadedStandardsData[subject];
            if (!standards) {
                return `Standard text not found for ${standardCode}. Generating based on code only.`;
            }
            
            // FIX: Access the nested .standards array
            const standardsList = standards.standards || [];
            const standard = standardsList.find(s => s.code === standardCode);
            
            if (!standard) {
                return `Standard text not found for ${standardCode}. Generating based on code only.`;
            }
            
            if (standard.full_text) return standard.full_text;
            
            let fullText = standard.name || standard.desc; 
            
            if (standard.internal?.clarifications) {
                fullText += " | CLARIFICATIONS: " + standard.internal.clarifications.join('; ');
            }
            if (standard.internal?.objectives) {
                fullText += " | OBJECTIVES: " + standard.internal.objectives.join('; ');
            }
            return fullText;
        }

        async function handleGenerateContent() {
            if (!firebaseReady) { setErrorMessage('ERROR: Secure session not active.'); return; }
            
            const { standardCode, subject, gradeLevel, format, level, count } = getInputs();
            if (!standardCode) { setErrorMessage('Please select a standard code.'); return; }

            setLoadingState(true, 'Generating... (Step 1 of 2: Story)');
            DOMElements['output-card'].classList.remove('hidden');
            DOMElements['story-content'].style.display = 'block';
            DOMElements['assignment-output'].style.display = 'block';
            DOMElements['analysis-output'].style.display = 'none';

            try {
                const fullStandardText = getFullStandardText(standardCode, subject);
                
                const storyInstructions = getStoryPrompt(standardCode, level, gradeLevel, fullStandardText); 
                let storyPayload = {
                    contents: [{ parts: [{ text: storyInstructions.user }] }],
                    systemInstruction: { parts: [{ text: storyInstructions.system }] }
                };

                let result = await fetchWithRetries(storyPayload);
                let storyText = result.candidates?.[0]?.content?.parts?.[0]?.text || "Error: Could not generate narrative context.";
                renderStory(storyText, level);

                setLoadingState(true, 'Generating... (Step 2 of 2: Assignment)');

                const { payload } = getPayloadAndSchema(standardCode, format, level, count, gradeLevel, fullStandardText); 

                result = await fetchWithRetries(payload);
                const jsonString = result.candidates?.[0]?.content?.parts?.[0]?.text;

                if (!jsonString) {
                    throw new Error("Model failed to return structured JSON for the assignment.");
                }

                const assignmentData = JSON.parse(jsonString);
                renderAssignment(assignmentData, format);

            } catch (error) {
                console.error("Gemini API Error:", error);
                setErrorMessage(`Error generating content: ${error.message}.`);
            } finally {
                setLoadingState(false);
            }
        }

        async function handleAnalyzeData() {
            if (!firebaseReady) { setErrorMessage('ERROR: Secure session not active.'); return; }
            
            const { standardCode, gradeLevel, rawData, subject } = getInputs();
            if (!standardCode || !rawData) {
                setErrorMessage('Please select a standard code AND paste raw performance data.');
                return;
            }
            
            setLoadingState(true, 'Analyzing Data...');
            DOMElements['output-card'].classList.remove('hidden');
            DOMElements['story-content'].style.display = 'none';
            DOMElements['assignment-output'].style.display = 'none';
            DOMElements['analysis-output'].style.display = 'block';

            try {
                const fullStandardText = getFullStandardText(standardCode, subject);
                const { user, system, schema } = getAnalysisPrompt(standardCode, gradeLevel, fullStandardText, rawData);

                const analysisPayload = {
                    contents: [{ parts: [{ text: user }] }],
                    systemInstruction: { parts: [{ text: system }] },
                    generationConfig: {
                        responseMimeType: "application/json",
                        responseSchema: schema
                    }
                };

                const result = await fetchWithRetries(analysisPayload);
                const jsonString = result.candidates?.[0]?.content?.parts?.[0]?.text;

                if (!jsonString) {
                    throw new Error("Model failed to return structured JSON for the analysis.");
                }

                const analysisData = JSON.parse(jsonString);
                renderAnalysisReport(analysisData, standardCode);

            } catch (error) {
                console.error("Gemini API Error (Analysis):", error);
                setErrorMessage(`Error during analysis: ${error.message}.`);
            } finally {
                setLoadingState(false);
            }
        }

        // --- APP ENTRY POINT (From main.js) ---
        // This listener ensures the HTML is loaded before we try to find elements
        document.addEventListener('DOMContentLoaded', () => {
            initializeApp();
        });

    </script>
</body>
</html>
```

---

### 2. `netlify.toml`
*(This file tells Netlify how to deploy. It is correct.)*

```toml
[build]
  # We still have no build command for the main site
  command = ""
  # We still publish the root directory where index.html is
  publish = "."

[functions]
  # Tell Netlify to look for serverless functions in this directory
  directory = "netlify/functions/"
